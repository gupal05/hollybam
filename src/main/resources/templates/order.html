<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ï£ºÎ¨∏ Í≤∞Ï†ú - ÌôÄÎ¶¨Î∞§</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kit.fontawesome.com/69077b3f9d.js" crossorigin="anonymous"></script>
    <link th:href="@{/css/header.css}" rel="stylesheet"/>
    <link th:href="@{/css/footer.css}" rel="stylesheet"/>

    <script type="text/javascript" th:src="@{/js/header.js}"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <script src="https://api.payster.co.kr/js/pgAsistant.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            line-height: 1.6;
            color: #333;
            padding-top: 80px;
        }

        .main-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: calc(100vh - 200px);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 40px;
            text-align: center;
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: #EE386D;
            border-radius: 2px;
        }

        /* Ï≤¥ÌÅ¨ÏïÑÏõÉ Î†àÏù¥ÏïÑÏõÉ */
        .checkout-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 60px;
            align-items: start;
        }

        /* ÏôºÏ™Ω Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ */
        .order-form {
            background: #ffffff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f8f9fa;
            position: relative;
        }

        .section-title::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 30px;
            height: 2px;
            background: #EE386D;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: '*';
            color: #EE386D;
            margin-left: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #EE386D;
            box-shadow: 0 0 0 3px rgba(238, 56, 109, 0.1);
        }

        .form-input.error, .form-select.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .form-input:disabled, .form-select:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-input.readonly-field {
            background-color: #f8f9fa;
            color: #495057;
            border-color: #ced4da;
            cursor: default;
        }

        .btn-search.disabled-button {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-search.disabled-button:hover {
            background-color: #6c757d;
            transform: none;
        }

        .form-input::placeholder {
            color: #999;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-input {
            flex: 1;
        }

        .btn-search, .btn-apply {
            background: #EE386D;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-search:hover, .btn-apply:hover {
            background: #d63060;
            transform: translateY(-1px);
        }

        .btn-apply:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .form-select.disabled-coupon {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .form-input.disabled-input {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #e9ecef;
        }

        .btn-apply.disabled-button {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-apply.disabled-button:hover {
            background: #6c757d;
            transform: none;
        }

        /* Î°úÎî© ÏÉÅÌÉú Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .btn-apply.loading {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            pointer-events: none;
        }

        .btn-apply.loading .btn-text {
            display: none;
        }

        .btn-apply.loading .btn-loading {
            display: inline-block;
        }

        .btn-loading {
            display: none;
        }

        /* Ïø†Ìè∞ Î∞è Ìï†Ïù∏ ÏΩîÎìú ÏÑπÏÖò */
        .discount-section {
            border: 2px dashed #EE386D;
            border-radius: 16px;
            padding: 24px;
            background: linear-gradient(135deg, #fff8fa 0%, #fff 100%);
            margin-bottom: 20px;
        }

        .discount-section .section-title {
            border-bottom: none;
            margin-bottom: 20px;
            color: #EE386D;
        }

        .discount-section .section-title::before {
            display: none;
        }

        .discount-section .section-title::after {
            content: 'üí∏';
            margin-left: 8px;
        }

        .discount-notice {
            font-size: 12px;
            color: #666;
            background: rgba(238, 56, 109, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(238, 56, 109, 0.2);
            white-space: nowrap;
        }

        .coupon-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .coupon-info.active {
            color: #EE386D;
            font-weight: 500;
        }

        .discount-code-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .discount-code-group .form-input {
            flex: 1;
        }

        .discount-applied {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .discount-applied .remove-discount {
            background: none;
            border: none;
            color: #0369a1;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .discount-applied .remove-discount:hover {
            background: rgba(3, 105, 161, 0.1);
        }

        /* ÏóêÎü¨ Î©îÏãúÏßÄ Ïä§ÌÉÄÏùº */
        .error-message {
            background: #fff2f2;
            border: 1px solid #ffcccc;
            color: #d63060;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .field-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        /* ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Í≤∞Ï†ú Î≤ÑÌäº Î°úÎî© ÏÉÅÌÉú */
        .checkout-button.processing {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .checkout-button.processing:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Ï≤¥ÌÅ¨Î∞ïÏä§ Ïä§ÌÉÄÏùº */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-input {
            width: 18px;
            height: 18px;
            accent-color: #EE386D;
        }

        .checkbox-label {
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        /* Í≤∞Ï†ú Î∞©Î≤ï */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
        }

        .payment-method:hover {
            border-color: #EE386D;
            background: #fff8fa;
        }

        .payment-method.active {
            border-color: #EE386D;
            background: #fff8fa;
        }

        .payment-method input[type="radio"] {
            margin-right: 10px;
            accent-color: #EE386D;
        }

        .payment-method label {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Ïò§Î•∏Ï™Ω Ï£ºÎ¨∏ Ï†ïÎ≥¥ (sticky) */
        .order-summary {
            position: sticky;
            top: 120px;
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            text-align: center;
        }

        .product-item {
            display: flex;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            background: #f8f9fa;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .product-options {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .product-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-quantity {
            font-size: 12px;
            color: #666;
        }

        .product-amount {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        /* Í∞ÄÍ≤© Ï†ïÎ≥¥ */
        .price-breakdown {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .price-row:last-child {
            margin-bottom: 0;
        }

        .price-label {
            font-size: 14px;
            color: #666;
        }

        .price-value {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .price-value.discount {
            color: #EE386D;
        }

        .total-row {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .total-row .price-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .total-row .price-value {
            font-size: 18px;
            font-weight: 700;
            color: #EE386D;
        }

        /* Í≤∞Ï†ú Î≤ÑÌäº */
        .checkout-button {
            width: 100%;
            background: linear-gradient(135deg, #EE386D 0%, #d63060 100%) !important;
            color: white !important;
            border: none !important;
            padding: 18px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer !important;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(238, 56, 109, 0.3) !important;
            pointer-events: auto !important;
        }

        .checkout-button:hover:not(:disabled):not(.processing):not(.disabled) {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(238, 56, 109, 0.4) !important;
        }

        .checkout-button:active:not(:disabled):not(.processing):not(.disabled) {
            transform: translateY(0) !important;
        }

        .checkout-button:disabled,
        .checkout-button.disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
            color: white !important;
            pointer-events: auto !important;
        }

        .checkout-button.processing {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
            color: white !important;
            pointer-events: none !important;
        }

        /* Í∞ïÏ†ú Î≥µÏõêÏö© Ïä§ÌÉÄÏùº */
        .checkout-button.force-active {
            background: linear-gradient(135deg, #EE386D 0%, #d63060 100%) !important;
            color: white !important;
            cursor: pointer !important;
            transform: none !important;
            box-shadow: 0 4px 12px rgba(238, 56, 109, 0.3) !important;
            pointer-events: auto !important;
        }

        #discountCode {
            text-transform: uppercase !important;
        }

        /* üÜï Ï†ÅÎ¶ΩÍ∏à ÏÑπÏÖò Ïä§ÌÉÄÏùº - Í∏∞Ï°¥ CSS ÎßàÏßÄÎßâÏóê Ï∂îÍ∞Ä */
        .points-section {
            border: 2px dashed #ff6b35;
            border-radius: 16px;
            padding: 24px;
            background: linear-gradient(135deg, #fff9f5 0%, #fff 100%);
            margin-bottom: 20px;
        }

        .points-section .section-title {
            border-bottom: none;
            margin-bottom: 20px;
            color: #ff6b35;
        }

        .points-section .section-title::before {
            display: none;
        }

        .points-section .section-title::after {
            content: 'ü™ô';
            margin-left: 8px;
        }

        .points-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .balance-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .balance-label {
            font-size: 14px;
            color: #666;
        }

        .balance-amount {
            font-size: 18px;
            font-weight: 600;
            color: #ff6b35;
        }

        .btn-all-use {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-all-use:hover {
            background: #e55a2b;
            transform: translateY(-1px);
        }

        .points-input-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .points-input {
            width: 100%;
            padding: 14px 40px 14px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            text-align: right;
            transition: all 0.3s ease;
        }

        .points-input:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .currency {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 14px;
        }

        .points-result {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .result-row:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-size: 14px;
            color: #666;
        }

        .result-value {
            font-weight: 600;
        }

        .use-amount {
            color: #dc3545;
        }

        .remain-amount {
            color: #28a745;
        }

        .points-reward {
            text-align: center;
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }

        .reward-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #856404;
        }

        .reward-info i {
            color: #ffc107;
        }

        .reward-amount {
            font-weight: 600;
            color: #ff6b35;
        }

        /* Ï£ºÎ¨∏ ÏöîÏïΩ Ï†ÅÎ¶ΩÍ∏à Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .points-discount-row .price-label {
            color: #ff6b35;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .points-discount-row .price-label i {
            font-size: 12px;
        }

        .points-discount {
            color: #ff6b35 !important;
            font-weight: 600;
        }

        .reward-info-summary {
            margin-top: 15px;
            padding: 10px;
            background: #fff9e6;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            color: #856404;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reward-info-summary i {
            color: #ffc107;
            font-size: 14px;
        }

        .reward-info-summary strong {
            color: #ff6b35;
            font-weight: 600;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 1024px) {
            .checkout-layout {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .order-summary {
                position: static;
                order: -1;
            }

            .main-container {
                padding: 30px 20px;
            }

            .order-form {
                padding: 30px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px 16px;
            }

            .order-form {
                padding: 24px;
                border-radius: 16px;
            }

            .order-summary {
                padding: 24px;
                border-radius: 16px;
            }

            .payment-methods {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 24px;
                margin-bottom: 30px;
            }

            .discount-code-group {
                flex-direction: column;
            }

            .discount-code-group .btn-apply {
                width: 100%;
            }

            .discount-notice {
                font-size: 11px;
                padding: 3px 6px;
            }

            .discount-section > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }

            .discount-section .section-title {
                width: 100%;
            }

            /* üÜï Ï†ÅÎ¶ΩÍ∏à Î™®Î∞îÏùº Î∞òÏùëÌòï Ï∂îÍ∞Ä */
            .points-balance {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .points-input-group {
                flex-direction: column;
            }

            .points-input-group .btn-apply {
                width: 100%;
            }

            .reward-info {
                flex-direction: column;
                gap: 5px;
            }

            .reward-info-summary {
                flex-direction: column;
                gap: 5px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .input-group {
                flex-direction: column;
            }

            .btn-search {
                width: 100%;
            }

            .product-item {
                gap: 12px;
            }

            .product-image {
                width: 60px;
                height: 60px;
            }
        }

        /* üÜï Ïù∏ÎùºÏù∏ Î©îÏãúÏßÄ ÏãúÏä§ÌÖú - Í∏∞Ï°¥ style ÌÉúÍ∑∏ Îß® ÏïÑÎûòÏóê Ï∂îÍ∞Ä */
        .inline-message {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            animation: slideInDown 0.3s ease-out;
            position: relative;
        }

        .inline-message.show { display: block; }

        .inline-message.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            border-left: 4px solid #ff4757;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .inline-message.success {
            background: linear-gradient(135deg, #26d0ce, #1dd1a1);
            color: white;
            border-left: 4px solid #00d2d3;
            box-shadow: 0 2px 8px rgba(38, 208, 206, 0.3);
        }

        .inline-message.warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
            border-left: 4px solid #f57c00;
            box-shadow: 0 2px 8px rgba(255, 167, 38, 0.3);
        }

        .inline-message.info {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            color: white;
            border-left: 4px solid #1976d2;
            box-shadow: 0 2px 8px rgba(66, 165, 245, 0.3);
        }

        .inline-message::before {
            margin-right: 8px;
            font-size: 16px;
        }

        .inline-message.error::before { content: '‚ö†Ô∏è'; }
        .inline-message.success::before { content: '‚úÖ'; }
        .inline-message.warning::before { content: '‚ö†Ô∏è'; }
        .inline-message.info::before { content: '‚ÑπÔ∏è'; }

        .inline-message .close-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .inline-message .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<!-- Í≥†Ï†ï Ìó§Îçî -->
<div th:replace="~{layout/header :: header}"></div>

<!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
<div class="main-container">
    <h1 class="page-title">Ï£ºÎ¨∏ Í≤∞Ï†ú</h1>

    <!-- ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú -->
    <div th:if="${error}" class="error-message" th:text="${error}"></div>

    <div class="checkout-layout">
        <!-- ÏôºÏ™Ω: Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ -->
        <form id="paymentForm" class="order-form">
            <!-- Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ -->
            <div class="form-section">
                <h2 class="section-title">Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h2>
                <div class="form-group">
                    <label class="form-label required">Ïù¥Î¶Ñ</label>
                    <input type="text" id="ordererName" class="form-input" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                           th:value="${member?.memberName ?: (guest?.guestName ?: '')}" required>
                    <div class="field-error" id="ordererName-error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Ìú¥ÎåÄÌè∞ Î≤àÌò∏</label>
                    <input type="tel" id="ordererPhone" class="form-input" placeholder="Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (010-1234-5678)"
                           th:value="${member?.memberPhone ?: (guest?.guestPhone ?: '')}" required>
                    <div class="field-error" id="ordererPhone-error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Ïù¥Î©îÏùº</label>
                    <input type="email" id="ordererEmail" class="form-input" placeholder="Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                           th:value="${member?.memberMail ?: ''}" required>
                    <div class="field-error" id="ordererEmail-error"></div>
                </div>
            </div>

            <!-- Ïø†Ìè∞ Î∞è Ìï†Ïù∏ ÏΩîÎìú ÏÑπÏÖò -->
            <div class="form-section" th:if="${session.member != null}">
                <div class="discount-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin-bottom: 0;">Ïø†Ìè∞ & Ìï†Ïù∏ÏΩîÎìú</h2>
                        <span class="discount-notice">Ïø†Ìè∞Í≥º Ìï†Ïù∏ÏΩîÎìúÎäî Ï§ëÎ≥µ ÏÇ¨Ïö© Î∂àÍ∞Ä</span>
                    </div>

                    <!-- Ïø†Ìè∞ ÏÑ†ÌÉù -->
                    <div class="form-group">
                        <label class="form-label">Î≥¥Ïú† Ïø†Ìè∞</label>
                        <select id="couponSelect" class="form-select" th:disabled="${#lists.isEmpty(couponList)}">
                            <option value="" th:if="${!#lists.isEmpty(couponList)}">Ïø†Ìè∞ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                            <option value="" th:if="${#lists.isEmpty(couponList)}" disabled>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞Ïù¥ ÏóÜÏäµÎãàÎã§</option>

                            <!-- DBÏóêÏÑú Í∞ÄÏ†∏Ïò® Ïø†Ìè∞ Î¶¨Ïä§Ìä∏ ÌëúÏãú -->
                            <option th:each="coupon : ${couponList}"
                                    th:value="${coupon.couponCode}"
                                    th:data-type="${coupon.discountType}"
                                    th:data-value="${coupon.discountValue}"
                                    th:data-min-amount="${coupon.minOrderPrice}"
                                    th:data-coupon-id="${coupon.couponId}"
                                    th:text="${coupon.couponName} + ' (' + ${#numbers.formatInteger(coupon.minOrderPrice, 0, 'COMMA')} + 'Ïõê Ïù¥ÏÉÅ)'">
                            </option>
                        </select>
                        <div class="coupon-info" id="couponInfo">
                            <i class="fas fa-info-circle"></i>
                            <span th:if="${!#lists.isEmpty(couponList)}">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ìï†Ïù∏Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§</span>
                            <span th:if="${#lists.isEmpty(couponList)}" style="color: #999;">ÌòÑÏû¨ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞Ïù¥ ÏóÜÏäµÎãàÎã§</span>
                        </div>
                        <div id="couponMessage" class="inline-message">
                            <span class="message-text">Î©îÏãúÏßÄ</span>
                            <button class="close-btn" onclick="hideCouponMessage()">&times;</button>
                        </div>
                    </div>

                    <!-- Ìï†Ïù∏ ÏΩîÎìú ÏûÖÎ†• -->
                    <div class="form-group">
                        <label class="form-label">Ìï†Ïù∏ÏΩîÎìú</label>
                        <div class="discount-code-group">
                            <input type="text" id="discountCode" class="form-input" placeholder="Ìï†Ïù∏ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" maxlength="20">
                            <button type="button" class="btn-apply" id="applyDiscountCode">
                                <span class="btn-text">Ï†ÅÏö©</span>
                                <span class="btn-loading">
                                    <i class="fas fa-spinner fa-spin"></i> ÌôïÏù∏Ï§ë
                                </span>
                            </button>
                        </div>
                        <div class="coupon-info">
                            <i class="fas fa-gift"></i>
                            <span>Ìï†Ïù∏ÏΩîÎìúÎäî ÎåÄÏÜåÎ¨∏ÏûêÎ•º Íµ¨Î∂ÑÌï©ÎãàÎã§</span>
                        </div>
                        <div id="discountCodeMessage" class="inline-message">
                            <span class="message-text">Î©îÏãúÏßÄ</span>
                            <button class="close-btn" onclick="hideDiscountCodeMessage()">&times;</button>
                        </div>
                    </div>

                    <!-- Ï†ÅÏö©Îêú Ìï†Ïù∏ ÌëúÏãú -->
                    <div id="appliedDiscount" class="discount-applied" style="display: none;">
                        <div>
                            <i class="fas fa-check-circle"></i>
                            <span id="discountText">Ìï†Ïù∏Ïù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§</span>
                        </div>
                        <button type="button" class="remove-discount" onclick="removeDiscount()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- üÜï Ï†ÅÎ¶ΩÍ∏à ÏÑπÏÖò (ÌöåÏõêÎßå ÌëúÏãú) - Ìï†Ïù∏/Ïø†Ìè∞ ÏÑπÏÖò Îã§ÏùåÏóê Ï∂îÍ∞Ä -->
            <div class="form-section" th:if="${session.member != null}">
                <div class="points-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin-bottom: 0;">Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö©</h2>
                        <span class="discount-notice">Ìï†Ïù∏Í≥º Ï†ÅÎ¶ΩÍ∏àÏùÄ Ï§ëÎ≥µ ÏÇ¨Ïö© Í∞ÄÎä•</span>
                    </div>

                    <div class="points-content">
                        <!-- Î≥¥Ïú† Ï†ÅÎ¶ΩÍ∏à ÌëúÏãú -->
                        <div class="points-balance">
                            <div class="balance-info">
                                <span class="balance-label">Î≥¥Ïú† Ï†ÅÎ¶ΩÍ∏à</span>
                                <span class="balance-amount" id="currentPoints">0Ïõê</span>
                            </div>
                            <button type="button" class="btn-all-use" id="useAllPointsBtn">
                                Ï†ÑÏï° ÏÇ¨Ïö©
                            </button>
                        </div>

                        <!-- Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö© ÏûÖÎ†• -->
                        <div class="points-input-group">
                            <div class="input-wrapper">
                                <input type="number"
                                       id="usePointsInput"
                                       name="usePoints"
                                       value="0"
                                       min="0"
                                       max="0"
                                       placeholder="ÏÇ¨Ïö©Ìï† Ï†ÅÎ¶ΩÍ∏à ÏûÖÎ†•"
                                       class="points-input">
                                <span class="currency">Ïõê</span>
                            </div>
                            <button type="button" class="btn-apply" id="applyPointsBtn">
                                Ï†ÅÏö©
                            </button>
                        </div>

                        <!-- Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö© ÌõÑ ÏûîÏï° -->
                        <div class="points-result" id="pointsResult" style="display: none;">
                            <div class="result-row">
                                <span class="result-label">ÏÇ¨Ïö© Ï†ÅÎ¶ΩÍ∏à</span>
                                <span class="result-value use-amount" id="useAmount">0Ïõê</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">ÏÇ¨Ïö© ÌõÑ ÏûîÏï°</span>
                                <span class="result-value remain-amount" id="remainAmount">0Ïõê</span>
                            </div>
                        </div>

                        <!-- Ï†ÅÎ¶Ω ÏòàÏ†ï Í∏àÏï° -->
                        <div class="points-reward">
                            <div class="reward-info">
                                <i class="fas fa-gift"></i>
                                <span class="reward-text">Ïù¥Î≤à Íµ¨Îß§ Ïãú Ï†ÅÎ¶Ω ÏòàÏ†ï</span>
                                <span class="reward-amount" id="rewardAmount">0Ïõê (1.5%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Î∞∞ÏÜ° Ï†ïÎ≥¥ -->
            <div class="form-section">
                <h2 class="section-title">Î∞∞ÏÜ° Ï†ïÎ≥¥</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="same-info" class="checkbox-input"
                           th:checked="${member != null or guest != null}">
                    <label for="same-info" class="checkbox-label">Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ÏôÄ ÎèôÏùº</label>
                </div>
                <div class="form-group">
                    <label class="form-label required">Î∞õÎäî Î∂Ñ</label>
                    <input type="text" id="receiverName" class="form-input" placeholder="Î∞õÎäî Î∂Ñ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                           th:value="${member?.memberName ?: (guest?.guestName ?: '')}" required>
                    <div class="field-error" id="receiverName-error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Ìú¥ÎåÄÌè∞ Î≤àÌò∏</label>
                    <input type="tel" id="receiverPhone" class="form-input" placeholder="Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (010-1234-5678)"
                           th:value="${member?.memberPhone ?: (guest?.guestPhone ?: '')}" required>
                    <div class="field-error" id="receiverPhone-error"></div>
                </div>

                <!-- Ï£ºÏÜå ÏûÖÎ†• ÌïÑÎìúÎì§ -->
                <div class="address-fields" id="addressFields">
                    <div class="form-group">
                        <label class="form-label required">Ï£ºÏÜå</label>
                        <div class="input-group">
                            <input type="text" id="receiverZip" class="form-input" placeholder="Ïö∞Ìé∏Î≤àÌò∏"
                                   th:value="${member?.memberZip ?: ''}"
                                   th:data-member-zip="${member?.memberZip ?: ''}"
                                   required readonly>
                            <button type="button" class="btn-search" onclick="execDaumPostcode()">Ï£ºÏÜå Í≤ÄÏÉâ</button>
                        </div>
                        <input type="text" id="receiverAddr" class="form-input" placeholder="Í∏∞Î≥∏ Ï£ºÏÜå"
                               th:value="${member?.memberAddr ?: ''}"
                               th:data-member-addr="${member?.memberAddr ?: ''}"
                               style="margin-top: 10px;" required readonly>
                        <input type="text" id="receiverAddrDetail" class="form-input" placeholder="ÏÉÅÏÑ∏ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî"
                               style="margin-top: 10px;" required>
                        <div class="field-error" id="receiverAddr-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Î∞∞ÏÜ° ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                        <input type="text" id="deliveryRequest" class="form-input" placeholder="Î∞∞ÏÜ° Ïãú ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (ÏÑ†ÌÉù)">
                    </div>
                </div>
            </div>

            <!-- Í≤∞Ï†ú Î∞©Î≤ï -->
            <div class="form-section">
                <h2 class="section-title">Í≤∞Ï†ú Î∞©Î≤ï</h2>
                <div class="payment-methods">
                    <div class="payment-method active">
                        <input type="radio" id="card" name="payment" value="card" checked>
                        <label for="card">Ïã†Ïö©Ïπ¥Îìú</label>
                    </div>
                    <div class="payment-method">
                        <input type="radio" id="trans" name="payment" value="trans">
                        <label for="trans">Ïã§ÏãúÍ∞ÑÍ≥ÑÏ¢åÏù¥Ï≤¥</label>
                    </div>
                </div>
            </div>

            <!-- ÎèôÏùò ÏÇ¨Ìï≠ -->
            <div class="form-section">
                <h2 class="section-title">Ï£ºÎ¨∏ ÎèôÏùò</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree-all" class="checkbox-input">
                    <label for="agree-all" class="checkbox-label">Ï†ÑÏ≤¥ ÎèôÏùò</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree-terms" class="checkbox-input" required>
                    <label for="agree-terms" class="checkbox-label">Íµ¨Îß§Ï°∞Í±¥ Î∞è Í≤∞Ï†úÏßÑÌñâ ÎèôÏùò (ÌïÑÏàò)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree-privacy" class="checkbox-input" required>
                    <label for="agree-privacy" class="checkbox-label">Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© ÎèôÏùò (ÌïÑÏàò)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree-adult" class="checkbox-input" required>
                    <label for="agree-adult" class="checkbox-label">ÏÑ±Ïù∏Ïö©Ìíà Íµ¨Îß§ ÎèôÏùò Î∞è ÏÑ±Ïù∏Ïù∏Ï¶ù ÌôïÏù∏ (ÌïÑÏàò)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree-marketing" class="checkbox-input">
                    <label for="agree-marketing" class="checkbox-label">ÎßàÏºÄÌåÖ Ï†ïÎ≥¥ ÏàòÏã† ÎèôÏùò (ÏÑ†ÌÉù)</label>
                </div>
            </div>
        </form>

        <!-- Ïò§Î•∏Ï™Ω: Ï£ºÎ¨∏ ÏÉÅÌíà Ï†ïÎ≥¥ -->
        <div class="order-summary">
            <h2 class="summary-title">Ï£ºÎ¨∏ ÏÉÅÌíà</h2>

            <!-- ÏÉÅÌíà Î™©Î°ù (ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î°ú ÌëúÏãú) -->
            <div id="productList">
                <!-- ThymeleafÎ°ú ÏÉÅÌíà Î™©Î°ù ÌëúÏãú -->
                <div th:each="item : ${cartItems}" class="product-item">
                    <img th:src="${item.imageDto?.imageUrl != null ?
                            'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/product/' + item.imageDto.imageUrl :
                            'https://via.placeholder.com/80x80/f0f0f0/999?text=Product'}"
                         class="product-image"
                         alt="ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ" />
                    <div class="product-info">
                        <div class="product-name" th:text="${item.productDto.productName}">ÏÉÅÌíàÎ™Ö</div>
                        <div class="product-options" th:if="${item.productOptionDto != null}">
                            <span th:text="${item.productOptionDto.optionName}">ÏòµÏÖòÎ™Ö</span>:
                            <span th:text="${item.productOptionDto.optionValue}">ÏòµÏÖòÍ∞í</span>
                        </div>
                        <div class="product-price">
                            <span class="product-quantity" th:text="'ÏàòÎüâ ' + ${item.quantity} + 'Í∞ú'">ÏàòÎüâ 1Í∞ú</span>
                            <span class="product-amount" th:text="'‚Ç©' + ${#numbers.formatInteger((item.priceDto.priceSelling + (item.productOptionDto != null ? item.productOptionDto.optionPrice : 0)) * item.quantity, 0, 'COMMA')}">‚Ç©150,000</span>
                        </div>
                    </div>
                </div>

                <!-- ÏÉÅÌíàÏù¥ ÏóÜÏùÑ Îïå ÌëúÏãú -->
                <div th:if="${#lists.isEmpty(cartItems)}" class="product-item">
                    <div class="product-info" style="text-align: center; width: 100%;">
                        <div class="product-name">Ï£ºÎ¨∏Ìï† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                    </div>
                </div>
            </div>

            <div class="price-breakdown">
                <div class="price-row">
                    <span class="price-label">ÏÉÅÌíà Í∏àÏï°</span>
                    <span class="price-value" id="originalAmount" th:text="'‚Ç©' + ${#numbers.formatInteger(paymentInfo.totalAmount, 0, 'COMMA')}">‚Ç©0</span>
                </div>
                <div class="price-row" id="discountRow" style="display: none;">
                    <span class="price-label" id="discountLabel">Ìï†Ïù∏</span>
                    <span class="price-value discount" id="discountAmount">-‚Ç©0</span>
                </div>
                <!-- üÜï Ï†ÅÎ¶ΩÍ∏à Ìï†Ïù∏ Ìï≠Î™© - Í∏∞Ï°¥ Ìï†Ïù∏ Ìï≠Î™© Îã§ÏùåÏóê Ï∂îÍ∞Ä -->
                <div class="price-row points-discount-row" style="display: none;">
                    <span class="price-label">
                        <i class="fas fa-coins"></i>
                        Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö©
                    </span>
                    <span class="price-value points-discount" id="pointsDiscountAmount">-‚Ç©0</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Í∏∞Î≥∏ Ìï†Ïù∏</span>
                    <span class="price-value" th:text="'-‚Ç©' + ${#numbers.formatInteger(paymentInfo.discountAmount, 0, 'COMMA')}">‚Ç©0</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Î∞∞ÏÜ°ÎπÑ</span>
                    <span class="price-value" th:text="${paymentInfo.deliveryFee == 0} ? 'Î¨¥Î£å' : '‚Ç©' + ${#numbers.formatInteger(paymentInfo.deliveryFee, 0, 'COMMA')}">‚Ç©0</span>
                </div>
                <div class="price-row total-row">
                    <span class="price-label">Ï¥ù Í≤∞Ï†ú Í∏àÏï°</span>
                    <span class="price-value" id="finalAmount" th:text="'‚Ç©' + ${#numbers.formatInteger(paymentInfo.finalAmount, 0, 'COMMA')}">‚Ç©0</span>
                </div>
                <!-- üÜï Ï†ÅÎ¶Ω ÏòàÏ†ï ÏïàÎÇ¥ - ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï° Îã§ÏùåÏóê Ï∂îÍ∞Ä -->
                <div class="reward-info-summary" th:if="${session.member != null}">
                    <i class="fas fa-gift"></i>
                    <span>Íµ¨Îß§ ÏôÑÎ£å Ïãú <strong id="summaryRewardAmount">0Ïõê</strong> Ï†ÅÎ¶Ω ÏòàÏ†ï</span>
                </div>
            </div>

            <button type="button" class="checkout-button" id="paymentButton">
                <i class="fas fa-lock" style="margin-right: 8px;"></i>
                <span id="paymentButtonText" th:text="'‚Ç©' + ${#numbers.formatInteger(paymentInfo.finalAmount, 0, 'COMMA')} + ' Í≤∞Ï†úÌïòÍ∏∞'">‚Ç©0 Í≤∞Ï†úÌïòÍ∏∞</span>
            </button>
        </div>
    </div>
</div>

<div style="display: none;">
    <form name="payInit"
          method="post"
          th:action="@{${returnUrl}}">

        <!-- 1) ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞ -->
        <input type="hidden" name="payMethod" value="card"/>
        <input type="hidden" name="mid" th:value="${mid}"/>
        <input type="hidden" name="trxCd" value="0"/>
        <input type="hidden" name="goodsNm" id="goodsNm"/>

        <!-- 2) Ï£ºÎ¨∏ Ï†ïÎ≥¥ -->
        <input type="hidden" name="ordNo" id="ordNo"/>
        <input type="hidden" name="ordNm" id="ordNm"/>
        <input type="hidden" name="ordTel" id="ordTel"/>
        <input type="hidden" name="ordEmail" id="ordEmail"/>

        <!-- 3) Í∏àÏï°¬∑ÎÇ†Ïßú¬∑Ìï¥Ïãú -->
        <input type="hidden" name="goodsAmt" id="goodsAmt"/>
        <input type="hidden" name="ediDate" id="ediDate"/>
        <input type="hidden" name="encData" id="encData"/>

        <!-- 4) ÌåùÏóÖ Ïä§ÌîºÎÑà Î∞©ÏßÄÏö© -->
        <input type="hidden" name="currencyType" value="KRW"/>
        <input type="hidden" name="channel" id="channel"/>
        <input type="hidden" name="charset" value="UTF-8"/>
        <input type="hidden" name="appMode" value="1"/>
        <input type="hidden" name="userIp" id="userIp"/>

        <!-- 5) PG ‚Üí ÎÇ¥ ÏÑúÎ≤Ñ ÏΩúÎ∞±Ïö© URL -->
        <input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
        <input type="hidden" name="notiUrl" th:value="${notiUrl}"/>

        <button type="button" onclick="SendPay(document.payInit)" id="payBtn">
            Í≤∞Ï†ú ÏöîÏ≤≠
        </button>
    </form>
</div>

<!-- Í≥†Ï†ï ÌíãÌÑ∞ -->
<div th:replace="~{layout/footer :: footer}"></div>

<!-- Îã§Ïùå Ïö∞Ìé∏Î≤àÌò∏ ÏÑúÎπÑÏä§ -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script th:inline="javascript">
    // ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞
    var isDirect = /*[[${isDirect}]]*/ false;
    const paymentInfo = /*[[${paymentInfo}]]*/ {};
    const cartCodes = /*[[${cartCodes}]]*/ [];
    const cartItems = /*[[${cartItems}]]*/ [];

    // ÌöåÏõê/ÎπÑÌöåÏõê Ï†ïÎ≥¥ (ÏàòÏ†ïÎêú Î≤ÑÏ†Ñ)
    const memberInfo = {
        memberZip: /*[[${member?.memberZip ?: ''}]]*/ '',
        memberAddr: /*[[${member?.memberAddr ?: ''}]]*/ ''
    };

    const guestInfo = {
        guestName: /*[[${guest?.guestName ?: ''}]]*/ '',
        guestPhone: /*[[${guest?.guestPhone ?: ''}]]*/ ''
    };

    const hasUserInfo = /*[[${member != null or guest != null}]]*/ false;

    // Ìï†Ïù∏ Í¥ÄÎ†® Î≥ÄÏàò (Îã®ÎèÖ ÏÇ¨Ïö©)
    let activeDiscount = null; // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Ìï†Ïù∏ (Ïø†Ìè∞ ÎòêÎäî Ìï†Ïù∏ÏΩîÎìú)
    let originalAmount = paymentInfo.totalAmount || 0;
    let currentTotalAmount = paymentInfo.finalAmount || 0;

    // üÜï Ï†ÅÎ¶ΩÍ∏à Í¥ÄÎ†® Î≥ÄÏàòÎì§ - Í∏∞Ï°¥ JavaScriptÏóê Ï∂îÍ∞Ä
    let currentUsePoints = 0;
    let currentPoints = 0;

    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ ÏÉÅÌÉú Ï∂îÏ†Å
    const validationState = {
        ordererName: false,
        ordererPhone: false,
        ordererEmail: false,
        receiverName: false,
        receiverPhone: false,
        receiverAddr: false,
        agreeTerms: false,
        agreePrivacy: false,
        agreeAdult: false
    };

    $(document).ready(function() {
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        setupEventListeners();

        // Ï¥àÍ∏∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        validateAllFields();

        // Ï¥àÍ∏∞ Ï£ºÏÜå ÌïÑÎìú ÏÉÅÌÉú ÏÑ§Ï†ï
        updateAddressFields();

        // üÜï Ï†ÅÎ¶ΩÍ∏à Ï¥àÍ∏∞Ìôî (ÌöåÏõêÏù∏ Í≤ΩÏö∞Îßå)
        if ($('#currentPoints').length > 0) {
            loadCurrentPoints();
        }

        // üÜï Ï¥àÍ∏∞ Ï†ÅÎ¶Ω ÏòàÏ†ï Í∏àÏï° Í≥ÑÏÇ∞
        updateRewardAmount();

        console.log("Payment Info:", paymentInfo);
        console.log("Cart Items:", cartItems);
    });

    // üÜï HTMLÏóê ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ÏïàÎÇ¥ Ï∂îÍ∞ÄÎ•º ÏúÑÌïú CSS
    const additionalCSS = `
.discount-limit-info {
    font-size: 12px;
    color: #666;
    background: rgba(238, 56, 109, 0.1);
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid rgba(238, 56, 109, 0.2);
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.discount-limit-info i {
    color: #EE386D;
}
`;

    // CSS Ï∂îÍ∞Ä
    const style = document.createElement('style');
    style.textContent = additionalCSS;
    document.head.appendChild(style);

    // üÜï Ï¥àÍ∏∞ Î°úÎìú Ïãú ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ÏïàÎÇ¥ ÌëúÏãú
    $(document).ready(function() {
        // Ìï†Ïù∏ ÏÑπÏÖòÏóê ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ÏïàÎÇ¥ Ï∂îÍ∞Ä
        if ($('.discount-section').length > 0) {
            $('.discount-section .form-section').first().after(`
            <div class="discount-limit-info">
                <i class="fas fa-info-circle"></i>
                <span>Ïø†Ìè∞ Î∞è Ìï†Ïù∏ÏΩîÎìú ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï°: ${MAX_DISCOUNT_AMOUNT.toLocaleString()}Ïõê</span>
            </div>
        `);
        }
    });

    // üÜï Ï†ÅÎ¶ΩÍ∏à Í¥ÄÎ†® Ìï®ÏàòÎì§ - Í∏∞Ï°¥ JavaScript ÎßàÏßÄÎßâÏóê Ï∂îÍ∞Ä
    function loadCurrentPoints() {
        $.ajax({
            url: '/order/api/points',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    currentPoints = response.currentPoints;
                    updatePointsDisplay();
                    updateRewardAmount();
                } else {
                    console.error('Ï†ÅÎ¶ΩÍ∏à Ï°∞Ìöå Ïã§Ìå®:', response.message);
                }
            },
            error: function() {
                console.error('Ï†ÅÎ¶ΩÍ∏à Ï°∞Ìöå Ï§ë Ïò§Î•ò Î∞úÏÉù');
            }
        });
    }

    function updatePointsDisplay() {
        $('#currentPoints').text(formatCurrency(currentPoints) + 'Ïõê');
        $('#usePointsInput').attr('max', currentPoints);

        if (currentPoints <= 0) {
            $('#usePointsInput').prop('disabled', true);
            $('#useAllPointsBtn').prop('disabled', true);
            $('#applyPointsBtn').prop('disabled', true);
        }
    }

    function updateRewardAmount() {
        const rewardPoints = Math.floor(originalAmount * 0.015);

        // 2) ÌôîÎ©¥Ïóê Ï∞çÏñ¥Ï£ºÍ∏∞ (Ï†ÅÎ¶Ω ÏòàÏÉÅ ÏòÅÏó≠Í≥º ÏöîÏïΩ ÏòÅÏó≠ Î™®Îëê)
        $('#rewardAmount').text(formatCurrency(rewardPoints) + 'Ïõê (1.5%)');
        $('#summaryRewardAmount').text(formatCurrency(rewardPoints) + 'Ïõê');
    }

    // ÏµúÏ¢Ö Í∏àÏï° Í≥ÑÏÇ∞ (Í∏∞Ï°¥ Ìï®ÏàòÎì§Í≥º Ïó∞Îèô)
    function calculateCurrentFinalAmount() {
        const baseAmount = originalAmount || 0;
        const discountAmount = activeDiscount ? activeDiscount.amount : 0;
        const deliveryFee = paymentInfo.deliveryFee || 0;

        return Math.max(0, baseAmount - discountAmount - currentUsePoints + deliveryFee);
    }

    // Ï†ÅÎ¶ΩÍ∏à Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    $('#useAllPointsBtn').click(function() {
        if (currentPoints > 0) {
            const totalAmount = originalAmount || 0;
            const maxUsable = Math.min(currentPoints, totalAmount);
            $('#usePointsInput').val(maxUsable);
            applyPoints();
        }
    });

    $('#applyPointsBtn').click(function() {
        applyPoints();
    });

    $('#usePointsInput').on('input', function() {
        const inputValue = parseInt($(this).val()) || 0;
        const totalAmount = originalAmount || 0;
        const maxUsable = Math.min(currentPoints, totalAmount);

        if (inputValue > maxUsable) {
            $(this).val(maxUsable);
        }

        if (inputValue < 0) {
            $(this).val(0);
        }
    });

    function applyPoints() {
        const inputPoints = parseInt($('#usePointsInput').val()) || 0;

        if (inputPoints <= 0) {
            resetPointsUsage();
            return;
        }

        if (inputPoints > currentPoints) {
            alert('Î≥¥Ïú† Ï†ÅÎ¶ΩÍ∏àÏùÑ Ï¥àÍ≥ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
            $('#usePointsInput').val(currentPoints);
            return;
        }

        const totalAmount = originalAmount || 0;
        if (inputPoints > totalAmount) {
            alert('Ï£ºÎ¨∏ Í∏àÏï°ÏùÑ Ï¥àÍ≥ºÌï¥ÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
            $('#usePointsInput').val(totalAmount);
            return;
        }

        // ÏÑúÎ≤Ñ Í≤ÄÏ¶ù
        $.ajax({
            url: '/order/api/points/validate',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ usePoints: inputPoints }),
            success: function(response) {
                if (response.success && response.available) {
                    currentUsePoints = inputPoints;
                    updatePointsResult();
                    updatePointsOrderSummary();
                    updateRewardAmount();
                } else {
                    alert(response.message || 'Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö©Ïù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.');
                    resetPointsUsage();
                }
            },
            error: function() {
                alert('Ï†ÅÎ¶ΩÍ∏à Í≤ÄÏ¶ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                resetPointsUsage();
            }
        });
    }

    function updatePointsResult() {
        if (currentUsePoints > 0) {
            $('#useAmount').text(formatCurrency(currentUsePoints) + 'Ïõê');
            $('#remainAmount').text(formatCurrency(currentPoints - currentUsePoints) + 'Ïõê');
            $('#pointsResult').show();
        } else {
            $('#pointsResult').hide();
        }
    }

    function resetPointsUsage() {
        currentUsePoints = 0;
        $('#usePointsInput').val(0);
        $('#pointsResult').hide();
        updatePointsOrderSummary();
        updateRewardAmount();
    }

    function updatePointsOrderSummary() {
        // Ï†ÅÎ¶ΩÍ∏à Ìï†Ïù∏ ÌëúÏãú
        if (currentUsePoints > 0) {
            $('#pointsDiscountAmount').text('-‚Ç©' + formatCurrency(currentUsePoints));
            $('.points-discount-row').show();
        } else {
            $('.points-discount-row').hide();
        }

        // ÏµúÏ¢Ö Í∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞Ï°¥ Ìï®ÏàòÍ∞Ä ÏûàÎã§Î©¥ ÌôúÏö©)
        const finalAmount = calculateCurrentFinalAmount();
        $('#finalAmount').text('‚Ç©' + formatCurrency(finalAmount));

        // Í≤∞Ï†ú Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
        $('#paymentButtonText').text('‚Ç©' + formatCurrency(finalAmount) + ' Í≤∞Ï†úÌïòÍ∏∞');

        // currentTotalAmount ÏóÖÎç∞Ïù¥Ìä∏
        currentTotalAmount = finalAmount;
    }

    // Ïà´Ïûê Ìè¨Îß∑ÌåÖ Ìï®Ïàò (Í∏∞Ï°¥Ïóê ÏóÜÎã§Î©¥ Ï∂îÍ∞Ä)
    function formatCurrency(amount) {
        return parseInt(amount).toLocaleString();
    }

    // Í∏∞Ï°¥ Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®ÏàòÏóê Ï†ÅÎ¶ΩÍ∏à Ï†ïÎ≥¥ Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
    function addPointsToOrderData(orderData) {
        if (typeof orderData === 'object') {
            orderData.usePoints = currentUsePoints;
        }
        return orderData;
    }

    function setupEventListeners() {
        // Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù
        $('.payment-method').click(function() {
            $('.payment-method').removeClass('active');
            $(this).addClass('active');
            $(this).find('input[type="radio"]').prop('checked', true);
        });

        // Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ÏôÄ ÎèôÏùº Ï≤¥ÌÅ¨Î∞ïÏä§
        $('#same-info').change(function() {
            updateAddressFields();
            if ($(this).is(':checked')) {
                $('#receiverName').val($('#ordererName').val());
                $('#receiverPhone').val($('#ordererPhone').val());
                validateField('receiverName');
                validateField('receiverPhone');
            } else {
                $('#receiverName').val('');
                $('#receiverPhone').val('');
                $('#receiverZip').val('');
                $('#receiverAddr').val('');
                $('#receiverAddrDetail').val('');
                $('#deliveryRequest').val('');
                clearFieldError('receiverName');
                clearFieldError('receiverPhone');
                clearFieldError('receiverAddr');
                validationState.receiverName = false;
                validationState.receiverPhone = false;
                validationState.receiverAddr = false;
            }
            updatePaymentButton();
        });

        // Ïø†Ìè∞ ÏÑ†ÌÉù
        $('#couponSelect').change(function() {
            if ($(this).prop('disabled')) {
                return;
            }

            const selectedOption = $(this).find('option:selected');
            applyCoupon(selectedOption);
        });

        // Ìï†Ïù∏ÏΩîÎìú Ï†ÅÏö©
        $('#applyDiscountCode').click(function() {
            if ($(this).prop('disabled') || $(this).hasClass('loading')) {
                return;
            }

            const code = $('#discountCode').val().trim();
            if (code) {
                applyDiscountCode(code);
            } else {
                showDiscountCodeMessage('Ìï†Ïù∏ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            }
        });

        // Ìï†Ïù∏ÏΩîÎìú ÏûÖÎ†• Ïãú ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
        $('#discountCode').keypress(function(e) {
            if (e.which === 13 && !$(this).prop('disabled') && !$('#applyDiscountCode').hasClass('loading')) {
                $('#applyDiscountCode').click();
            }
        });

        // Ï†ÑÏ≤¥ ÎèôÏùò Ï≤¥ÌÅ¨Î∞ïÏä§
        $('#agree-all').change(function() {
            const isChecked = $(this).is(':checked');
            $('input[id^="agree-"]').not('#agree-all').prop('checked', isChecked);
            validateAgreements();
        });

        // Í∞úÎ≥Ñ ÎèôÏùò Ï≤¥ÌÅ¨Î∞ïÏä§
        $('input[id^="agree-"]').not('#agree-all').change(function() {
            const totalCheckboxes = $('input[id^="agree-"]').not('#agree-all').length;
            const checkedCheckboxes = $('input[id^="agree-"]:checked').not('#agree-all').length;
            $('#agree-all').prop('checked', totalCheckboxes === checkedCheckboxes);
            validateAgreements();
        });

        // Ïã§ÏãúÍ∞Ñ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        $('#ordererName, #receiverName').on('input', function() {
            validateField(this.id);
        });

        $('#ordererEmail').on('input', function() {
            validateField(this.id);
        });

        $('#receiverAddrDetail').on('input', function() {
            validateField('receiverAddr');
        });
    }

    // Ìï†Ïù∏ÏΩîÎìú Ï†ÅÏö© (Î∞±ÏóîÎìú Í≤ÄÏ¶ù)
    function applyDiscountCode(code) {
        // Í∏∞Ï°¥ Í≤ÄÏ¶ù Î°úÏßÅ...
        if (!code || code.trim().length === 0) {
            showUserMessage('Ìï†Ïù∏ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            return;
        }

        if (code.trim().length > 20) {
            showDiscountCodeMessage('Ìï†Ïù∏ÏΩîÎìúÎäî 20Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            return;
        }

        setDiscountButtonLoading(true);

        $.ajax({
            url: '/order/discount/validate',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                discountId: code.trim(),
                orderAmount: originalAmount
            }),
            success: function(response) {
                setDiscountButtonLoading(false);

                if (response.success) {
                    const discountInfo = response.data;
                    let discountAmount = response.discountAmount;

                    // üÜï ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° Ï†úÌïú Ï†ÅÏö©
                    let isDiscountLimited = false;
                    if (discountAmount > MAX_DISCOUNT_AMOUNT) {
                        discountAmount = MAX_DISCOUNT_AMOUNT;
                        isDiscountLimited = true;
                    }

                    activeDiscount = {
                        type: 'code',
                        code: discountInfo.discountId,
                        discountType: discountInfo.discountType,
                        value: discountInfo.discountValue,
                        amount: discountAmount, // Ï†úÌïúÎêú Ìï†Ïù∏ Í∏àÏï° ÏÇ¨Ïö©
                        name: discountInfo.discountDescription || discountInfo.discountId,
                        serverData: discountInfo,
                        isLimited: isDiscountLimited
                    };

                    disableCouponSection();
                    updatePriceDisplay();
                    showAppliedDiscount();

                    // Ìï†Ïù∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
                    const discountTypeText = discountInfo.discountType === 'per'
                        ? `${discountInfo.discountValue}% Ìï†Ïù∏`
                        : `${discountAmount.toLocaleString()}Ïõê Ìï†Ïù∏`;

                    let message = `Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§. ${discountTypeText}!`;

                    // üÜï Ìï†Ïù∏ Í∏àÏï°Ïù¥ Ï†úÌïúÎêú Í≤ΩÏö∞ Ï∂îÍ∞Ä Î©îÏãúÏßÄ
                    if (isDiscountLimited) {
                        message += ` (ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ${MAX_DISCOUNT_AMOUNT.toLocaleString()}ÏõêÏù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§)`;
                    }

                    showDiscountCodeMessage(message, 'success');

                    $('#discountCode').prop('readonly', true).addClass('readonly-field');
                    $('#applyDiscountCode').prop('disabled', true).addClass('disabled-button').text('Ï†ÅÏö©Îê®');

                    console.log('Ìï†Ïù∏ÏΩîÎìú Ï†ÅÏö© ÏÑ±Í≥µ:', activeDiscount);
                } else {
                    showDiscountCodeMessage(response.message || 'Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ìï†Ïù∏ÏΩîÎìúÏûÖÎãàÎã§.', 'error');
                    $('#discountCode').focus();
                }
            },
            error: function(xhr, status, error) {
                setDiscountButtonLoading(false);
                // Í∏∞Ï°¥ ÏóêÎü¨ Ï≤òÎ¶¨ Î°úÏßÅ...
                let errorMessage = 'Ìï†Ïù∏ÏΩîÎìú ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                showDiscountCodeMessage(errorMessage, 'error');
            }
        });
    }

    // Ìï†Ïù∏ÏΩîÎìú Î≤ÑÌäº Î°úÎî© ÏÉÅÌÉú Í¥ÄÎ¶¨
    function setDiscountButtonLoading(isLoading) {
        const $button = $('#applyDiscountCode');
        const $input = $('#discountCode');

        if (isLoading) {
            $button.addClass('loading').prop('disabled', true);
            $input.prop('disabled', true);
        } else {
            $button.removeClass('loading').prop('disabled', false);
            $input.prop('disabled', false);
        }
    }

    // ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ÏÉÅÏàò (Ïø†Ìè∞/Ìï†Ïù∏ÏΩîÎìúÎßå Ï†ÅÏö©)
    const MAX_DISCOUNT_AMOUNT = 50000; // 5ÎßåÏõê

    // Ïø†Ìè∞ Ï†ÅÏö© (Îã®ÎèÖ ÏÇ¨Ïö©)
    function applyCoupon(selectedOption) {
        if ($('#couponSelect').prop('disabled')) {
            showUserMessage('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞Ïù¥ ÏóÜÏäµÎãàÎã§.', 'info');
            return;
        }

        if (selectedOption.val() === '' || selectedOption.prop('disabled')) {
            removeActiveDiscount();
            return;
        }

        // Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ïù¥ÎØ∏ Ï†ÅÏö©Îêú Í≤ΩÏö∞ Í≤ΩÍ≥†
        if (activeDiscount && activeDiscount.type === 'code') {
            showUserMessage('Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ïù¥ÎØ∏ Ï†ÅÏö©ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Ìï†Ïù∏ÏΩîÎìúÎ•º Ìï¥Ï†úÌïòÍ≥† Ïø†Ìè∞ÏùÑ Ï†ÅÏö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 'warning');
            if (confirm('Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ïù¥ÎØ∏ Ï†ÅÏö©ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Ìï†Ïù∏ÏΩîÎìúÎ•º Ìï¥Ï†úÌïòÍ≥† Ïø†Ìè∞ÏùÑ Ï†ÅÏö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                removeActiveDiscount();
            } else {
                $('#couponSelect').val('');
                return;
            }
        }

        const couponCode = selectedOption.val();
        const couponId = selectedOption.data('coupon-id');
        const discountType = selectedOption.data('type');
        const discountValue = selectedOption.data('value');
        const minAmount = selectedOption.data('min-amount');

        // ÏµúÏÜå Ï£ºÎ¨∏Í∏àÏï° ÌôïÏù∏
        if (originalAmount < minAmount) {
            showCouponMessage(`Ïù¥ Ïø†Ìè∞ÏùÄ ${minAmount.toLocaleString()}Ïõê Ïù¥ÏÉÅ Ï£ºÎ¨∏ Ïãú ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.`, 'error');
            $('#couponSelect').val('');
            return;
        }

        // Ìï†Ïù∏ Í∏àÏï° Í≥ÑÏÇ∞
        let discountAmount = 0;
        if (discountType === 'per') {
            discountAmount = Math.floor(originalAmount * discountValue / 100);
        } else if (discountType === 'amount') {
            discountAmount = discountValue;
        } else {
            discountAmount = discountValue;
            console.warn('Ïïå Ïàò ÏóÜÎäî Ìï†Ïù∏ ÌÉÄÏûÖ:', discountType, '- Í≥†Ï†ï Í∏àÏï°ÏúºÎ°ú Ï≤òÎ¶¨Ìï©ÎãàÎã§.');
        }

        // üÜï ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° Ï†úÌïú Ï†ÅÏö©
        let isDiscountLimited = false;
        if (discountAmount > MAX_DISCOUNT_AMOUNT) {
            discountAmount = MAX_DISCOUNT_AMOUNT;
            isDiscountLimited = true;
        }

        // Ïø†Ìè∞ Ï†ÅÏö©
        activeDiscount = {
            type: 'coupon',
            code: couponCode,
            couponId: couponId,
            discountType: discountType,
            value: discountValue,
            amount: discountAmount,
            name: selectedOption.text(),
            isLimited: isDiscountLimited
        };

        // Ìï†Ïù∏ÏΩîÎìú ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
        disableDiscountCodeSection();

        updatePriceDisplay();
        updateCouponInfo(selectedOption.text());

        // Ìï†Ïù∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
        const discountTypeText = discountType === 'per' ? `${discountValue}% Ìï†Ïù∏` : `${discountAmount.toLocaleString()}Ïõê Ìï†Ïù∏`;
        let message = `Ïø†Ìè∞Ïù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§. ${discountTypeText}!`;

        // üÜï Ìï†Ïù∏ Í∏àÏï°Ïù¥ Ï†úÌïúÎêú Í≤ΩÏö∞ Ï∂îÍ∞Ä Î©îÏãúÏßÄ
        if (isDiscountLimited) {
            message += ` (ÏµúÎåÄ Ìï†Ïù∏ Í∏àÏï° ${MAX_DISCOUNT_AMOUNT.toLocaleString()}ÏõêÏù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§)`;
        }

        showCouponMessage(message, 'success');
    }

    // ÌôúÏÑ±ÌôîÎêú Ìï†Ïù∏ Ï†úÍ±∞
    function removeActiveDiscount() {
        if (!activeDiscount) return;

        const wasCode = activeDiscount.type === 'code';

        activeDiscount = null;
        updatePriceDisplay();

        if (wasCode) {
            // Ìï†Ïù∏ÏΩîÎìú Ï†úÍ±∞ Ïãú
            hideAppliedDiscount();
            enableCouponSection();
            enableDiscountCodeSection();  // üÜï Ìï†Ïù∏ÏΩîÎìú Ï†úÍ±∞ ÏãúÏóêÎèÑ Ìï†Ïù∏ÏΩîÎìú ÏÑπÏÖò Î≥µÏõê
            showUserMessage('Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.', 'info');
        } else {
            // Ïø†Ìè∞ Ï†úÍ±∞ Ïãú
            $('#couponSelect').val('');
            $('#couponInfo').removeClass('active').html('<i class="fas fa-info-circle"></i><span>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ìï†Ïù∏Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§</span>');
            hideAppliedDiscount();
            enableCouponSection();  // üÜï Ïø†Ìè∞ Ï†úÍ±∞ ÏãúÏóêÎèÑ Ïø†Ìè∞ ÏÑπÏÖò ÌôúÏÑ±Ìôî
            enableDiscountCodeSection();
            showUserMessage('Ïø†Ìè∞Ïù¥ Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.', 'info');
        }

        console.log('Ìï†Ïù∏Ïù¥ Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§. Í∞ÄÍ≤©Ïù¥ ÏõêÎûòÎåÄÎ°ú Î≥µÏõêÎê©ÎãàÎã§.');
    }

    // Í∞ÄÍ≤© ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (Îã®Ïùº Ìï†Ïù∏Îßå ÌëúÏãú)
    function updatePriceDisplay() {
        if (activeDiscount) {
            $('#discountRow').show();
            $('#discountLabel').text(activeDiscount.type === 'coupon' ? 'Ïø†Ìè∞ Ìï†Ïù∏' : 'Ìï†Ïù∏ÏΩîÎìú');
            $('#discountAmount').text(`-‚Ç©${activeDiscount.amount.toLocaleString()}`);
        } else {
            $('#discountRow').hide();
        }

        // ÏµúÏ¢Ö Í∏àÏï° Í≥ÑÏÇ∞ (Ï†ÅÎ¶ΩÍ∏à Ìè¨Ìï®)
        const originalFinalAmount = paymentInfo.finalAmount || 0;
        const totalDiscount = activeDiscount ? activeDiscount.amount : 0;
        currentTotalAmount = Math.max(0, originalFinalAmount - totalDiscount - currentUsePoints);

        // ÏµúÏ¢Ö Í∏àÏï° ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        $('#finalAmount').text(`‚Ç©${currentTotalAmount.toLocaleString()}`);
        $('#paymentButtonText').text(`‚Ç©${currentTotalAmount.toLocaleString()} Í≤∞Ï†úÌïòÍ∏∞`);

        // Ï†ÅÎ¶ΩÍ∏à Í¥ÄÎ†® ÏóÖÎç∞Ïù¥Ìä∏
        updateRewardAmount();
    }

    // Ïø†Ìè∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
    function updateCouponInfo(couponName) {
        $('#couponInfo').addClass('active').html(`<i class="fas fa-check-circle"></i><span>${couponName}Ïù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§</span>`);
    }

    // Ï†ÅÏö©Îêú Ìï†Ïù∏ ÌëúÏãú
    function showAppliedDiscount() {
        const discountText = `${activeDiscount.name} (${activeDiscount.amount.toLocaleString()}Ïõê Ìï†Ïù∏)`;
        $('#discountText').text(discountText);
        $('#appliedDiscount').show();
    }

    // Ï†ÅÏö©Îêú Ìï†Ïù∏ Ïà®ÍπÄ
    function hideAppliedDiscount() {
        $('#appliedDiscount').hide();
    }

    // Ïø†Ìè∞ ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
    function disableCouponSection() {
        $('#couponSelect').prop('disabled', true).addClass('disabled-coupon');
        $('.coupon-info').first().html('<i class="fas fa-info-circle"></i><span style="color: #999;">Ìï†Ïù∏ÏΩîÎìúÍ∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÏóêÏÑúÎäî Ïø†Ìè∞ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§</span>');
    }

    // Ïø†Ìè∞ ÏÑπÏÖò ÌôúÏÑ±Ìôî
    function enableCouponSection() {
        const hasValidCoupons = $('#couponSelect option[value!=""]').length > 0;

        if (hasValidCoupons) {
            $('#couponSelect')
                .prop('disabled', false)
                .removeClass('disabled-coupon')
                .css('background-color', '')  // Î∞∞Í≤ΩÏÉâ Ï¥àÍ∏∞Ìôî
                .css('cursor', '');  // Ïª§ÏÑú Ï¥àÍ∏∞Ìôî

            $('.coupon-info').first().html('<i class="fas fa-info-circle"></i><span>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ìï†Ïù∏Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§</span>');
        }
    }

    // Ìï†Ïù∏ÏΩîÎìú ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
    function disableDiscountCodeSection() {
        $('#discountCode').prop('disabled', true).addClass('disabled-input');
        $('#applyDiscountCode').prop('disabled', true).addClass('disabled-button');
        $('.coupon-info').last().html('<i class="fas fa-gift"></i><span style="color: #999;">Ïø†Ìè∞Ïù¥ Ï†ÅÏö©Îêú ÏÉÅÌÉúÏóêÏÑúÎäî Ìï†Ïù∏ÏΩîÎìúÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§</span>');
    }

    // Í∏∞Ï°¥ Ìï®ÏàòÎ•º Ïù¥ ÏΩîÎìúÎ°ú ÍµêÏ≤¥ÌïòÏÑ∏Ïöî
    function enableDiscountCodeSection() {
        $('#discountCode')
            .prop('disabled', false)
            .prop('readonly', false)
            .removeClass('disabled-input')
            .removeClass('readonly-field')
            .val('')  // ÏûÖÎ†•Í∞í Ï¥àÍ∏∞Ìôî
            .css('background-color', '')  // Î∞∞Í≤ΩÏÉâ Ï¥àÍ∏∞Ìôî
            .css('cursor', '');  // Ïª§ÏÑú Ï¥àÍ∏∞Ìôî

        $('#applyDiscountCode')
            .prop('disabled', false)
            .removeClass('disabled-button')
            .removeClass('loading')
            .html('<span class="btn-text">Ï†ÅÏö©</span><span class="btn-loading"><i class="fas fa-spinner fa-spin"></i> ÌôïÏù∏Ï§ë</span>')
            .css('background', '')  // Î∞∞Í≤ΩÏÉâ Ï¥àÍ∏∞Ìôî
            .css('cursor', '');  // Ïª§ÏÑú Ï¥àÍ∏∞Ìôî

        $('.coupon-info').last().html('<i class="fas fa-gift"></i><span>Ìï†Ïù∏ÏΩîÎìúÎäî ÎåÄÏÜåÎ¨∏ÏûêÎ•º Íµ¨Î∂ÑÌï©ÎãàÎã§</span>');
    }

    // Ìï†Ïù∏ Ï†úÍ±∞ Ìï®Ïàò (Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú)
    function removeDiscount() {
        removeActiveDiscount();
    }

    // Ï£ºÏÜå ÌïÑÎìú ÌëúÏãú/Ïà®ÍπÄ Í¥ÄÎ¶¨
    function updateAddressFields() {
        const isSameInfo = $('#same-info').is(':checked');
        const addressFields = $('#addressFields');

        if (isSameInfo) {
            // ÌöåÏõê Ï†ïÎ≥¥Í∞Ä ÏûàÎäî Í≤ΩÏö∞ Ï£ºÏÜå ÌïÑÎìú ÏûêÎèô Ï±ÑÏõÄ
            /*[# th:if="${member != null}" #]*/
            $('#receiverZip').val(/*[[${member?.memberZip}]]*/ '');
            $('#receiverAddr').val(/*[[${member?.memberAddr}]]*/ '');
            /*[/]*/

            // Ï£ºÏÜå ÌïÑÎìú Ïà®ÍπÄ
            addressFields.addClass('hidden');

            // Ï£ºÏÜå Í¥ÄÎ†® Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Î¨¥Ïãú
            validationState.receiverAddr = true;
        } else {
            // Ï£ºÏÜå ÌïÑÎìú ÌëúÏãú
            addressFields.removeClass('hidden');

            // Ï£ºÏÜå Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Îã§Ïãú Ï†ÅÏö©
            validateField('receiverAddr');
        }

        updatePaymentButton();
    }

    function validateField(fieldId) {
        const field = $('#' + fieldId);
        const value = field.val().trim();
        let isValid = false;
        let errorMessage = '';

        switch (fieldId) {
            case 'ordererName':
            case 'receiverName':
                isValid = value.length >= 2;
                errorMessage = isValid ? '' : 'Ïù¥Î¶ÑÏùÑ 2Í∏ÄÏûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                break;

            case 'ordererPhone':
            case 'receiverPhone':
                isValid = validatePhone(value);
                errorMessage = isValid ? '' : 'Ïò¨Î∞îÎ•∏ Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (Ïòà: 010-1234-5678)';
                break;

            case 'ordererEmail':
                isValid = validateEmail(value);
                errorMessage = isValid ? '' : 'Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                break;

            case 'receiverAddr':
                if ($('#same-info').is(':checked')) {
                    isValid = true;
                } else {
                    const zip = $('#receiverZip').val().trim();
                    const addr = $('#receiverAddr').val().trim();
                    const addrDetail = $('#receiverAddrDetail').val().trim();
                    isValid = zip.length > 0 && addr.length > 0 && addrDetail.length > 0;
                    errorMessage = isValid ? '' : 'Ï£ºÏÜåÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
                }
                break;
        }

        validationState[fieldId] = isValid;

        if (isValid) {
            clearFieldError(fieldId);
        } else if (value.length > 0) {
            showFieldError(fieldId, errorMessage);
        } else {
            clearFieldError(fieldId);
        }

        updatePaymentButton();
        return isValid;
    }

    function validateAgreements() {
        validationState.agreeTerms = $('#agree-terms').is(':checked');
        validationState.agreePrivacy = $('#agree-privacy').is(':checked');
        validationState.agreeAdult = $('#agree-adult').is(':checked');
        updatePaymentButton();
    }

    function validateAllFields() {
        validateField('ordererName');
        validateField('ordererPhone');
        validateField('ordererEmail');
        validateField('receiverName');
        validateField('receiverPhone');
        validateField('receiverAddr');
        validateAgreements();
    }

    function showFieldError(fieldId, message) {
        const field = $('#' + fieldId);
        const errorElement = $('#' + fieldId + '-error');

        field.addClass('error');
        errorElement.text(message).show();
    }

    function clearFieldError(fieldId) {
        const field = $('#' + fieldId);
        const errorElement = $('#' + fieldId + '-error');

        field.removeClass('error');
        errorElement.hide();
    }

    function updatePaymentButton() {
        const isValid = isFormValid();
        $('#paymentButton').prop('disabled', !isValid);

        if (isValid) {
            $('#paymentButton').removeClass('disabled');
        } else {
            $('#paymentButton').addClass('disabled');
        }
    }

    function isFormValid() {
        return Object.values(validationState).every(isValid => isValid);
    }

    function processPayment() {
        if (!isFormValid()) {
            showUserMessage('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            return;
        }
    }

    function showUserMessage(message, type) {
        $('.user-message').remove();

        const messageClass = type === 'error' ? 'error-message' : (type === 'success' ? 'success-message' : 'info-message');
        const iconClass = type === 'error' ? 'fas fa-exclamation-circle' : (type === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle');
        const bgColor = type === 'error' ? '#fff2f2' : (type === 'success' ? '#f0f9ff' : '#f0f9ff');
        const borderColor = type === 'error' ? '#ffcccc' : (type === 'success' ? '#b3e5fc' : '#b3e5fc');
        const textColor = type === 'error' ? '#d63060' : (type === 'success' ? '#0277bd' : '#0277bd');

        const messageHtml = `
            <div class="user-message ${messageClass}" style="
                display: flex;
                align-items: center;
                gap: 8px;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                color: ${textColor};
                padding: 16px;
                border-radius: 12px;
                margin-bottom: 20px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                animation: slideDown 0.3s ease-out;
            ">
                <i class="${iconClass}"></i>
                <span>${message}</span>
                <button onclick="$(this).closest('.user-message').fadeOut()" style="
                    margin-left: auto;
                    background: none;
                    border: none;
                    color: ${textColor};
                    cursor: pointer;
                    font-size: 16px;
                    padding: 0;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">√ó</button>
            </div>
        `;

        $('.page-title').after(messageHtml);

        setTimeout(() => {
            $('.user-message').fadeOut();
        }, 5000);
    }

    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                let addr = '';
                let extraAddr = '';

                if (data.userSelectedType === 'R') {
                    addr = data.roadAddress;
                } else {
                    addr = data.jibunAddress;
                }

                if(data.userSelectedType === 'R'){
                    if(data.bname !== '' && /[Îèô|Î°ú|Í∞Ä]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if(extraAddr !== ''){
                        extraAddr = ' (' + extraAddr + ')';
                    }
                    addr += extraAddr;
                }

                $('#receiverZip').val(data.zonecode);
                $('#receiverAddr').val(addr);
                $('#receiverAddrDetail').focus();

                validateField('receiverAddr');
            }
        }).open();
    }

    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function validatePhone(phone) {
        const cleanPhone = phone.replace(/[^0-9]/g, '');
        const re = /^01[0-9]{8,9}$/;
        return re.test(cleanPhone);
    }

    let isPaymentProcessing = false;

    window.addEventListener('beforeunload', function(e) {
        if (isPaymentProcessing) {
            e.preventDefault();
            e.returnValue = 'Í≤∞Ï†úÍ∞Ä ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º Îñ†ÎÇòÏãúÍ≤†ÏäµÎãàÍπå?';
        }
    });

    // Í∏ÄÎ°úÎ≤å Ìï®Ïàò ÎÖ∏Ï∂ú
    window.forceResetPaymentButton = forceResetPaymentButton;
    window.removeDiscount = removeDiscount;

    function forceResetPaymentButton() {
        const button = document.getElementById('paymentButton');  // Í≤∞Ï†ú Î≤ÑÌäº
        button.disabled = false;  // Î≤ÑÌäºÏùÑ ÌôúÏÑ±Ìôî
        button.classList.remove('processing');  // 'processing' ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        button.innerHTML = `<i class="fas fa-lock" style="margin-right: 8px;"></i><span id="paymentButtonText">‚Ç©${currentTotalAmount.toLocaleString()} Í≤∞Ï†úÌïòÍ∏∞</span>`;  // Î≤ÑÌäº ÌÖçÏä§Ìä∏ Î≥µÏõê
    }

    // ÌÖåÏä§Ìä∏ Ìï®ÏàòÎì§ (Í∞úÎ∞úÏûê ÎèÑÍµ¨ÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•)
    window.testResetButton = function() {
        console.log('ÌÖåÏä§Ìä∏: Î≤ÑÌäº Í∞ïÏ†ú Î≥µÏõê Ïã§Ìñâ');
        if (typeof window.forceResetPaymentButton === 'function') {
            window.forceResetPaymentButton();
            console.log('ÌÖåÏä§Ìä∏ ÏôÑÎ£å: Î≤ÑÌäº ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Î≥¥ÏÑ∏Ïöî');
        } else {
            console.error('forceResetPaymentButton Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
        }
    };

    window.testBackendDiscountCode = function(code = 'SAVE2024') {
        console.log('ÌÖåÏä§Ìä∏: Î∞±ÏóîÎìú Ìï†Ïù∏ÏΩîÎìú Ï†ÅÏö©');
        $('#discountCode').val(code);
        $('#applyDiscountCode').click();
        console.log('ÌÖåÏä§Ìä∏ ÏôÑÎ£å: Î∞±ÏóîÎìúÎ°ú Ìï†Ïù∏ÏΩîÎìú Í≤ÄÏ¶ù ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§');
    };

    window.testCouponSelect = function() {
        console.log('ÌÖåÏä§Ìä∏: Ï≤´ Î≤àÏß∏ Ïø†Ìè∞ ÏÑ†ÌÉù');
        const firstOption = $('#couponSelect option[value!=""]:first');
        if (firstOption.length > 0) {
            $('#couponSelect').val(firstOption.val()).trigger('change');
            console.log('ÌÖåÏä§Ìä∏ ÏôÑÎ£å: Ï≤´ Î≤àÏß∏ Ïø†Ìè∞Ïù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§');
        } else {
            console.log('ÌÖåÏä§Ìä∏ Ïã§Ìå®: ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïø†Ìè∞Ïù¥ ÏóÜÏäµÎãàÎã§');
        }
    };

    window.resetAllDiscounts = function() {
        console.log('ÌÖåÏä§Ìä∏: Î™®Îì† Ìï†Ïù∏ Ï¥àÍ∏∞Ìôî');
        removeActiveDiscount();
        console.log('ÌÖåÏä§Ìä∏ ÏôÑÎ£å: Î™®Îì† Ìï†Ïù∏Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
    };

    window.debugPayment = function() {
        console.log('=== Í≤∞Ï†ú ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ ===');
        console.log('Payment Info:', paymentInfo);
        console.log('Cart Codes:', cartCodes);
        console.log('Cart Items:', cartItems);
        console.log('Active Discount:', activeDiscount);
        console.log('Original Amount:', originalAmount.toLocaleString());
        console.log('Current Total Amount:', currentTotalAmount.toLocaleString());
        console.log('Current Use Points:', currentUsePoints.toLocaleString());
        console.log('Current Points:', currentPoints.toLocaleString());
        console.log('Validation State:', validationState);
        console.log('Form Valid:', isFormValid());
        console.log('Payment Processing:', isPaymentProcessing);

        console.log('--- Í∞ÄÍ≤© ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ---');
        console.log('ÏÉÅÌíà Í∏àÏï°:', originalAmount.toLocaleString());
        console.log('Í∏∞Î≥∏ Ìï†Ïù∏:', (paymentInfo.discountAmount || 0).toLocaleString());
        console.log('Î∞∞ÏÜ°ÎπÑ:', (paymentInfo.deliveryFee || 0).toLocaleString());
        console.log('ÏÑúÎ≤Ñ ÏµúÏ¢Ö Í∏àÏï°:', (paymentInfo.finalAmount || 0).toLocaleString());
        if (activeDiscount) {
            console.log('Ï†ÅÏö©Îêú Ìï†Ïù∏:', activeDiscount.type, '-', activeDiscount.amount.toLocaleString());
        }
        if (currentUsePoints > 0) {
            console.log('ÏÇ¨Ïö© Ï†ÅÎ¶ΩÍ∏à:', currentUsePoints.toLocaleString());
        }
        console.log('ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï°:', currentTotalAmount.toLocaleString());
        console.log('=====================');
    };

    // Ï¥àÍ∏∞Ìôî ÌôïÏù∏
    $(document).ready(function() {
        console.log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å - Ìï†Ïù∏ÏΩîÎìú Î∞±ÏóîÎìú Í≤ÄÏ¶ù ÏãúÏä§ÌÖú ÌôúÏÑ±ÌôîÎê®');
        console.log('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÌÖåÏä§Ìä∏ Ìï®Ïàò:');
        console.log('- window.testBackendDiscountCode(): Î∞±ÏóîÎìú Ìï†Ïù∏ÏΩîÎìú Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏');
        console.log('- window.testCouponSelect(): Ïø†Ìè∞ ÏÑ†ÌÉù ÌÖåÏä§Ìä∏');
        console.log('- window.resetAllDiscounts(): Î™®Îì† Ìï†Ïù∏ Ï¥àÍ∏∞Ìôî');
        console.log('- window.debugPayment(): ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï∂úÎ†•');
        console.log('Î∞±ÏóîÎìú API ÏóîÎìúÌè¨Ïù∏Ìä∏: POST /api/discount/validate');
    });

    // Ìï†Ïù∏ÏΩîÎìú ÏûÖÎ†• Ïãú ÎåÄÎ¨∏Ïûê Î≥ÄÌôò
    $('#discountCode').on('input keyup paste', function() {
        this.value = this.value.toUpperCase();
    });

    // Í∏∞Ï°¥ order.html ÌååÏùºÏóêÏÑú Í≤∞Ï†úÌïòÍ∏∞ Î≤ÑÌäº Í¥ÄÎ†® JavaScriptÎßå ÏàòÏ†ï

    // Í≤∞Ï†úÌïòÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Í∏∞Ï°¥ ÏΩîÎìú ÎåÄÏ≤¥)
    document.getElementById('paymentButton').addEventListener('click', function() {
        const selected = document.querySelector('input[name="payment"]:checked').value;
        if (selected === 'card') {
            // Í≤∞Ï†ú ÏßÑÌñâ Ï§ë ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            this.disabled = true;
            this.classList.add('processing');
            this.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë...';

            try {
                // Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const orderData = collectOrderData();
                // ÏûÖÎ†• Í≤ÄÏ¶ù
                if (!validateOrderData(orderData)) {
                    resetPaymentButton();
                    return;
                }

                // Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠
                createOrder(orderData);

            } catch (error) {
                console.error('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò:', error);
                alert('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                resetPaymentButton();
            }
        } else if (selected === 'trans') {
            alert('Ïã§ÏãúÍ∞Ñ Í≥ÑÏ¢åÏù¥Ï≤¥Í∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§. Í≥ÑÏ¢åÏù¥Ï≤¥ ÏïàÎÇ¥ Î©îÏãúÏßÄ...');
        }
    });

    // Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
    function collectOrderData() {
        const ordererName = document.getElementById('ordererName').value.trim();
        const ordererPhone = document.getElementById('ordererPhone').value.trim();
        const ordererEmail = document.getElementById('ordererEmail').value.trim();
        const receiverName = document.getElementById('receiverName').value.trim();
        const receiverPhone = document.getElementById('receiverPhone').value.trim();
        const receiverZip = document.getElementById('receiverZip').value.trim();
        const receiverAddr = document.getElementById('receiverAddr').value.trim();
        const receiverAddrDetail = document.getElementById('receiverAddrDetail').value.trim();
        const deliveryRequest = document.getElementById('deliveryRequest').value.trim();
        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'card';
        const agreeTerms = document.getElementById('agree-terms').checked;
        const agreePrivacy = document.getElementById('agree-privacy').checked;
        const agreeAdult = document.getElementById('agree-adult').checked;
        const couponCode   = document.getElementById('couponSelect')?.value   || '';
        const discountCode = document.getElementById('discountCode')?.value   || '';


        let productCode, optionCode, quantity;

        if (isDirect) {
            productCode = /*[[${productCode}]]*/ null;
            optionCode = /*[[${optionCode}]]*/ null;
            quantity = /*[[${quantity}]]*/ null;
        } else {
            productCode = null;
            optionCode = null;
            quantity = null;
        }

        // üÜï Ï†ÅÎ¶ΩÍ∏à Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        return {
            ordererName, ordererPhone, ordererEmail,
            receiverName, receiverPhone, receiverZip, receiverAddr, receiverAddrDetail, deliveryRequest,
            paymentMethod,
            totalAmount: paymentInfo.totalAmount,
            discountAmount: activeDiscount ? activeDiscount.amount : 0,
            deliveryFee: paymentInfo.deliveryFee,
            finalAmount: 500,
            cartCodes: isDirect ? [] : cartCodes,
            productCode, optionCode, quantity,
            couponCode, discountCode, agreeTerms, agreePrivacy, agreeAdult,
            usePoints: currentUsePoints  // üÜï Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö© Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        };
    }

    // Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
    function validateOrderData(data) {
        if (!data.ordererName) {
            alert('Ï£ºÎ¨∏Ïûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('ordererName').focus();
            return false;
        }
        if (!data.ordererPhone) {
            alert('Ï£ºÎ¨∏Ïûê Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('ordererPhone').focus();
            return false;
        }
        if (!data.ordererEmail) {
            alert('Ï£ºÎ¨∏Ïûê Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('ordererEmail').focus();
            return false;
        }
        if (!data.receiverName) {
            alert('Î∞õÎäî Î∂Ñ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('receiverName').focus();
            return false;
        }
        if (!data.receiverPhone) {
            alert('Î∞õÎäî Î∂Ñ Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('receiverPhone').focus();
            return false;
        }
        if (!data.receiverZip || !data.receiverAddr) {
            alert('Î∞∞ÏÜ°ÏßÄ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.ordererEmail)) {
            alert('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('ordererEmail').focus();
            return false;
        }

        const phoneRegex = /^01[0-9]-?[0-9]{4}-?[0-9]{4}$/;
        if (!phoneRegex.test(data.ordererPhone.replace(/-/g, ''))) {
            alert('Ïò¨Î∞îÎ•∏ Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (Ïòà: 010-1234-5678)');
            document.getElementById('ordererPhone').focus();
            return false;
        }

        if (!phoneRegex.test(data.receiverPhone.replace(/-/g, ''))) {
            alert('Ïò¨Î∞îÎ•∏ Î∞õÎäî Î∂Ñ Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            document.getElementById('receiverPhone').focus();
            return false;
        }

        if (!data.agreeTerms) {
            alert('Ïù¥Ïö©ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
            return false;
        }

        if (!data.agreePrivacy) {
            alert('Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®Ïóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
            return false;
        }

        if (!data.agreeAdult) {
            alert('ÏÑ±Ïù∏Ïö©Ìíà Íµ¨Îß§ ÎèôÏùò Î∞è ÏÑ±Ïù∏Ïù∏Ï¶ù ÌôïÏù∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.');
            return false;
        }

        if (data.finalAmount <= 0) {
            alert('Ï£ºÎ¨∏ Í∏àÏï°Ïù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
            return false;
        }

        return true;
    }

    // Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠
    function createOrder(orderData) {
        const endpoint = isDirect ? '/order/create-direct-order' : '/order/create-order';

        console.log('Ï£ºÎ¨∏ ÏÉùÏÑ± ÏöîÏ≤≠:', orderData);

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(orderData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Ï£ºÎ¨∏ ÏÉùÏÑ± ÏùëÎãµ:', data);

                if (data.success) {
                    document.getElementById("goodsNm").value = data.goodsNm;
                    document.getElementById("ordNo").value = data.orderId;
                    document.getElementById("ordNm").value = data.ordNm;
                    document.getElementById("ordTel").value = data.ordTel;
                    document.getElementById("ordEmail").value = data.ordEmail;
                    document.getElementById("goodsAmt").value = data.goodsAmt;
                    document.getElementById("ediDate").value = data.ediDate;
                    document.getElementById("encData").value = data.encData;
                    document.getElementById("userIp").value = data.userIp;

                    document.getElementById('payBtn').click();
                    // window.location.href = `/pay`;
                    //window.location.href = `/order/order-complete/${data.orderId}`;
                    // Í≤∞Ï†ú Í∏∞Îä• Ï∂îÍ∞Ä Ïãú Ïó¨Í∏∞ÏÑú PGÏÇ¨ Í≤∞Ï†ú Ï≤òÎ¶¨
                    // processPayment(data.orderCode, orderData.finalAmount);
                } else {
                    alert('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ïã§Ìå®: ' + (data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'));
                    resetPaymentButton();
                }
            })
            .catch(error => {
                console.error('Ï£ºÎ¨∏ ÏöîÏ≤≠ Ïò§Î•ò:', error);
                alert('Ï£ºÎ¨∏ Ï≤òÎ¶¨ Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                resetPaymentButton();
            });
    }

    // Í≤∞Ï†ú ÏôÑÎ£å ÌõÑ PG SDKÍ∞Ä Ìò∏Ï∂ú
    function pay_result_submit(){
        payResultSubmit();  // ÏúÑ formÏùÑ returnUrlÎ°ú POST
    }
    function pay_result_close(){
        // ÌåùÏóÖ Îã´Ìûò Ï≤òÎ¶¨ (ÏÑ†ÌÉù)
    }

    // Í≤∞Ï†ú Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    function resetPaymentButton() {
        const button = document.getElementById('paymentButton');
        button.disabled = false;
        button.classList.remove('processing');
        button.innerHTML = `<i class="fas fa-lock" style="margin-right: 8px;"></i><span id="paymentButtonText">‚Ç©${currentTotalAmount.toLocaleString()} Í≤∞Ï†úÌïòÍ∏∞</span>`;
    }

    // üÜï Ï†ÅÎ¶ΩÍ∏à Í¥ÄÎ†® Í∏ÄÎ°úÎ≤å Ìï®Ïàò ÎÖ∏Ï∂ú
    window.getCurrentUsePoints = function() {
        return currentUsePoints;
    };

    window.addPointsToPaymentForm = function() {
        // Í∏∞Ï°¥ Í≤∞Ï†ú ÌèºÏóê Ï†ÅÎ¶ΩÍ∏à ÏÇ¨Ïö© Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        if ($('input[name="usePoints"]').length === 0) {
            $('<input>').attr({
                type: 'hidden',
                name: 'usePoints',
                value: currentUsePoints
            }).appendTo('#paymentForm, form');
        } else {
            $('input[name="usePoints"]').val(currentUsePoints);
        }
    };

    function showDiscountCodeMessage(message, type) {
        const messageDiv = $('#discountCodeMessage');
        const messageText = messageDiv.find('.message-text');

        messageText.text(message);
        messageDiv.removeClass('error success warning info').addClass(type + ' show');

        setTimeout(() => hideDiscountCodeMessage(), 3000);
    }

    function hideDiscountCodeMessage() {
        $('#discountCodeMessage').removeClass('show');
    }

    function showCouponMessage(message, type) {
        const messageDiv = $('#couponMessage');
        const messageText = messageDiv.find('.message-text');

        messageText.text(message);
        messageDiv.removeClass('error success warning info').addClass(type + ' show');

        setTimeout(() => hideCouponMessage(), 3000);
    }

    function hideCouponMessage() {
        $('#couponMessage').removeClass('show');
    }
</script>
</body>
</html>