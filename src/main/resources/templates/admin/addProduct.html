<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ìƒí’ˆ ë“±ë¡ - ê´€ë¦¬ì</title>

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- ê´€ë¦¬ì ì‚¬ì´ë“œë°” CSS/JS -->
    <link rel="stylesheet" href="/css/adminSidebar.css">
    <script src="/js/adminSidebar.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* í—¤ë” */
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 0 40px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-info {
            color: #6c757d;
            font-size: 13px;
            font-weight: 300;
        }

        .logout-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #212529;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #212529;
            color: #fff;
        }

        /* ì»¨í…Œì´ë„ˆ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* í˜ì´ì§€ íƒ€ì´í‹€ */
        .page-title {
            margin-bottom: 40px;
        }

        .page-title h2 {
            color: #212529;
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .page-title p {
            color: #6c757d;
            font-size: 14px;
            font-weight: 300;
        }

        /* í¼ ì»¨í…Œì´ë„ˆ */
        .form-container {
            background: #fff;
            border: 1px solid #e9ecef;
            margin-bottom: 40px;
        }

        .form-section {
            padding: 40px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-header {
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .section-title {
            color: #212529;
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        /* í¼ ìš”ì†Œë“¤ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #212529;
        }

        .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ */
        .file-upload {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            border: 1px dashed #dee2e6;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 120px;
        }

        .file-label:hover {
            border-color: #212529;
            background: #fff;
        }

        .file-text {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .file-subtext {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ê°€ê²© ê´€ë ¨ */
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .input-group {
            display: flex;
            align-items: stretch;
        }

        .input-addon {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-right: none;
            padding: 15px;
            color: #6c757d;
            font-size: 14px;
            font-weight: 300;
            display: flex;
            align-items: center;
        }

        .input-group .form-input {
            border-left: none;
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ */
        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border: 1px solid #dee2e6;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-item:hover {
            border-color: #212529;
        }

        .radio-item:has(input:checked) {
            border-color: #212529;
            background: #f8f9fa;
        }

        .radio-input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .radio-label {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
        }

        /* ì˜µì…˜ ê´€ë¦¬ */
        .option-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .option-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .option-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 30px;
            position: relative;
        }

        .option-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .option-item-title {
            color: #212529;
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .option-remove-btn {
            background: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 8px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-remove-btn:hover {
            background: #dc3545;
            color: #fff;
        }

        .option-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .option-values-container {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .option-values-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-values-title {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .add-value-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-value-btn:hover {
            border-color: #212529;
        }

        .option-values-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-value-item {
            display: grid;
            grid-template-columns: 1fr 100px 100px 100px auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #fff;
            border: 1px solid #dee2e6;
        }

        .option-value-input {
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 13px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .option-value-input:focus {
            outline: none;
            border-color: #212529;
        }

        .remove-value-btn {
            background: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-value-btn:hover {
            background: #dc3545;
            color: #fff;
        }

        /* ì¬ê³  ê´€ë ¨ */
        .total-quantity-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-top: 15px;
        }

        .total-quantity-info.auto-calculated {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .quantity-status {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 8px;
        }

        .quantity-status.manual {
            color: #212529;
        }

        .quantity-status.auto {
            color: #16a34a;
        }

        .quantity-details {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            line-height: 1.4;
        }

        /* ìƒí’ˆ ì½”ë“œ ê´€ë ¨ */
        .product-code-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .code-input-container {
            display: flex;
            align-items: stretch;
            gap: 10px;
        }

        .code-input {
            flex: 1;
        }

        .code-generate-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 15px 25px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .code-generate-btn:hover {
            border-color: #212529;
        }

        .code-format-info {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            padding: 12px;
            background: #f8f9fa;
            border-left: 2px solid #212529;
        }

        .duplicate-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 300;
            padding: 12px;
        }

        .duplicate-check.success {
            color: #16a34a;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .duplicate-check.error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .duplicate-check.checking {
            color: #d97706;
            background: #fffbeb;
            border: 1px solid #fed7aa;
        }

        /* íŒŒì¼ ê´€ë ¨ */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            font-size: 13px;
            font-weight: 300;
        }

        .file-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            transition: background-color 0.2s;
        }

        .file-remove:hover {
            background: #fee2e2;
        }

        /* ë²„íŠ¼ */
        .btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 15px 30px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn:hover {
            border-color: #212529;
        }

        .btn-primary {
            background: #212529;
            color: #fff;
            border-color: #212529;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-secondary {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            border-color: #212529;
        }

        /* í¼ ì•¡ì…˜ */
        .form-actions {
            background: #f8f9fa;
            padding: 40px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #e9ecef;
        }

        .help-text {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            margin-top: 8px;
        }

        /* ì˜µì…˜ ì›ê°€ ê´€ë¦¬ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .option-cost-management {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .uniform-cost-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .uniform-cost-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .uniform-cost-label {
            color: #212529;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
        }

        .uniform-cost-input-group {
            display: none;
            margin-top: 15px;
        }

        .uniform-cost-input-group.active {
            display: block;
        }

        .uniform-cost-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .uniform-cost-input {
            width: 200px;
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .uniform-cost-input:focus {
            outline: none;
            border-color: #212529;
        }

        .uniform-cost-apply-btn {
            background: #212529;
            color: #fff;
            border: 1px solid #212529;
            padding: 12px 20px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .uniform-cost-apply-btn:hover {
            background: #000;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
            }

            .container {
                padding: 20px 15px;
            }

            .form-section {
                padding: 25px 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .price-grid {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 15px;
            }

            .form-actions {
                flex-direction: column-reverse;
                padding: 25px 20px;
            }

            .btn {
                width: 100%;
            }

            .code-input-container {
                flex-direction: column;
            }

            .option-value-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .option-header {
                flex-direction: column;
                align-items: stretch;
            }

            .uniform-cost-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .uniform-cost-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- ì‚¬ì´ë“œë°” ë ˆì´ì•„ì›ƒ í¬í•¨ -->
<div th:replace="~{layout/adminSidebar :: sidebar}"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="main-content">
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-actions">
            <div class="admin-info">
                ê´€ë¦¬ìë‹˜ í™˜ì˜í•©ë‹ˆë‹¤
            </div>
            <button class="logout-btn" onclick="logout()">
                Sign Out
            </button>
        </div>
    </header>

    <!-- ì»¨í…Œì´ë„ˆ -->
    <div class="container">
        <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
        <div class="page-title">
            <h2>ìƒí’ˆ ë“±ë¡</h2>
            <p>ìƒˆë¡œìš´ ìƒí’ˆì„ ë“±ë¡í•©ë‹ˆë‹¤</p>
        </div>

        <div class="form-container">
            <form th:action="@{/admin/products}" th:object="${productDto}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <!-- ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">ì¹´í…Œê³ ë¦¬ ì„¤ì •</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="parentCategory">
                                ìƒìœ„ ì¹´í…Œê³ ë¦¬ <span class="required">*</span>
                            </label>
                            <select class="form-select" id="parentCategory" name="categoryCode" required>
                                <option value="">ìƒìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                <option th:each="category : ${categories}"
                                        th:value="${category.categoryCode}"
                                        th:text="${category.categoryName}">
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="childCategory">
                                í•˜ìœ„ ì¹´í…Œê³ ë¦¬ <span class="required">*</span>
                            </label>
                            <select class="form-select" id="childCategory" name="cateDetailCode" required>
                                <option value="">í•˜ìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ìƒí’ˆ ì˜µì…˜ ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">ìƒí’ˆ ì˜µì…˜ ê´€ë¦¬</h3>
                    </div>

                    <div class="option-container">
                        <div class="option-header">
                            <p class="help-text">ìƒí’ˆì— ìƒ‰ìƒ, í¬ê¸° ë“±ì˜ ì˜µì…˜ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš° ê±´ë„ˆë›°ì–´ë„ ë©ë‹ˆë‹¤.</p>
                            <button type="button" class="btn btn-secondary" id="addOptionBtn">
                                ì˜µì…˜ ì¶”ê°€
                            </button>
                        </div>
                        <div class="option-cost-management" id="optionCostManagement" style="display: none;">
                            <div class="uniform-cost-toggle">
                                <input type="checkbox" class="uniform-cost-checkbox" id="uniformCostCheck">
                                <label class="uniform-cost-label" for="uniformCostCheck">
                                    ëª¨ë“  ì˜µì…˜ ì›ê°€ ë™ì¼í•˜ê²Œ ì„¤ì •
                                </label>
                            </div>

                            <div class="uniform-cost-input-group" id="uniformCostInputGroup">
                                <div class="form-group">
                                    <label class="form-label">
                                        í†µí•© ì˜µì…˜ ì›ê°€
                                    </label>
                                    <div class="uniform-cost-controls">
                                        <div class="input-group">
                                            <div class="input-addon">â‚©</div>
                                            <input type="number" class="uniform-cost-input" id="uniformCostInput"
                                                   placeholder="0" min="0">
                                        </div>
                                        <button type="button" class="uniform-cost-apply-btn" id="applyCostBtn">
                                            ëª¨ë“  ì˜µì…˜ì— ì ìš©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="optionList" class="option-list">
                            <!-- ë™ì ìœ¼ë¡œ ì˜µì…˜ì´ ì¶”ê°€ë  ì˜ì—­ -->
                        </div>
                    </div>
                </div>

                <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">ê¸°ë³¸ ì •ë³´</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="productCode">
                                ìƒí’ˆ ì½”ë“œ <span class="required">*</span>
                            </label>
                            <div class="product-code-group">
                                <div class="code-input-container">
                                    <input type="text" class="form-input code-input" id="productCode"
                                           th:field="*{productId}" placeholder="ì˜ˆ: PR-A001, TH-A001" required>
                                    <button type="button" class="code-generate-btn" id="generateCodeBtn">
                                        ì¤‘ë³µí™•ì¸
                                    </button>
                                </div>
                                <div class="code-format-info">
                                    <strong>ìƒí’ˆ ì½”ë“œ í˜•ì‹:</strong> ì¹´í…Œê³ ë¦¬ì½”ë“œ-ìˆ«ì (ì˜ˆ: TA-001, CL-001, AC-001)
                                </div>
                                <div class="duplicate-check" id="duplicateCheck" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="productName">
                                ìƒí’ˆ ì´ë¦„ <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="productName"
                                   th:field="*{productName}" placeholder="ìƒí’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="productQuantity">
                                ì „ì²´ ì¬ê³  ìˆ˜ëŸ‰ <span class="required">*</span>
                            </label>
                            <input type="number" class="form-input" id="productQuantity"
                                   th:field="*{productQuantity}" placeholder="0" min="0" required>

                            <!-- ì¬ê³  ìƒíƒœ ì •ë³´ -->
                            <div class="total-quantity-info" id="quantityInfo">
                                <div class="quantity-status manual" id="quantityStatus">ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ</div>
                                <div class="quantity-details" id="quantityDetails">
                                    ì˜µì…˜ì´ ì—†ëŠ” ìƒí’ˆì˜ ê²½ìš° ì§ì ‘ ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label" for="productDescription">
                            ìƒí’ˆ ì„¤ëª…
                        </label>
                        <textarea class="form-textarea" id="productDescription"
                                  th:field="*{productDescription}" placeholder="ìƒí’ˆì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                </div>

                <!-- ì´ë¯¸ì§€ ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">ì´ë¯¸ì§€ ê´€ë¦¬</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                ìƒí’ˆ íƒ€ì´í‹€ ì´ë¯¸ì§€ <span class="required">*</span>
                            </label>
                            <div class="file-upload">
                                <input type="file" class="file-input" name="titleImage" id="titleImage" accept="image/*" required>
                                <div class="file-label">
                                    <div class="file-text">íƒ€ì´í‹€ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                                    <div class="file-subtext">JPG, PNG íŒŒì¼ ì—…ë¡œë“œ</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ìƒí’ˆ íƒ€ì´í‹€ ì´ë¯¸ì§€2 (WebP)
                            </label>
                            <div class="file-upload">
                                <input type="file" class="file-input" id="titleImage2" name="titleImage2" accept=".webp">
                                <div class="file-label">
                                    <div class="file-text">WebP ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                                    <div class="file-subtext">WebP í˜•ì‹ë§Œ ì§€ì›</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ìƒí’ˆ ì¸ë„¤ì¼ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
                            </label>
                            <div class="file-upload-container">
                                <div class="file-upload">
                                    <input type="file" class="file-input" id="thumbnails" name="thumbnails" accept="image/*" multiple>
                                    <div class="file-label">
                                        <div class="file-text">ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                                        <div class="file-subtext">ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>
                                <div class="selected-files" id="thumbnailFiles"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                ìƒí’ˆ ìƒì„¸ ì´ë¯¸ì§€ <span class="required">*</span>
                            </label>
                            <div class="file-upload-container">
                                <div class="file-upload">
                                    <input type="file" class="file-input" id="detailImages" name="detailImages" accept="image/*" multiple required>
                                    <div class="file-label">
                                        <div class="file-text">ìƒì„¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                                        <div class="file-subtext">ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                                    </div>
                                </div>
                                <div class="selected-files" id="detailFiles"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê°€ê²© ì •ë³´ ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">ê°€ê²© ì •ë³´</h3>
                    </div>
                    <div class="price-grid">
                        <div class="form-group">
                            <label class="form-label" for="priceOriginal">
                                ìƒí’ˆ ì •ê°€
                            </label>
                            <div class="input-group">
                                <div class="input-addon">â‚©</div>
                                <input type="number" class="form-input" id="priceOriginal"
                                       name="priceOriginal" placeholder="0" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="priceSelling">
                                ìƒí’ˆ íŒë§¤ê°€ <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <div class="input-addon">â‚©</div>
                                <input type="number" class="form-input" id="priceSelling"
                                       name="priceSelling" placeholder="0" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="priceCost">
                                ìƒí’ˆ ì›ê°€ <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <div class="input-addon">â‚©</div>
                                <input type="number" class="form-input" id="priceCost"
                                       name="priceCost" placeholder="0" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- íŒë§¤ ì„¤ì • ì„¹ì…˜ -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">íŒë§¤ ì„¤ì •</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            ìƒí’ˆ íŒë§¤ìƒíƒœ <span class="required">*</span>
                        </label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" class="radio-input" id="productActiveTrue"
                                       th:field="*{productActive}" value="1" required>
                                <label class="radio-label" for="productActiveTrue">íŒë§¤ ê°€ëŠ¥</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" class="radio-input" id="productActiveFalse"
                                       th:field="*{productActive}" value="0" required>
                                <label class="radio-label" for="productActiveFalse">íŒë§¤ ë¶ˆê°€</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        ì·¨ì†Œ
                    </button>
                    <button type="button" class="btn btn-primary" id="submitBtn">
                        ìƒí’ˆ ë“±ë¡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const categories = /*[[${categories}]]*/ '[]';
    /*]]>*/
</script>

<script>
    $(document).ready(function() {
        // ğŸ”¥ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        // ğŸ”¥ ëª¨ë“  jQuery AJAXì— ìë™ ì ìš©
        $.ajaxSetup({
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            }
        });
    });
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    function logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch('/admin/auth/logout', {
                method: 'POST',
                headers: {
                    [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]:
                        document.querySelector('meta[name="_csrf"]').getAttribute('content')
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/admin/login';
                    }
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/admin/login';
                });
        }
    }

    // ì˜µì…˜ ê´€ë¦¬ ê´€ë ¨ JavaScript
    let optionCounter = 0;
    let hasOptions = false;

    document.getElementById('productActiveTrue').addEventListener('click', function() {
        this.checked = true;
        document.getElementById('productActiveFalse').checked = false;
    });

    document.getElementById('productActiveFalse').addEventListener('click', function() {
        this.checked = true;
        document.getElementById('productActiveTrue').checked = false;
    });

    $(document).ready(function() {
        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        $('#parentCategory').on('change', function() {
            const selectedCategoryCode = $(this).val();
            const $childCategorySelect = $('#childCategory');

            // ì´ˆê¸°í™”
            $childCategorySelect.html('<option value="">í•˜ìœ„ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>');

            if (selectedCategoryCode) {
                const selectedCategory = categories.find(cat => cat.categoryCode === selectedCategoryCode);

                if (selectedCategory?.categoryDetailDto) {
                    selectedCategory.categoryDetailDto.forEach(detail => {
                        const option = `<option value="${detail.cateDetailCode}">${detail.cateDetailName}</option>`;
                        $childCategorySelect.append(option);
                    });
                }
            }
        });

        // íŒŒì¼ ê´€ë¦¬ë¥¼ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let thumbnailFiles = [];
        let detailFiles = [];

        // íŒŒì¼ ì—…ë¡œë“œ ì‹œ íŒŒì¼ëª… í‘œì‹œ
        $('.file-input').on('change', function() {
            const $label = $(this).next();
            const files = Array.from(this.files);
            const inputName = $(this).attr('name');

            if (files.length > 0) {
                if (inputName === 'thumbnails') {
                    // ê¸°ì¡´ íŒŒì¼ì— ìƒˆ íŒŒì¼ë“¤ ì¶”ê°€
                    files.forEach(file => {
                        if (!thumbnailFiles.some(f => f.name === file.name && f.size === file.size)) {
                            thumbnailFiles.push(file);
                        }
                    });
                    updateFileDisplay('thumbnailFiles', thumbnailFiles, 'thumbnails');
                    updateFileInput(this, thumbnailFiles);

                } else if (inputName === 'detailImages') {
                    // ê¸°ì¡´ íŒŒì¼ì— ìƒˆ íŒŒì¼ë“¤ ì¶”ê°€
                    files.forEach(file => {
                        if (!detailFiles.some(f => f.name === file.name && f.size === file.size)) {
                            detailFiles.push(file);
                        }
                    });
                    updateFileDisplay('detailFiles', detailFiles, 'detailImages');
                    updateFileInput(this, detailFiles);

                } else {
                    // ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ ì²˜ë¦¬
                    if (files.length === 1) {
                        $label.find('.file-text').text(files[0].name);
                    }
                    $label.css({
                        'border-color': '#212529',
                        'background': '#fff'
                    });
                }
            }
        });

        // íŒŒì¼ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFileDisplay(containerId, fileArray, inputName) {
            const $container = $('#' + containerId);
            $container.empty();

            fileArray.forEach((file, index) => {
                const fileItem =
                    '<div class="file-item">' +
                    '<span>' + file.name + '</span>' +
                    '<button type="button" class="file-remove" onclick="removeFile(\'' + inputName + '\', ' + index + ')">' +
                    '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">' +
                    '<path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' +
                    '</svg>' +
                    '</button>' +
                    '</div>';
                $container.append(fileItem);
            });
        }

        // íŒŒì¼ ì œê±° í•¨ìˆ˜
        window.removeFile = function(inputName, index) {
            if (inputName === 'thumbnails') {
                thumbnailFiles.splice(index, 1);
                updateFileDisplay('thumbnailFiles', thumbnailFiles, 'thumbnails');
                updateFileInput($('input[name="thumbnails"]')[0], thumbnailFiles);
            } else if (inputName === 'detailImages') {
                detailFiles.splice(index, 1);
                updateFileDisplay('detailFiles', detailFiles, 'detailImages');
                updateFileInput($('input[name="detailImages"]')[0], detailFiles);
            }
        };

        // File input ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFileInput(input, fileArray) {
            const dt = new DataTransfer();
            fileArray.forEach(file => dt.items.add(file));
            input.files = dt.files;

            // ë ˆì´ë¸” ì—…ë°ì´íŠ¸
            const $label = $(input).next();
            if (fileArray.length > 0) {
                $label.find('.file-text').text(`${fileArray.length}ê°œ íŒŒì¼ ì„ íƒë¨`);
                $label.css({
                    'border-color': '#212529',
                    'background': '#fff'
                });
            } else {
                const originalText = {
                    'thumbnails': 'ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ',
                    'detailImages': 'ìƒì„¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ'
                };
                $label.find('.file-text').text(originalText[$(input).attr('name')]);
                $label.css({
                    'border-color': '#dee2e6',
                    'background': '#f8f9fa'
                });
            }
        }

        // ìƒí’ˆ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $('#submitBtn').on('click', function() {
            // ì˜µì…˜ ë°ì´í„° ìˆ˜ì§‘
            const optionData = collectOptionData();

            let image = {
                titleImage: $('#titleImage')[0].files[0],
                titleImage2: $('#titleImage2')[0].files[0],
                thumbnails: $('#thumbnails')[0].files,
                detailImages: $('#detailImages')[0].files
            };

            let formData = new FormData();
            formData.append('titleImage', image.titleImage);
            formData.append('titleImage2', image.titleImage2);
            for(let i=0; i<image.thumbnails.length; i++) {
                formData.append('thumbnails[]', image.thumbnails[i]);
            }
            for(let i=0; i<image.detailImages.length; i++) {
                formData.append('detailImages[]', image.detailImages[i]);
            }

            $.ajax({
                url: '/admin/upload/images',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if(response.status) {
                        let formData = new FormData();

                        // productDto
                        let productDto = {
                            productId: $('#productCode').val(),
                            productName: $('#productName').val(),
                            productQuantity: $('#productQuantity').val(),
                            productDescription: $('#productDescription').val(),
                            productActive: document.querySelector('input[name="productActive"]:checked').value
                        };

                        // price
                        let price = {
                            priceCost: $('#priceCost').val(),
                            priceOriginal: $('#priceOriginal').val(),
                            priceSelling: $('#priceSelling').val()
                        };

                        // category
                        let category = {
                            categoryCode: $('#parentCategory').val()
                        };
                        let cateDetail = {
                            cateDetailCode : $('#childCategory').val()
                        };

                        // Add the JSON objects to FormData
                        formData.append('productDto', JSON.stringify(productDto));
                        formData.append('price', JSON.stringify(price));
                        formData.append('category', JSON.stringify(category));
                        formData.append('cateDetailCode', JSON.stringify(cateDetail));

                        // ì˜µì…˜ ë°ì´í„° ì¶”ê°€
                        formData.append('productOptions', JSON.stringify(optionData));

                        // Add images (if any)
                        let image = {
                            titleImage: $('#titleImage')[0].files[0],
                            titleImage2: $('#titleImage2')[0].files[0],
                            thumbnails: $('#thumbnails')[0].files,
                            detailImages: $('#detailImages')[0].files
                        };

                        if (image.titleImage) formData.append('titleImage', image.titleImage);
                        // titleImage2ëŠ” nullì¼ ìˆ˜ ìˆìŒ â†’ í•­ìƒ keyëŠ” ë„£ê³ , ì—†ìœ¼ë©´ ë¹ˆ Blob
                        formData.append('titleImage2', image.titleImage2 || new Blob());
                        if (image.thumbnails.length > 0) {
                            for (let i = 0; i < image.thumbnails.length; i++) {
                                formData.append('thumbnails[]', image.thumbnails[i]);
                            }
                        } else {
                            // thumbnails[] í‚¤ ë³´ì¥ (ë¹ˆ Blob ë˜ëŠ” ë¹ˆ íŒŒì¼)
                            formData.append('thumbnails[]', new Blob());
                        }
                        for (let i = 0; i < image.detailImages.length; i++) {
                            formData.append('detailImages[]', image.detailImages[i]);
                        }

                        $.ajax({
                            url: '/admin/upload/product',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                alert(response.message);
                                if (response.status) {
                                    window.location.href="/admin/add/product";
                                } else {
                                    // í¼ ì´ˆê¸°í™”
                                    $('#childCategory').val('');
                                    $('#parentCategory').val('');
                                    $('#productCode').val('');
                                    $('#productName').val('');
                                    $('#productQuantity').val('');
                                    $('#productDescription').val('');
                                    $('#titleImage').val('');
                                    $('#titleImage2').val('');
                                    $('#thumbnails').val('');
                                    $('#detailImages').val('');
                                    $('#priceCost').val('');
                                    $('#priceOriginal').val('');
                                    $('#priceSelling').val('');
                                    // ì˜µì…˜ ì´ˆê¸°í™”
                                    $('#optionList').empty();
                                    optionCounter = 0;
                                }
                            },
                            error: function(err) {
                                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨', err);
                            }
                        });
                    }
                },
                error: function(err) {
                    console.error('ì—…ë¡œë“œ ì‹¤íŒ¨', err);
                }
            });
        });

        $('#generateCodeBtn').on('click', function () {
            const code = $('#productCode').val();

            if (!code) {
                $('#duplicateCheck')
                    .text('ìƒí’ˆ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
                    .css({ color: 'red', display: 'block' });
                return;
            }

            $.ajax({
                url: '/admin/upload/is-product-code',
                type: 'POST',
                data: { productCode: code },
                success: function (response) {
                    if (response === false || response === 'false') {
                        $('#duplicateCheck')
                            .text('ì‚¬ìš© ê°€ëŠ¥í•œ ìƒí’ˆì½”ë“œì…ë‹ˆë‹¤.')
                            .css({ color: 'green', display: 'block' });
                    } else {
                        $('#duplicateCheck')
                            .text('ì¤‘ë³µëœ ìƒí’ˆì½”ë“œì…ë‹ˆë‹¤.')
                            .css({ color: 'red', display: 'block' });
                    }
                },
                error: function (err) {
                    console.error('ì¡°íšŒ ì‹¤íŒ¨:', err);
                    $('#duplicateCheck')
                        .text('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                        .css({ color: 'red', display: 'block' });
                }
            });
        });

        // ì¬ê³  ìˆ˜ëŸ‰ ê´€ë¦¬ ì´ˆê¸°í™”
        updateQuantityMode();

        // í†µí•© ì›ê°€ ì²´í¬ë°•ìŠ¤ í† ê¸€
        $('#uniformCostCheck').on('change', function() {
            const $inputGroup = $('#uniformCostInputGroup');

            if ($(this).is(':checked')) {
                $inputGroup.addClass('active');
            } else {
                $inputGroup.removeClass('active');
                $('#uniformCostInput').val('');
                // ì²´í¬ í•´ì œ ì‹œ ëª¨ë“  ì˜µì…˜ ì›ê°€ í•„ë“œë¥¼ ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
                $('.option-cost').prop('readonly', false).css('background', '#fff');
            }
        });

        // í†µí•© ì›ê°€ ì ìš© ë²„íŠ¼ í´ë¦­
        $('#applyCostBtn').on('click', function() {
            const uniformCost = $('#uniformCostInput').val();

            if (!uniformCost || uniformCost <= 0) {
                alert('ì˜¬ë°”ë¥¸ ì›ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ëª¨ë“  ì˜µì…˜ì˜ ì›ê°€ í•„ë“œì— ë™ì¼í•œ ê°’ ì ìš©
            $('.option-cost').val(uniformCost);

            alert('ëª¨ë“  ì˜µì…˜ì— ì›ê°€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });

        // í†µí•© ì›ê°€ ì…ë ¥ì°½ì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
        $('#uniformCostInput').on('keypress', function(e) {
            if (e.which === 13) {
                $('#applyCostBtn').click();
            }
        });
    });

    // ì˜µì…˜ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('#addOptionBtn').on('click', function() {
        addOption();
    });

    // ì˜µì…˜ ì¶”ê°€ í•¨ìˆ˜
    function addOption() {
        optionCounter++;
        const optionHtml =
            '<div class="option-item" data-option-index="' + optionCounter + '">' +
            '<div class="option-item-header">' +
            '<h4 class="option-item-title">ì˜µì…˜ ' + optionCounter + '</h4>' +
            '<button type="button" class="option-remove-btn" onclick="removeOption(' + optionCounter + ')">' +
            'ì œê±°' +
            '</button>' +
            '</div>' +
            '<div class="option-fields">' +
            '<div class="form-group">' +
            '<label class="form-label">' +
            'ì˜µì…˜ëª… <span class="required">*</span>' +
            '</label>' +
            '<input type="text" class="form-input option-name" placeholder="ì˜ˆ: ìƒ‰ìƒ, í¬ê¸°, ì¬ì§ˆ" required>' +
            '</div>' +
            '</div>' +
            '<div class="option-values-container">' +
            '<div class="option-values-header">' +
            '<span class="option-values-title">ì˜µì…˜ê°’ ì„¤ì •</span>' +
            '<button type="button" class="add-value-btn" onclick="addOptionValue(' + optionCounter + ')">' +
            'ê°’ ì¶”ê°€' +
            '</button>' +
            '</div>' +
            '<div class="option-values-list" id="optionValues-' + optionCounter + '">' +
            '<!-- ì˜µì…˜ê°’ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ì—­ -->' +
            '</div>' +
            '</div>' +
            '</div>';

        $('#optionList').append(optionHtml);

        // ì²« ë²ˆì§¸ ì˜µì…˜ê°’ ìë™ ì¶”ê°€
        addOptionValue(optionCounter);

        // ì¬ê³  ê´€ë¦¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
        updateQuantityMode();
    }

    // ì˜µì…˜ ì œê±° í•¨ìˆ˜
    function removeOption(optionIndex) {
        $('.option-item[data-option-index="' + optionIndex + '"]').remove();
        updateQuantityMode();
    }

    // ì˜µì…˜ê°’ ì¶”ê°€ í•¨ìˆ˜
    function addOptionValue(optionIndex) {
        const uniformCost = $('#uniformCostCheck').is(':checked') ? $('#uniformCostInput').val() || '' : '';

        const valueHtml =
            '<div class="option-value-item">' +
            '<input type="text" class="option-value-input option-value" ' +
            'placeholder="ì˜µì…˜ê°’ (ì˜ˆ: ë¹¨ê°•, Large)">' +
            '<input type="number" class="option-value-input option-price" ' +
            'placeholder="ì¶”ê°€ê¸ˆì•¡" min="0">' +
            '<input type="number" class="option-value-input option-cost" ' +
            'placeholder="ì›ê°€" min="0" value="' + uniformCost + '">' +
            '<input type="number" class="option-value-input option-quantity" ' +
            'placeholder="ì¬ê³ " min="0" onchange="updateTotalQuantity()">' +
            '<button type="button" class="remove-value-btn" onclick="removeOptionValue(this)">' +
            'ì œê±°' +
            '</button>' +
            '</div>';

        $('#optionValues-' + optionIndex).append(valueHtml);
    }

    // ì˜µì…˜ê°’ ì œê±° í•¨ìˆ˜
    function removeOptionValue(button) {
        $(button).closest('.option-value-item').remove();
        updateTotalQuantity();
    }

    // ì¬ê³  ê´€ë¦¬ ëª¨ë“œ ì—…ë°ì´íŠ¸
    function updateQuantityMode() {
        const hasOptionsNow = $('.option-item').length > 0;
        const $quantityInput = $('#productQuantity');
        const $quantityInfo = $('#quantityInfo');
        const $quantityStatus = $('#quantityStatus');
        const $quantityDetails = $('#quantityDetails');
        const $costInput = $('#priceCost');
        const $optionCostManagement = $('#optionCostManagement');

        if (hasOptionsNow) {
            // ì˜µì…˜ì´ ìˆëŠ” ê²½ìš°: readonly ëª¨ë“œ
            $quantityInput.prop('readonly', true);
            $costInput.prop('readonly', true).css('background', '#f8f9fa');
            $optionCostManagement.show();

            $quantityInfo.removeClass('total-quantity-info').addClass('total-quantity-info auto-calculated');
            $quantityStatus.removeClass('manual').addClass('auto').text('ìë™ ê³„ì‚° ëª¨ë“œ');
            $quantityDetails.text('ì˜µì…˜ë³„ ì¬ê³  ìˆ˜ëŸ‰ì˜ í•©ê³„ê°€ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.');

            // í˜„ì¬ ì´ ì¬ê³  ê³„ì‚°
            updateTotalQuantity();
        } else {
            // ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš°: ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ
            $quantityInput.prop('readonly', false);
            $costInput.prop('readonly', false).css('background', '#fff');
            $optionCostManagement.hide();

            $quantityInfo.removeClass('auto-calculated').addClass('total-quantity-info');
            $quantityStatus.removeClass('auto').addClass('manual').text('ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ');
            $quantityDetails.text('ì˜µì…˜ì´ ì—†ëŠ” ìƒí’ˆì˜ ê²½ìš° ì§ì ‘ ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');

            // ì…ë ¥ê°’ ì´ˆê¸°í™” (ì˜µì…˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ë  ë•Œ)
            if (hasOptions && !hasOptionsNow) {
                $quantityInput.val('');
            }
        }

        hasOptions = hasOptionsNow;
    }

    // ì´ ì¬ê³  ìˆ˜ëŸ‰ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
    function updateTotalQuantity() {
        if (!$('#productQuantity').prop('readonly')) return;

        let totalQuantity = 0;
        let optionCount = 0;

        $('.option-quantity').each(function() {
            const quantity = parseInt($(this).val()) || 0;
            totalQuantity += quantity;
            if (quantity > 0) optionCount++;
        });

        $('#productQuantity').val(totalQuantity);

        // ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸
        const $quantityDetails = $('#quantityDetails');
        if (optionCount > 0) {
            $quantityDetails.text('ì´ ' + optionCount + 'ê°œ ì˜µì…˜ì˜ ì¬ê³  í•©ê³„: ' + totalQuantity + 'ê°œ');
        } else {
            $quantityDetails.text('ì˜µì…˜ë³„ ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.');
        }
    }

    // ì˜µì…˜ ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
    function collectOptionData() {
        const options = [];

        $('.option-item').each(function() {
            const $optionItem = $(this);
            const optionName = $optionItem.find('.option-name').val().trim();

            if (optionName) {
                const optionValues = [];

                $optionItem.find('.option-value-item').each(function() {
                    const $valueItem = $(this);
                    const value = $valueItem.find('.option-value').val().trim();
                    const price = parseInt($valueItem.find('.option-price').val()) || 0;
                    const cost = parseInt($valueItem.find('.option-cost').val()) || 0;
                    const quantity = parseInt($valueItem.find('.option-quantity').val()) || 0;

                    if (value) {
                        optionValues.push({
                            optionValue: value,
                            optionPrice: price,
                            optionCost: cost,
                            optionQuantity: quantity
                        });
                    }
                });

                if (optionValues.length > 0) {
                    options.push({
                        optionName: optionName,
                        values: optionValues
                    });
                }
            }
        });

        return options;
    }
</script>
</body>
</html>