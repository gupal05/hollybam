<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>홀리밤</title>
  <!-- 설명 (검색 결과에 노출) -->
  <meta name="description" content="홀리밤은 리얼돌, 딜도, 콘돔, 러브젤 등 프리미엄 성인용품을 안전하게 빠른배송하는 온라인 성인용품 쇼핑몰입니다. 19세 이상만 이용 가능합니다.">

  <!-- 키워드 (큰 영향은 없지만 추가 가능) -->
  <meta name="keywords" content="성인용품, 리얼돌, 딜도, 러브젤, 콘돔, 성인쇼핑몰">

  <!-- Open Graph (SNS 공유 최적화) -->
  <meta property="og:title" content="홀리밤 - 성인용품 전문 쇼핑몰">
  <meta property="og:description" content="프리미엄 성인용품을 빠르게 배송받으세요.">
  <meta property="og:image" content="https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/images/hollybam_logo.webp">
  <meta property="og:url" content="https://holly-bam.com">

  <!-- 모바일 최적화 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">

  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"></noscript>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="preload" as="style" href="/css/intro.css" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/css/intro.css"></noscript>


  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "홀리밤",
      "url": "https://holly-bam.com",
      "logo": "https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/images/hollybam_logo.webp",
      "sameAs": [
        "https://www.instagram.com/holly._.bam",
        "https://www.youtube.com/@%ED%99%80%EB%A6%AC%EB%B0%A4"
      ]
    }
  </script>

</head>
<body>
<!-- 리뉴얼 안내 모달 -->
<div id="renewalModal" class="renewal-modal-overlay">
  <div class="renewal-modal">
    <div class="renewal-modal-header">
      <h1 class="visually-hidden">홀리밤 - 프리미엄 성인용품 쇼핑몰 | 리얼돌·딜도·러브젤 빠른배송</h1>
      <h2 class="renewal-modal-title">홀리밤</h2>
      <p class="renewal-modal-subtitle">홀리밤 서비스 리뉴얼 안내</p>
      <p class="renewal-modal-subtitle">더 나은 서비스를 위한 시스템 개선</p>
    </div>
    <div class="renewal-modal-body">
      <div class="renewal-modal-content">
        안녕하세요.<br>
        홀리밤을 이용해 주시는 고객님께 감사드립니다.
      </div>

      <div class="renewal-modal-highlight">
        <p class="renewal-modal-highlight-text">
          서비스 시스템 전면 리뉴얼로 인해<br>
          <strong>기존 회원님들도 신규 가입</strong>을 해주셔야 합니다.
        </p>
      </div>

      <div class="renewal-modal-content">
        보다 안전하고 편리한 서비스 제공을 위한<br>
        불가피한 조치임을 양해 부탁드립니다.
      </div>

      <p class="renewal-modal-apology">
        이용에 불편을 드려 진심으로 죄송합니다.
      </p>
    </div>
    <div class="renewal-modal-footer">
      <button class="renewal-modal-button" onclick="closeRenewalModal()">
        확인
      </button>
    </div>
  </div>
</div>

<!-- 메시지를 숨겨 놓음 -->
<div id="message" th:text="${session.message}" style="display: none;"></div>

<!-- 자바스크립트에서 안전하게 가져와 alert -->
<script>
  const msg = document.getElementById('message')?.textContent;
  if (msg) {
    alert(msg);
  }
</script>

<div class="container">
  <!-- 메시지 표시 영역 -->
  <div id="messageDiv" class="message"></div>
  <div id="loadingDiv" class="loading">본인인증을 진행중입니다...</div>

  <!-- 경고 안내 영역 -->
  <div class="section">
    <img th:src="'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/images/intro_he01-0000 (1).jpg'" alt="홀리밤 리얼돌 딜도 러브젤 콘돔 성인용품 쇼핑몰" width="100" height="100"
         loading="lazy">
    <p>
      이 정보내용은 청소년 유해매체물로서 정보통신망 이용촉진법 및<br>
      정보보호 등에 관한 법률 및 청소년 보호법의 규정에 의하여<br>
      <b>19세 미만의 청소년</b>은 사용할 수 없습니다.
    </p>
    <a href="javascript:history.back()" class="button">19세 미만 나가기</a>
  </div>

  <!-- 로그인 영역 -->
  <div class="section">
    <h3>회원 로그인</h3>
    <form id="loginForm">
      <input type="text" id="memberId" name="username" placeholder="아이디 입력" required>
      <input type="password" id="memberPw" name="password" placeholder="비밀번호 입력" required>
      <input type="submit" value="로그인">
    </form>

    <div class="social-buttons">
      <div style="cursor: pointer;" onclick="openNaverLogin()">
        <img th:src="'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/images/btnG_padded_320x40.png'" alt="홀리밤 네이버 로그인" style="margin: 0; width: 100%; height: 100%;">
      </div>
      <div style="cursor: pointer; display: none">
        <img th:src="'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/images/kakao_login_clean_320x40.png'" alt="홀리밤 카카오 로그인" style="margin: 0; width: 100%; height: 100%;">
      </div>
      <div id="g_id_signin"></div>

    </div>
  </div>

  <!-- 구분선 -->
  <div class="divider"></div>

  <form name="form_chk" method="post">
    <input type="hidden" name="m" value="service"/>
    <input type="hidden" name="token_version_id" th:value="${token.token_version_id}"/>
    <input type="hidden" name="enc_data" th:value="${token.enc_data}"/>
    <input type="hidden" name="integrity_value" th:value="${token.integrity_value}"/>
    <input type="hidden" name="auth_type" value="S"/>
  </form>

  <!-- 비회원 성인인증 -->
  <div class="section certify">
    <h3>비회원 성인인증</h3>
    <input type="button" value="휴대폰 인증 (NICE)" id="phoneAuthBtn" onclick="fnPopup()">
    <p>
      본인 명의의 휴대폰 또는 간편 인증 수단으로 본인인증을 진행합니다.<br>
      명의자의 나이 정보로 19세 미만 여부를 확인합니다.
    </p>
  </div>
  <div style="width: 100%; height: 1px; background-color: #eee;"></div>
  <div style="text-align:center; font-size:14px; color:#555; line-height:1.6; margin-top:40px;">
    <strong>홀리밤</strong>은 <b>성인용품 쇼핑몰</b>로 <b>리얼돌, 딜도, 러브젤, 콘돔</b> 등
    고품질 성인용 제품을 <b>안전하고 빠르게 배송</b>합니다.
    고객님의 프라이버시를 최우선으로 생각하며,
    19세 이상 성인만 이용 가능합니다.
  </div>
</div>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script>
  // 리뉴얼 모달 관련 스크립트 (FCP 최적화 및 중복 방지)
  window.renewalModalState = window.renewalModalState || {
    shown: false,
    timeoutId: null
  };

  function closeRenewalModal() {
    document.getElementById('renewalModal').style.display = 'none';
    window.renewalModalState.shown = false; // 새로고침 시 다시 보이게 하기 위함

    // timeout이 실행 중이면 취소
    if (window.renewalModalState.timeoutId) {
      clearTimeout(window.renewalModalState.timeoutId);
      window.renewalModalState.timeoutId = null;
    }
  }

  function showRenewalModal() {
    const modal = document.getElementById('renewalModal');

    // 이미 표시되었거나 현재 보이는 상태라면 중복 실행 방지
    if (window.renewalModalState.shown ||
            modal.style.display === 'flex' ||
            window.renewalModalState.timeoutId) {
      return;
    }

    // FCP 최적화를 위해 더 긴 지연 시간 적용
    window.renewalModalState.timeoutId = setTimeout(function () {
      // timeout 실행 시점에 다시 한번 체크
      if (!window.renewalModalState.shown && modal.style.display !== 'flex') {
        modal.style.display = 'flex';
        window.renewalModalState.shown = true;
      }
      window.renewalModalState.timeoutId = null;
    }, 1500); // FCP 개선을 위해 1.5초로 증가
  }

  // 페이지 로드 시 모달 표시 (FCP 고려)
  if (document.readyState === 'loading') {
    window.addEventListener('load', showRenewalModal);
  } else {
    // 이미 로드된 경우 즉시 실행
    showRenewalModal();
  }
</script>

<script>
  // 구글 로그인 관련 - 원상 복구
  window.addEventListener('load', function () {
    google.accounts.id.initialize({
      client_id: "92346439771-d4b0tga52c1klh9f0qnrc31h51i8vfqm.apps.googleusercontent.com",
      callback: handleCredentialResponse,
    });

    const isMobile = window.innerWidth <= 768;

    google.accounts.id.renderButton(
            document.getElementById("g_id_signin"),
            {
              theme: "outline",
              size: "large",
              width: isMobile ? window.innerWidth - 40 : 320, // 모바일에서는 동적 너비
              height: isMobile ? 56 : 40
            }
    );
  });

  // 창 크기 변경 시 버튼 재렌더링
  window.addEventListener('resize', function() {
    const googleButtonContainer = document.getElementById("g_id_signin");
    if (googleButtonContainer) {
      // 기존 버튼 제거
      googleButtonContainer.innerHTML = '';

      // 새로운 크기로 재렌더링
      const isMobile = window.innerWidth <= 768;
      google.accounts.id.renderButton(
              googleButtonContainer,
              {
                theme: "outline",
                size: "large",
                width: isMobile ? window.innerWidth - 40 : 320,
                height: isMobile ? 56 : 40
              }
      );
    }
  });

  function handleCredentialResponse(response) {
    console.log("ID 토큰:", response.credential);

    // 토큰 서버 전송
    $.ajax({
      type: "POST",
      url: "/auth/google-login",
      contentType: "application/json",
      data: JSON.stringify({ idToken: response.credential }),
      success: function (data) {
        console.log("구글 로그인 응답:", data);

        if (data.status === "existing_user") {
          // 기존 회원 - 바로 로딩 페이지로 이동
          window.location.href = data.redirectUrl; // /loading
        } else if (data.status === "new_user") {
          // 신규 회원 - 휴대폰 본인인증 팝업 열기
          openGooglePhoneVerification();
        } else {
          alert("구글 로그인 중 오류가 발생했습니다: " + data.message);
        }
      },
      error: function (xhr, status, error) {
        console.error("구글 로그인 오류:", xhr.responseText);
        alert("구글 로그인 실패: " + error);
      }
    });
  }

  function openGooglePhoneVerification() {
    const width = 500;
    const height = 700;
    const left = (window.innerWidth - width) / 2;
    const top = (window.innerHeight - height) / 2;

    window.open(
            '/google/phone-verification',
            'googlePhoneVerificationPopup',
            `width=${width},height=${height},left=${left},top=${top}`
    );
  }

  function openNaverLogin() {
    const width = 500;
    const height = 600;
    const left = (window.innerWidth - width) / 2;
    const top = (window.innerHeight - height) / 2;

    window.open(
            '/auth/login/naver',
            'naverLoginPopup',
            `width=${width},height=${height},left=${left},top=${top}`
    );
  }
</script>
<script th:inline="javascript">
  let authPopup = null;

  window.addEventListener("message", function (event) {
    if (event.data === "authSuccess") {
      //alert("성인인증이 완료되었습니다.");
      window.location.href = "/loading";
    } else if (event.data === "authFail") {
      alert("성인이 아닙니다. 인증이 제한됩니다. 아닌데");
      window.location.href = "/";
    }

    // 네이버 회원가입 관련 메시지 처리 (기존)
    else if (event.data === "naverRegistrationComplete") {
      console.log("네이버 회원가입 완료 - /loading으로 이동");
      window.location.href = "/loading";
    } else if (event.data === "naverRegistrationFailed") {
      console.log("네이버 회원가입 실패");
      // 현재 페이지 유지 (인트로 페이지)
    }
    // authPopupCallback에서 직접 온 메시지 처리 (새로 추가)
    else if (event.data === "naverAuthSuccess") {
      console.log("네이버 본인인증 성공 - 최종 처리 대기");
      // naverPhoneVerification에서 처리하도록 함
    } else if (event.data === "naverAuthFail") {
      console.log("네이버 본인인증 실패");
      alert("성인이 아닙니다. 인증이 제한됩니다.");
    }// 네이버 기존 회원 로그인 완료 처리 (새로 추가)
    else if (event.data === "naverLoginComplete") {
      console.log("네이버 기존 회원 로그인 완료 - /loading으로 이동");
      window.location.href = "/loading";
    } else if (event.data === "googleRegistrationComplete") {
      console.log("구글 회원가입 완료 - /loading으로 이동");
      window.location.href = "/loading";
    } else if (event.data === "googleRegistrationFailed") {
      console.log("구글 회원가입 실패");
    }

    // 팝업 닫기 시도
    if (authPopup && !authPopup.closed) {
      authPopup.close();
    }
  });

  function fnPopup() {
    const tokenVersionId = document.querySelector('input[name="token_version_id"]').value;
    const encData = document.querySelector('input[name="enc_data"]').value;
    const integrityValue = document.querySelector('input[name="integrity_value"]').value;

    if (!tokenVersionId || !encData || !integrityValue) {
      alert('인증에 필요한 토큰 정보가 부족합니다.');
      return false;
    }

    if (authPopup && !authPopup.closed) {
      authPopup.close();
    }

    authPopup = window.open('', 'popupChk',
            'width=480,height=812,top=100,left=' + (screen.width / 2 - 240) +
            ',fullscreen=no,menubar=no,status=no,toolbar=no,titlebar=yes,location=no,scrollbars=no');

    if (!authPopup) {
      alert('팝업 차단됨');
      return false;
    }

    document.form_chk.action = "https://nice.checkplus.co.kr/CheckPlusSafeModel/service.cb";
    document.form_chk.target = "popupChk";
    document.form_chk.submit();
  }

  /**
   * 기존 로그인 폼 처리 (완전히 유지)
   */
  $(document).ready(function () {
    // Thymeleaf 메시지 처리
    const errorMsg = /*[[${session.error}]]*/ null;
    const successMsg = /*[[${session.success}]]*/ null;

    if (errorMsg) {
      showMessage(errorMsg, 'error');
    }
    if (successMsg) {
      showMessage(successMsg, 'success');
    }

    $("#loginForm").submit(function (event) {
      event.preventDefault();

      const memberId = $("#memberId").val().trim();
      const memberPw = $("#memberPw").val().trim();

      if (!memberId || !memberPw) {
        alert("아이디와 비밀번호를 모두 입력해주세요.");
        return;
      }

      $.ajax({
        url: "/auth/loginResult",
        method: "POST",
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
        data: {
          memberId: memberId,
          memberPw: memberPw
        },
        success: function (res) {
          if (res.loginResult === true) {
            window.location.href = '/loading';
          } else {
            alert("아이디 또는 비밀번호를 확인해주세요.");
          }
        },
        error: function (xhr, status, error) {
          console.error("로그인 요청 중 오류 발생:", error);
          alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
        }
      });
    });
  });

  /**
   * 페이지 이탈 시 정리
   */
  window.addEventListener('beforeunload', function() {
    if (typeof resetAuthState === 'function') {
      resetAuthState();
    }
  });
</script>

</body>
</html>