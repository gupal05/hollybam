<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Ï£ºÎ¨∏ ÎÇ¥Ïó≠ - ÌôÄÎ¶¨Î∞§</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kit.fontawesome.com/69077b3f9d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/header.css}"/>
    <link rel="stylesheet" th:href="@{/css/footer.css}"/>
    <script type="text/javascript" th:src="@{/js/header.js}"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 140px 20px 60px;
            display: flex;
            gap: 30px;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î Í≥µÌÜµ Ïä§ÌÉÄÏùº */
        .sidebar {
            width: 280px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            height: fit-content;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 140px;
        }

        /* ÌöåÏõê ÌîÑÎ°úÌïÑ */
        .user-profile {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #EE386D, #ff6b9d);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 32px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(238, 56, 109, 0.3);
        }

        .user-name {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .user-grade {
            font-size: 14px;
            color: #EE386D;
            font-weight: 500;
        }

        /* ÎπÑÌöåÏõê ÌîÑÎ°úÌïÑ */
        .guest-profile {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #f0f0f0;
        }

        .guest-profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #9ca3af);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 28px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .guest-name {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .guest-status {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 15px;
        }

        /* ÌöåÏõê Î©§Î≤ÑÏã≠ ÏÉÅÌÉú */
        .membership-status {
            background: linear-gradient(135deg, #EE386D, #ff6b9d);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .membership-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .points-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .points-value {
            font-size: 16px;
            font-weight: 700;
        }

        /* ÎπÑÌöåÏõê ÌöåÏõêÍ∞ÄÏûÖ ÌîÑÎ°úÎ™®ÏÖò */
        .join-promotion {
            background: linear-gradient(135deg, #EE386D, #ff6b9d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .promotion-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .promotion-desc {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .join-btn {
            background: white;
            color: #EE386D;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-decoration: none;
            display: inline-block;
        }

        .join-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
            color: #EE386D;
        }

        /* Ï†ïÎ≥¥ ÏàòÏ†ï Î≤ÑÌäº (ÌöåÏõêÏö©) */
        .edit-profile-btn {
            background: linear-gradient(135deg, #EE386D, #ff6b9d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .edit-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(238, 56, 109, 0.4);
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î Î©îÎâ¥ */
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: #666;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #EE386D;
            color: white;
            transform: translateX(5px);
        }

        .sidebar-menu i {
            width: 20px;
            margin-right: 12px;
        }

        /* Î©îÏù∏ ÏΩòÌÖêÏ∏† */
        .main-content {
            flex: 1;
        }

        .page-header {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .orders-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
        }

        .filter-tab {
            padding: 12px 24px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            background: white;
            color: #666;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-tab.active,
        .filter-tab:hover {
            border-color: #EE386D;
            background: #EE386D;
            color: white;
        }

        .orders-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .orders-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* Ï£ºÎ¨∏ ÏïÑÏù¥ÌÖú */
        .order-item {
            border: 1px solid #e9ecef;
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .order-item:hover {
            box-shadow: 0 8px 25px rgba(238, 56, 109, 0.15);
            border-color: #EE386D;
        }

        .order-header {
            background: #f8f9fa;
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-info {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .order-number {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .order-date {
            font-size: 14px;
            color: #666;
        }

        .tracking-number {
            font-size: 14px;
            color: #EE386D;
            font-weight: 500;
            background: #fff5f7;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #EE386D;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .order-status.pending {
            background: #ffc107;
            color: #000;
        }

        .order-status.shipping {
            background: #17a2b8;
            color: white;
        }

        .order-status.delivered {
            background: #28a745;
            color: white;
        }

        .order-status.cancelled {
            background: #dc3545;
            color: white;
        }

        .order-body {
            padding: 25px;
        }

        .product-list {
            margin-bottom: 20px;
        }

        .product-item {
            display: flex;
            gap: 20px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .product-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .product-options {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .product-price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-quantity {
            font-size: 14px;
            color: #666;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: #EE386D;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .order-total {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            border-color: #EE386D;
            color: #EE386D;
        }

        .btn-primary {
            background: #EE386D;
            color: white;
            border-color: #EE386D;
        }

        .btn-primary:hover {
            background: #d1326a;
            border-color: #d1326a;
            color: white;
        }

        .btn-track {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }

        .btn-track:hover {
            background: #138496;
            border-color: #138496;
            color: white;
        }

        /* Îπà Ï£ºÎ¨∏ ÎÇ¥Ïó≠ */
        .empty-orders {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.7;
            color: #e9ecef;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .empty-desc {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .shop-now-btn {
            display: inline-block;
            background: #EE386D;
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .shop-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(238, 56, 109, 0.3);
            color: white;
        }

        /* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 40px;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .page-btn:hover,
        .page-btn.active {
            border-color: #EE386D;
            background: #EE386D;
            color: white;
        }

        /* Ï£ºÎ¨∏ Í≤ÄÏÉâ */
        .order-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            width: 200px;
        }

        .search-input:focus {
            outline: none;
            border-color: #EE386D;
        }

        .search-btn {
            padding: 8px 16px;
            background: #EE386D;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #d1326a;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                padding: 110px 20px 50px;
                gap: 24px;
            }

            .sidebar {
                width: 100%;
                position: static;
                padding: 24px;
            }

            .main-content {
                width: 100%;
            }
        }




        .mypage-order-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
            backdrop-filter: blur(2px);
        }

        .mypage-order-modal-content {
            background-color: #fff;
            margin: 3% auto;
            padding: 0;
            border-radius: 16px;
            width: 85%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .mypage-order-header {
            background: #ee386d;
            color: white;
            padding: 24px 28px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mypage-order-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .mypage-order-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .mypage-order-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .mypage-order-body {
            padding: 24px 28px 28px;
            background-color: #fafafa;
        }

        .mypage-section {
            margin-bottom: 24px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .mypage-section:last-child {
            margin-bottom: 0;
        }

        .mypage-section-title {
            background: linear-gradient(90deg, #f7fafc 0%, #edf2f7 100%);
            padding: 16px 20px;
            font-weight: 600;
            font-size: 15px;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            margin: 0;
        }

        .mypage-section-content {
            padding: 20px;
        }

        .mypage-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .mypage-info-grid:last-child {
            margin-bottom: 0;
        }

        .mypage-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .mypage-info-item:last-child {
            border-bottom: none;
        }

        .mypage-info-label {
            font-weight: 500;
            color: #64748b;
            font-size: 14px;
        }

        .mypage-info-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 14px;
            text-align: right;
        }

        .mypage-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mypage-status-pending { background-color: #fef3c7; color: #92400e; }
        .mypage-status-paid { background-color: #d1fae5; color: #065f46; }
        .mypage-status-preparing { background-color: #dbeafe; color: #1e40af; }
        .mypage-status-shipped { background-color: #e0e7ff; color: #3730a3; }
        .mypage-status-delivered { background-color: #f3e8ff; color: #6b21a8; }
        .mypage-status-cancelled { background-color: #fee2e2; color: #991b1b; }
        .mypage-status-refunded { background-color: #f3e8ff; color: #6b21a8; }

        .mypage-product-list {
            border-radius: 8px;
            overflow: hidden;
        }

        .mypage-product-item {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
            background: white;
            transition: background-color 0.2s;
        }

        .mypage-product-item:hover {
            background-color: #f8fafc;
        }

        .mypage-product-item:last-child {
            border-bottom: none;
        }

        .mypage-product-image {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 16px;
            border: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .mypage-product-info {
            flex: 1;
            min-width: 0;
        }

        .mypage-product-name {
            font-weight: 600;
            font-size: 15px;
            color: #1e293b;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .mypage-product-option {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 4px;
            background-color: #f1f5f9;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 4px;
        }

        .mypage-product-quantity {
            color: #475569;
            font-size: 13px;
            font-weight: 500;
            margin-top: 2px;
        }

        .mypage-product-price {
            text-align: right;
            min-width: 90px;
            flex-shrink: 0;
        }

        .mypage-unit-price {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 2px;
            text-decoration: line-through;
        }

        .mypage-total-price {
            font-weight: 700;
            font-size: 15px;
            color: #1e293b;
        }

        .mypage-payment-summary {
            background: #ee386d;
            border-radius: 10px;
            padding: 20px;
            color: white;
        }

        .mypage-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .mypage-summary-row:last-child {
            margin-bottom: 0;
        }

        .mypage-summary-row.final {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 12px;
            margin-top: 12px;
            font-weight: 700;
            font-size: 18px;
        }

        .mypage-address-text {
            line-height: 1.5;
            color: #374151;
        }

        .mypage-full-width {
            grid-column: 1 / -1;
        }

        .mypage-tracking-number {
            color: #EE386D;
            font-weight: 600;
            background: #fff5f7;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #EE386D;
            font-size: 13px;
            margin-top: 4px;
            display: inline-block;
        }

        .mypage-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .mypage-modal-btn {
            padding: 10px 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mypage-modal-btn:hover {
            border-color: #EE386D;
            color: #EE386D;
        }

        .mypage-modal-btn.btn-track {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }

        .mypage-modal-btn.btn-track:hover {
            background: #138496;
            border-color: #138496;
            color: white;
        }

        /* Í≥ÑÏ¢åÏ†ïÎ≥¥ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .account-info {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            cursor: pointer;
        }

        .account-info:hover {
            background: #f1f5f9;
        }

        .account-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
        }

        .account-details {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .account-holder {
            font-size: 14px;
            color: #64748b;
        }

        .copy-hint {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 8px;
        }

        .copy-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .container {
                padding: 100px 12px 40px;
                gap: 20px;
            }

            .sidebar {
                padding: 20px;
                border-radius: 12px;
            }

            .page-header {
                padding: 24px 20px;
                border-radius: 12px;
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 22px;
                margin-bottom: 8px;
            }

            .page-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .orders-content {
                padding: 20px;
                border-radius: 12px;
            }

            .filter-tabs {
                gap: 6px;
                justify-content: center;
                flex-wrap: wrap;
            }

            .filter-tab {
                padding: 8px 16px;
                font-size: 13px;
                border-radius: 16px;
            }

            .order-item {
                border-radius: 12px;
                margin-bottom: 16px;
            }

            .order-header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .order-info {
                width: 100%;
                flex-direction: column;
                gap: 6px;
                align-items: flex-start;
            }

            .order-number {
                font-size: 15px;
            }

            .order-date {
                font-size: 13px;
            }

            .order-status {
                align-self: flex-end;
                margin-top: -20px;
            }

            .order-body {
                padding: 20px;
            }

            .product-item {
                padding: 12px 0;
            }

            .product-image {
                width: 60px;
                height: 60px;
                border-radius: 8px;
            }

            .product-name {
                font-size: 15px;
                margin-bottom: 6px;
            }

            .product-options {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .product-price {
                font-size: 16px;
            }

            .product-quantity {
                font-size: 13px;
            }

            .order-total {
                font-size: 16px;
            }

            .order-actions {
                gap: 8px;
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
                border-radius: 6px;
            }

            /* Î™®Î∞îÏùº Î™®Îã¨ Ïä§ÌÉÄÏùº */
            .mypage-order-modal-content {
                width: 96%;
                margin: 2% auto;
                max-height: 90vh;
                border-radius: 12px;
            }

            .mypage-order-header {
                padding: 20px 24px;
                border-radius: 12px 12px 0 0;
            }

            .mypage-order-title {
                font-size: 18px;
            }

            .mypage-order-body {
                padding: 16px 20px 20px;
            }

            .mypage-section {
                margin-bottom: 16px;
                border-radius: 8px;
            }

            .mypage-section-title {
                padding: 12px 16px;
                font-size: 14px;
            }

            .mypage-section-content {
                padding: 16px;
            }

            .mypage-info-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 12px;
            }

            .mypage-info-item {
                padding: 8px 0;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .mypage-info-label {
                font-size: 13px;
            }

            .mypage-info-value {
                font-size: 14px;
                text-align: left;
                font-weight: 500;
            }

            .mypage-product-item {
                padding: 12px;
                flex-direction: row;
                align-items: flex-start;
                text-align: left;
            }

            .mypage-product-image {
                width: 50px;
                height: 50px;
                margin-right: 12px;
                margin-bottom: 0;
            }

            .mypage-product-name {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .mypage-product-option {
                font-size: 12px;
                padding: 1px 6px;
            }

            .mypage-product-quantity {
                font-size: 12px;
            }

            .mypage-product-price {
                text-align: right;
                margin-top: 0;
                min-width: 70px;
            }

            .mypage-unit-price {
                font-size: 11px;
            }

            .mypage-total-price {
                font-size: 14px;
            }

            .mypage-payment-summary {
                padding: 16px;
                border-radius: 8px;
            }

            .mypage-summary-row {
                font-size: 13px;
                margin-bottom: 8px;
            }

            .mypage-summary-row.final {
                font-size: 16px;
                padding-top: 10px;
                margin-top: 10px;
            }

            .mypage-modal-actions {
                margin-top: 16px;
                padding-top: 16px;
                gap: 8px;
            }

            .mypage-modal-btn {
                padding: 10px 16px;
                font-size: 13px;
                border-radius: 6px;
                flex: 1;
                text-align: center;
            }

            /* Í≥ÑÏ¢åÏ†ïÎ≥¥ Î™®Î∞îÏùº Ïä§ÌÉÄÏùº */
            .account-info {
                padding: 12px;
                margin-top: 12px;
                border-radius: 6px;
            }

            .account-title {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .account-details {
                font-size: 15px;
                margin-bottom: 3px;
            }

            .account-holder {
                font-size: 13px;
            }

            .copy-hint {
                font-size: 11px;
                margin-top: 6px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 100px 8px 30px;
                gap: 16px;
            }

            .sidebar {
                padding: 16px;
            }

            .page-header {
                padding: 20px 16px;
            }

            .orders-content {
                padding: 16px;
            }

            .order-header {
                padding: 12px 16px;
            }

            .order-body {
                padding: 16px;
            }

            .filter-tab {
                padding: 6px 12px;
                font-size: 12px;
            }

            .empty-icon {
                font-size: 50px;
            }

            .empty-title {
                font-size: 18px;
            }

            .empty-desc {
                font-size: 13px;
            }

            /* Î™®Îã¨ Ï∂îÍ∞Ä ÏµúÏ†ÅÌôî */
            .mypage-order-modal-content {
                width: 98%;
                margin: 1% auto;
            }

            .mypage-order-header {
                padding: 16px 20px;
            }

            .mypage-order-title {
                font-size: 16px;
            }

            .mypage-order-body {
                padding: 12px 16px 16px;
            }

            .mypage-section-content {
                padding: 12px;
            }

            .mypage-product-item {
                padding: 10px;
            }

            .account-info {
                padding: 10px;
            }

            .account-details {
                font-size: 14px;
            }
        }

        /* ÏÉÅÌíàÎ≥Ñ Ïï°ÏÖò Î≤ÑÌäº */
        .product-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .product-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .cancel-return-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(6px);
        }

        .cancel-return-modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .cancel-return-modal-header {
            background-color: #1a1a1a;
            color: white;
            padding: 24px 28px;
            border-radius: 16px 16px 0 0;
            position: relative;
        }

        .cancel-return-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .cancel-return-modal-close {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .cancel-return-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .cancel-return-modal-body {
            padding: 28px;
        }

        .cr-form-group {
            margin-bottom: 24px;
        }

        .cr-form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        .cr-form-select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background-color: #ffffff;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%23718096' d='M8 11L3 6h10z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
            font-family: inherit;
        }

        .cr-form-select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .cr-form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background-color: #ffffff;
            transition: all 0.2s ease;
            resize: vertical;
            min-height: 88px;
            font-family: inherit;
            line-height: 1.5;
        }

        .cr-form-textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .cr-form-textarea::placeholder {
            color: #a0aec0;
        }

        .cr-other-reason-group {
            display: none;
            margin-top: 12px;
        }

        .cr-notice-box {
            background-color: #f7fafc;
            border-left: 3px solid #3182ce;
            padding: 16px 20px;
            border-radius: 12px;
            margin: 24px 0;
        }

        .cr-notice-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .cr-notice-text {
            color: #4a5568;
            font-size: 13px;
            line-height: 1.5;
        }

        .cr-product-section {
            background-color: #ffffff;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
        }

        .cr-product-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 16px;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        .cr-product-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cr-product-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background-color: #f7fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .cr-product-item:hover {
            background-color: #edf2f7;
        }

        .cr-product-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: #3182ce;
            cursor: pointer;
        }

        .cr-product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid #e2e8f0;
        }

        .cr-product-info {
            flex: 1;
            min-width: 0;
        }

        .cr-product-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .cr-product-option {
            font-size: 12px;
            color: #718096;
            margin-bottom: 2px;
        }

        .cr-product-quantity {
            font-size: 12px;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .cr-product-price {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .cr-quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .cr-quantity-label {
            font-size: 12px;
            color: #4a5568;
            white-space: nowrap;
        }

        .cr-quantity-input {
            width: 50px;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
        }

        .cr-select-all {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: #edf2f7;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #cbd5e0;
        }

        .cr-select-all-checkbox {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: #3182ce;
            cursor: pointer;
        }

        .cr-select-all-label {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
            cursor: pointer;
        }

        .cr-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .cr-btn-cancel {
            flex: 1;
            padding: 14px 20px;
            border: 1.5px solid #e2e8f0;
            background-color: #ffffff;
            color: #4a5568;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        .cr-btn-cancel:hover {
            background-color: #f7fafc;
            border-color: #cbd5e0;
        }

        .cr-btn-submit {
            flex: 2;
            padding: 14px 20px;
            border: none;
            background-color: #1a1a1a;
            color: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        .cr-btn-submit:hover {
            background-color: #2d2d2d;
            transform: translateY(-1px);
        }

        .cr-btn-submit:disabled {
            background-color: #a0aec0;
            color: #ffffff;
            cursor: not-allowed;
            transform: none;
        }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .cancel-return-modal-content {
                margin: 8% auto;
                width: 92%;
                max-height: 85vh;
            }

            .cancel-return-modal-header {
                padding: 20px 24px;
            }

            .cancel-return-modal-title {
                font-size: 16px;
            }

            .cancel-return-modal-body {
                padding: 24px 20px;
            }

            .cr-form-group {
                margin-bottom: 20px;
            }

            .cr-product-section {
                padding: 16px;
                margin: 20px 0;
            }

            .cr-product-title {
                font-size: 13px;
                margin-bottom: 12px;
            }

            .cr-product-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .cr-product-info {
                width: 100%;
            }

            .cr-product-image {
                width: 50px;
                height: 50px;
            }

            .cr-quantity-control {
                width: 100%;
                justify-content: space-between;
                margin-left: 0;
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid #e2e8f0;
            }

            .cr-select-all {
                padding: 10px 12px;
                margin-bottom: 12px;
            }

            .cr-select-all-label {
                font-size: 13px;
            }

            .cr-product-name {
                font-size: 13px;
            }

            .cr-modal-actions {
                margin-top: 24px;
                gap: 10px;
            }

            .cr-btn-cancel,
            .cr-btn-submit {
                padding: 12px 16px;
                font-size: 13px;
            }
        }
        .cr-refund-summary {
            background: linear-gradient(135deg, #EE386D, #ff6b9d);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(238, 56, 109, 0.3);
        }

        .cr-refund-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            letter-spacing: -0.5px;
        }

        .cr-refund-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .refund-amount {
            font-size: 24px;
            font-weight: 700;
            color: white;
            letter-spacing: -1px;
        }

        .refund-message {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }

        /* Î™®Î∞îÏùº Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .cr-refund-summary {
                padding: 16px;
                margin-top: 16px;
                border-radius: 10px;
            }

            .cr-refund-title {
                font-size: 15px;
                margin-bottom: 12px;
            }

            .refund-amount {
                font-size: 20px;
            }

            .refund-message {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .cr-refund-summary {
                padding: 14px;
                margin-top: 14px;
            }

            .cr-refund-title {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .refund-amount {
                font-size: 18px;
            }

            .refund-message {
                font-size: 11px;
            }
        }

    </style>
</head>
<body>
<!-- Ìó§Îçî -->
<div th:replace="~{layout/header :: header}"></div>

<div class="container">
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <aside class="sidebar">
        <!-- ÌöåÏõêÏö© ÌîÑÎ°úÌïÑ -->
        <div th:if="${session.member != null}" class="user-profile">
            <div class="profile-image">
                <span th:text="${#strings.substring(session.member.memberName, 0, 1)}">Ìôç</span>
            </div>
            <div class="user-name" th:text="${session.member.memberName}">ÌôçÍ∏∏Îèô</div>
            <div class="user-grade">guest ÌöåÏõê</div>
            <button class="edit-profile-btn" onclick="changePage()">
                <i class="fas fa-edit"></i> Ï†ïÎ≥¥ ÏàòÏ†ï
            </button>
        </div>

        <!-- ÎπÑÌöåÏõêÏö© ÌîÑÎ°úÌïÑ -->
        <div th:unless="${session.member != null}" class="guest-profile">
            <div class="guest-profile-image">
                <i class="fas fa-user"></i>
            </div>
            <div class="guest-name">ÎπÑÌöåÏõê</div>
            <div class="guest-status">ÏûÑÏãú Ïù¥Ïö© Ï§ë</div>
        </div>

        <!-- ÌöåÏõêÏö© Î©§Î≤ÑÏã≠ ÏÉÅÌÉú -->
        <div th:if="${session.member != null}" class="membership-status">
            <div class="membership-title">Member Since 2025</div>
            <div class="points-info">
                <span class="points-label" th:text="'üéÅ Ïø†Ìè∞ ' + ${couponCount} + 'Í∞ú'">üéÅ Ïø†Ìè∞ 0Í∞ú</span>
                <span class="points-label" th:text="'üíé Ï†ÅÎ¶ΩÍ∏à '+ ${totalPoint} +'Ïõê'">üíé Ìè¨Ïù∏Ìä∏ 0Ïõê</span>
            </div>
        </div>

        <!-- ÎπÑÌöåÏõêÏö© ÌöåÏõêÍ∞ÄÏûÖ ÌîÑÎ°úÎ™®ÏÖò -->
        <div th:unless="${session.member != null}" class="join-promotion">
            <div class="promotion-title">üéâ ÌöåÏõêÍ∞ÄÏûÖ ÌäπÍ∞Ä!</div>
            <div class="promotion-desc">
                ÌöåÏõêÍ∞ÄÏûÖ Ïãú Ï¶âÏãú 5Ï≤úÏõê Ïø†Ìè∞Í≥º<br>
                Îã§ÏñëÌïú ÌòúÌÉùÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî
            </div>
            <a href="/auth/signup" class="join-btn">
                <i class="fas fa-user-plus"></i> ÌöåÏõêÍ∞ÄÏûÖÌïòÍ∏∞
            </a>
        </div>

        <!-- ÏÇ¨Ïù¥ÎìúÎ∞î Î©îÎâ¥ -->
        <ul class="sidebar-menu">
            <!-- ÌöåÏõêÏö© Î©îÎâ¥ -->
            <th:block th:if="${session.member != null}">
                <li><a href="/mypage" class="active"><i class="fas fa-user"></i>Í≥ÑÏ†ï Ï†ïÎ≥¥</a></li>
                <li><a href="/mypage/orders" class="active"><i class="fas fa-shopping-bag"></i>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</a></li>
                <li><a href="/mypage/review"><i class="fas fa-star"></i>ÏûëÏÑ±Ìïú Î¶¨Î∑∞</a></li>
                <li><a href="/wishlist"><i class="fas fa-heart"></i>ÏúÑÏãúÎ¶¨Ïä§Ìä∏</a></li>
                <li><a href="/mypage/coupons"><i class="fas fa-ticket-alt"></i>Ïø†Ìè∞Ìï®</a></li>
                <li><a href="/mypage/points"><i class="fas fa-coins"></i>Ï†ÅÎ¶ΩÍ∏à</a></li>
                <li><a onclick="logout()"><i class="fas fa-sign-out-alt"></i>Î°úÍ∑∏ÏïÑÏõÉ</a></li>
            </th:block>

            <!-- ÎπÑÌöåÏõêÏö© Î©îÎâ¥ -->
            <th:block th:unless="${session.member != null}">
                <li><a href="/mypage"><i class="fas fa-user"></i>ÎπÑÌöåÏõê Ï†ïÎ≥¥</a></li>
                <li><a href="/mypage/orders" class="active"><i class="fas fa-shopping-bag"></i>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</a></li>
                <li><a href="/mypage/review"><i class="fas fa-star"></i>ÏûëÏÑ±Ìïú Î¶¨Î∑∞</a></li>
                <li><a href="/wishlist"><i class="fas fa-heart"></i>ÏúÑÏãúÎ¶¨Ïä§Ìä∏</a></li>
                <li><a onclick="logout()"><i class="fas fa-sign-out-alt"></i>ÎπÑÌöåÏõê Î°úÍ∑∏ÏïÑÏõÉ</a></li>
            </th:block>
        </ul>
    </aside>

    <main class="main-content">
        <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
        <div class="page-header">
            <h1 class="page-title">Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h1>
            <p class="page-subtitle">Í≥†Í∞ùÎãòÏùò Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ ÌôïÏù∏ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</p>

            <!-- ÌïÑÌÑ∞ ÌÉ≠ -->
            <div class="filter-tabs">
                <a href="/mypage/orders" class="filter-tab" th:classappend="${param.status == null ? 'active' : ''}">Ï†ÑÏ≤¥</a>
                <a href="/mypage/orders?status=PAID" class="filter-tab" th:classappend="${param.status == 'PAID' ? 'active' : ''}">Í≤∞Ï†úÏôÑÎ£å</a>
                <a href="/mypage/orders?status=SHIPPED" class="filter-tab" th:classappend="${param.status == 'SHIPPED' ? 'active' : ''}">Î∞∞ÏÜ°Ï§ë</a>
                <a href="/mypage/orders?status=DELIVERED" class="filter-tab" th:classappend="${param.status == 'DELIVERED' ? 'active' : ''}">Î∞∞ÏÜ°ÏôÑÎ£å</a>
                <a href="/mypage/orders?status=CANCELLED" class="filter-tab" th:classappend="${param.status == 'CANCELLED' ? 'active' : ''}">Ï∑®ÏÜå</a>
                <a href="/mypage/orders?status=REFUNDED" class="filter-tab" th:classappend="${param.status == 'REFUNDED' ? 'active' : ''}">Î∞òÌíà</a>
            </div>
        </div>

        <!-- Ï£ºÎ¨∏ ÎÇ¥Ïó≠ ÏΩòÌÖêÏ∏† -->
        <div class="orders-content">
            <!-- Ï£ºÎ¨∏Ïù¥ ÏûàÎäî Í≤ΩÏö∞ -->
            <div th:if="${orderList != null and !orderList.isEmpty()}">
                <div class="order-item create-modal" th:each="order : ${orderList}">
                    <input type="hidden" th:value="${order.orderCode}" class="modal-order-code">
                    <input type="hidden" th:value="${order.orderId}" class="modal-order-id">
                    <div class="order-header">
                        <div class="order-info">
                            <div class="order-number" th:text="'Ï£ºÎ¨∏Î≤àÌò∏: ' + ${order.orderId}">Ï£ºÎ¨∏Î≤àÌò∏: HB20250617001</div>
                            <div class="order-date" th:text="${#temporals.format(order.createAt, 'yyyy.MM.dd HH:mm')}">...</div>
                            <!-- Ïö¥ÏÜ°Ïû• Î≤àÌò∏ ÌëúÏãú (Î∞∞ÏÜ°Ï§ëÏù¥ÎÇò Î∞∞ÏÜ°ÏôÑÎ£å ÏÉÅÌÉúÏùº ÎïåÎßå) -->
                            <div th:if="${order.deliveryDto != null and order.deliveryDto.trackingNumber != null and !#strings.isEmpty(order.deliveryDto.trackingNumber)}"
                                 class="tracking-number"
                                 th:text="'ÏÜ°Ïû•Î≤àÌò∏: ' + ${order.deliveryDto.trackingNumber}">
                                Ïö¥ÏÜ°Ïû•: 1234567890123
                            </div>
                        </div>
                        <div class="order-status" th:classappend="${order.orderStatus}" th:text="${order.orderStatus}">Î∞∞ÏÜ°Ï§ë</div>
                    </div>

                    <div class="order-body">
                        <div class="product-list">
                            <div class="product-item" th:each="item : ${order.orderItems}">
                                <div class="product-image">
                                    <img th:if="${item.productDto != null and item.productDto.imageDto != null}"
                                         th:src="@{'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/product/' + ${item.productDto.imageDto.imageUrl}}"
                                         th:alt="${item.productDto.productName}" />
                                </div>
                                <div class="product-details">
                                    <div class="product-name" th:text="${item.productDto.productName}">ÏÉÅÌíàÎ™Ö</div>
                                    <div class="product-options"
                                         th:text="${item.productOptionDto != null ? item.productOptionDto.optionName + ': ' + item.productOptionDto.optionValue : 'ÏòµÏÖò ÏóÜÏùå'}">ÏÉâÏÉÅ: Î∏îÎûô</div>
                                    <div class="product-price-info">
                                        <div class="product-price"
                                             th:text="'‚Ç©' + ${#numbers.formatInteger(item.unitPrice + item.optionPrice, 3, 'COMMA')}">‚Ç©15,000</div>
                                        <div class="product-quantity" th:text="'ÏàòÎüâ: ' + ${item.quantity} + 'Í∞ú'">ÏàòÎüâ: 1Í∞ú</div>
                                    </div>

                                    <!-- ÏÉÅÌíàÎ≥Ñ Ïï°ÏÖò Î≤ÑÌäº Ï∂îÍ∞Ä -->
                                    <div class="product-actions">
                                        <button class="btn btn-write-review"
                                                th:if="${order.orderStatus == 'Î∞∞ÏÜ°ÏôÑÎ£å' and item.reviewDto != null and !item.reviewDto.isReview}"
                                                th:id="'review-btn-' + ${item.orderItemCode}"
                                                th:attr="data-order-item-code=${item.orderItemCode},
                                                data-member-code=${session.member?.memberCode},
                                                data-guest-code=${session.member == null ? session.guest?.guestCode : null}">
                                            Î¶¨Î∑∞ ÏûëÏÑ±
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="order-footer">
                            <div class="order-total" th:text="'Ï¥ù Í≤∞Ï†úÍ∏àÏï°: ‚Ç©' + ${#numbers.formatInteger(order.finalAmount, 3, 'COMMA')} + ' (Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®)'">Ï¥ù Í≤∞Ï†úÍ∏àÏï°: ‚Ç©153,000 (Î∞∞ÏÜ°ÎπÑ Ìè¨Ìï®)</div>
                            <div class="order-actions">
                                <!-- Î∞∞ÏÜ°Ï°∞Ìöå Î≤ÑÌäº (Ïö¥ÏÜ°Ïû• Î≤àÌò∏Í∞Ä ÏûàÏùÑ ÎïåÎßå) -->
                                <button class="btn btn-track"
                                        th:if="${order.deliveryDto != null and order.deliveryDto.trackingNumber != null and !#strings.isEmpty(order.deliveryDto.trackingNumber)}"
                                        th:attr="data-tracking-number=${order.deliveryDto.trackingNumber}"
                                        onclick="trackDelivery(this)">
                                    <i class="fas fa-truck"></i> Î∞∞ÏÜ°Ï°∞Ìöå
                                </button>
                                <button class="btn" th:if="${order.orderStatus == 'Í≤∞Ï†úÏôÑÎ£å'}"
                                        th:attr="data-order-id=${order.orderId}"
                                        onclick="cancelOrder(this)">Ï£ºÎ¨∏Ï∑®ÏÜå</button>
                                <!-- Î¶¨Î∑∞ ÏûëÏÑ± Î≤ÑÌäº Ï†úÍ±∞Îê® -->
                                <button class="btn" th:if="${order.orderStatus == 'Î∞∞ÏÜ°ÏôÑÎ£å'}"
                                        th:attr="data-order-id=${order.orderId}"
                                        onclick="requestExchange(this)">ÍµêÌôò/Î∞òÌíà</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò (Ï£ºÎ¨∏Ïù¥ ÏûàÏùÑ ÎïåÎßå) -->
                <div class="pagination" th:if="${totalPages > 1}">
                    <a href="#" class="page-btn" th:if="${currentPage > 1}"
                       th:href="@{/mypage/orders(page=${currentPage - 1}, status=${param.status})}">‚Äπ</a>

                    <th:block th:each="page : ${#numbers.sequence(1, totalPages)}">
                        <a href="#" class="page-btn"
                           th:classappend="${page == currentPage ? 'active' : ''}"
                           th:href="@{/mypage/orders(page=${page}, status=${param.status})}"
                           th:text="${page}">1</a>
                    </th:block>

                    <a href="#" class="page-btn" th:if="${currentPage < totalPages}"
                       th:href="@{/mypage/orders(page=${currentPage + 1}, status=${param.status})}">‚Ä∫</a>
                </div>
            </div>

            <!-- Ï£ºÎ¨∏Ïù¥ ÏóÜÎäî Í≤ΩÏö∞ -->
            <div class="empty-orders" th:if="${orderList == null or orderList.isEmpty()}">
                <div class="empty-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="empty-title">Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§</div>
                <div class="empty-desc">
                    ÏïÑÏßÅ Ï£ºÎ¨∏ÌïòÏã† ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.<br>
                    ÌôÄÎ¶¨Î∞§Ïùò ÌäπÎ≥ÑÌïú ÏÉÅÌíàÎì§ÏùÑ ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî! ‚ú®
                </div>
                <a href="/main" class="shop-now-btn">
                    <i class="fas fa-rocket" style="margin-right: 8px;"></i>
                    ÏáºÌïë ÏãúÏûëÌïòÍ∏∞
                </a>
            </div>
        </div>
    </main>
</div>
<div id="mypageOrderModal" class="mypage-order-modal">
    <div class="mypage-order-modal-content">
        <!-- Î™®Îã¨ Ìó§Îçî -->
        <div class="mypage-order-header">
            <h3 class="mypage-order-title">Ï£ºÎ¨∏ ÏÉÅÏÑ∏Î≥¥Í∏∞</h3>
            <button class="mypage-order-close" onclick="closeMypageOrderModal()">&times;</button>
        </div>

        <!-- Î™®Îã¨ Î∞îÎîî -->
        <div class="mypage-order-body">
            <!-- Ï£ºÎ¨∏ Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
            <div class="mypage-section">
                <h4 class="mypage-section-title">Ï£ºÎ¨∏ Ï†ïÎ≥¥</h4>
                <div class="mypage-section-content">
                    <div class="mypage-info-grid">
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ï£ºÎ¨∏Î≤àÌò∏</span>
                            <span class="mypage-info-value">ORD20250710002</span>
                        </div>
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ï£ºÎ¨∏ÏùºÏãú</span>
                            <span class="mypage-info-value">2025.07.10 15:45</span>
                        </div>
                    </div>
                    <div class="mypage-info-grid">
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ï£ºÎ¨∏ÏÉÅÌÉú</span>
                            <span class="mypage-info-value">
                                <span class="mypage-status-badge mypage-status-shipped">Î∞∞ÏÜ°Ï§ë</span>
                            </span>
                        </div>
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Í≤∞Ï†úÎ∞©Î≤ï</span>
                            <span class="mypage-info-value">Ïπ¥Ïπ¥Ïò§ÌéòÏù¥</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ -->
            <div class="mypage-section">
                <h4 class="mypage-section-title">Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h4>
                <div class="mypage-section-content">
                    <div class="mypage-info-grid">
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ïù¥Î¶Ñ</span>
                            <span class="mypage-info-value">ÍπÄÌöåÏõê</span>
                        </div>
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ïó∞ÎùΩÏ≤ò</span>
                            <span class="mypage-info-value">010-9876-5432</span>
                        </div>
                    </div>
                    <div class="mypage-info-item">
                        <span class="mypage-info-label">Ïù¥Î©îÏùº</span>
                        <span class="mypage-info-value">kim@example.com</span>
                    </div>
                </div>
            </div>

            <!-- Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥ -->
            <div class="mypage-section">
                <h4 class="mypage-section-title">Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥</h4>
                <div class="mypage-section-content">
                    <div class="mypage-info-grid">
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">ÏàòÎ†πÏù∏</span>
                            <span class="mypage-info-value">ÍπÄÌöåÏõê</span>
                        </div>
                        <div class="mypage-info-item">
                            <span class="mypage-info-label">Ïó∞ÎùΩÏ≤ò</span>
                            <span class="mypage-info-value">010-9876-5432</span>
                        </div>
                    </div>
                    <div class="mypage-info-item mypage-full-width">
                        <span class="mypage-info-label">Î∞∞ÏÜ°Ï£ºÏÜå</span>
                        <span class="mypage-info-value mypage-address-text">(54321) Î∂ÄÏÇ∞Ïãú Ìï¥Ïö¥ÎåÄÍµ¨ Ìï¥Î≥ÄÎ°ú 456<br>Ïò§ÏÖòÌÉÄÏõå 12Ï∏µ</span>
                    </div>
                    <div class="mypage-info-item mypage-full-width">
                        <span class="mypage-info-label">Î∞∞ÏÜ° ÏöîÏ≤≠ÏÇ¨Ìï≠</span>
                        <span class="mypage-info-value">Î¨∏ ÏïûÏóê ÎÜìÍ≥† Î≤® ÎàåÎü¨Ï£ºÏÑ∏Ïöî</span>
                    </div>
                    <!-- Ïö¥ÏÜ°Ïû• Î≤àÌò∏ -->
                    <div class="mypage-info-item mypage-full-width">
                        <span class="mypage-info-label">Ïö¥ÏÜ°Ïû• Î≤àÌò∏</span>
                        <span class="mypage-info-value">
                            <span class="mypage-tracking-number">1234567890123</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Ï£ºÎ¨∏ ÏÉÅÌíà Î™©Î°ù -->
            <div class="mypage-section">
                <h4 class="mypage-section-title">Ï£ºÎ¨∏ ÏÉÅÌíà</h4>
                <div class="mypage-section-content">
                    <div class="mypage-product-list">
                        <div class="mypage-product-item">
                            <img src="https://via.placeholder.com/70" alt="ÏÉÅÌíà" class="mypage-product-image">
                            <div class="mypage-product-info">
                                <div class="mypage-product-name">Îü≠ÏÖîÎ¶¨ ÏÑ±Ïù∏Ïö©Ìíà ÌîÑÎ¶¨ÎØ∏ÏóÑ A+</div>
                                <div>
                                    <span class="mypage-product-option">Ïª¨Îü¨: Î°úÏ¶àÍ≥®Îìú</span>
                                    <span class="mypage-product-option">ÏÇ¨Ïù¥Ï¶à: Large</span>
                                </div>
                                <div class="mypage-product-quantity">ÏàòÎüâ: 1Í∞ú</div>
                            </div>
                            <div class="mypage-product-price">
                                <div class="mypage-unit-price">Ï†ïÍ∞Ä: 89,000Ïõê</div>
                                <div class="mypage-total-price">79,000Ïõê</div>
                            </div>
                        </div>

                        <div class="mypage-product-item">
                            <img src="https://via.placeholder.com/70" alt="ÏÉÅÌíà" class="mypage-product-image">
                            <div class="mypage-product-info">
                                <div class="mypage-product-name">ÌôÄÎ¶¨Î∞§ Î≤†Ïä§Ìä∏ ÏÑ±Ïù∏Ïö©Ìíà ÏÑ∏Ìä∏</div>
                                <div>
                                    <span class="mypage-product-option">ÌÉÄÏûÖ: Ïª§ÌîåÏö©</span>
                                    <span class="mypage-product-option">Ìå®ÌÇ§ÏßÄ: ÎîîÎü≠Ïä§</span>
                                </div>
                                <div class="mypage-product-quantity">ÏàòÎüâ: 1ÏÑ∏Ìä∏</div>
                            </div>
                            <div class="mypage-product-price">
                                <div class="mypage-unit-price">Ï†ïÍ∞Ä: 155,000Ïõê</div>
                                <div class="mypage-total-price">135,000Ïõê</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Í≤∞Ï†ú Ï†ïÎ≥¥ -->
            <div class="mypage-section">
                <h4 class="mypage-section-title">Í≤∞Ï†ú Ï†ïÎ≥¥</h4>
                <div class="mypage-section-content">
                    <div class="mypage-payment-summary">
                        <div class="mypage-summary-row">
                            <span>Ï¥ù ÏÉÅÌíàÍ∏àÏï°</span>
                            <span>214,000Ïõê</span>
                        </div>
                        <div class="mypage-summary-row">
                            <span>Ìï†Ïù∏</span>
                            <span>-14,000Ïõê</span>
                        </div>
                        <div class="mypage-summary-row">
                            <span>Î∞∞ÏÜ°ÎπÑ</span>
                            <span>Î¨¥Î£å</span>
                        </div>
                        <div class="mypage-summary-row final">
                            <span>ÏµúÏ¢Ö Í≤∞Ï†úÍ∏àÏï°</span>
                            <span>190,000Ïõê</span>
                        </div>
                    </div>

                    <!-- Î™®Îã¨ Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                    <div class="mypage-modal-actions">
                        <button class="mypage-modal-btn btn-track" onclick="trackDeliveryFromModal()">
                            <i class="fas fa-truck"></i> Î∞∞ÏÜ°Ï°∞Ìöå
                        </button>
                        <button id="cancelBtn" class="mypage-modal-btn" onclick="requestExchangeFromModal()">
                            Ï∑®ÏÜå/Î∞òÌíà
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="cancelReturnModal" class="cancel-return-modal">
    <div class="cancel-return-modal-content">
        <div class="cancel-return-modal-header">
            <h3 class="cancel-return-modal-title" id="cancelReturnModalTitle">Ï£ºÎ¨∏ Ï∑®ÏÜå Ïã†Ï≤≠</h3>
            <button class="cancel-return-modal-close" onclick="closeCancelReturnModal()">&times;</button>
        </div>
        <div class="cancel-return-modal-body">
            <form id="cancelReturnForm">
                <!-- Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ -->
                <input type="hidden" id="cr_orderCode" name="orderCode">
                <input type="hidden" id="cr_memberCode" name="memberCode">
                <input type="hidden" id="cr_guestCode" name="guestCode">
                <input type="hidden" id="cr_actionType" name="actionType">

                <!-- 1. Ï∑®ÏÜå/Î∞òÌíàÌï† ÏÉÅÌíà ÏÑ†ÌÉù -->
                <div class="cr-product-section" id="productSection">
                    <div class="cr-product-title">Ï∑®ÏÜå/Î∞òÌíàÌï† ÏÉÅÌíà ÏÑ†ÌÉù</div>
                    <div class="cr-product-list" id="productList">
                        <!-- ÏÉÅÌíà Î™©Î°ùÏù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                    </div>
                </div>

                <!-- 2. Ï∑®ÏÜå/Î∞òÌíà ÏÇ¨Ïú† ÏÑ†ÌÉù -->
                <div class="cr-form-group">
                    <label class="cr-form-label" id="reasonLabel">Ï∑®ÏÜå ÏÇ¨Ïú†</label>
                    <select class="cr-form-select" id="cancelReason" name="cancelReason" onchange="toggleOtherReason(); calculateRefundAmount();">
                        <option value="">ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                        <option value="Îã®ÏàúÎ≥ÄÏã¨">Îã®ÏàúÎ≥ÄÏã¨</option>
                        <option value="ÏÉÅÌíàÎ∂àÎüâ">ÏÉÅÌíàÎ∂àÎüâ</option>
                        <option value="ÏÇ¨Ïù¥Ï¶àÎ∂àÎßåÏ°±">ÏÇ¨Ïù¥Ï¶à Î∂àÎßåÏ°±</option>
                        <option value="ÏÉâÏÉÅÎ∂àÎßåÏ°±">ÏÉâÏÉÅ Î∂àÎßåÏ°±</option>
                        <option value="ÏÉÅÌíàÏÑ§Î™ÖÎ∂àÏùºÏπò">ÏÉÅÌíàÏÑ§Î™ÖÍ≥º Îã§Î¶Ñ</option>
                        <option value="ÌíàÏßàÎ∂àÎßåÏ°±">ÌíàÏßà Î∂àÎßåÏ°±</option>
                        <option value="Ï§ëÎ≥µÏ£ºÎ¨∏">Ï§ëÎ≥µÏ£ºÎ¨∏</option>
                        <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
                    </select>
                </div>

                <!-- Í∏∞ÌÉÄ ÏÇ¨Ïú† ÏûÖÎ†• (Í∏∞ÌÉÄ ÏÑ†ÌÉùÏãú ÌëúÏãú) -->
                <div class="cr-form-group cr-other-reason-group" id="otherReasonGroup">
                    <label class="cr-form-label">ÏÉÅÏÑ∏ ÏÇ¨Ïú†</label>
                    <textarea class="cr-form-textarea" id="otherReason" name="otherReason"
                              placeholder="Ï∑®ÏÜå ÏÇ¨Ïú†Î•º ÏÉÅÏÑ∏Ìûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." maxlength="200"></textarea>
                </div>

                <!-- 3. ÏïàÎÇ¥ ÏÇ¨Ìï≠ -->
                <div class="cr-notice-box">
                    <div class="cr-notice-title" id="noticeTitle">Ï∑®ÏÜå ÏïàÎÇ¥ÏÇ¨Ìï≠</div>
                    <div class="cr-notice-text" id="noticeText">
                        Ï∑®ÏÜå ÏöîÏ≤≠ ÏäπÏù∏ ÌõÑ ÏòÅÏóÖÏùº Í∏∞Ï§Ä 3~5Ïùº ÎÇ¥ ÌôòÎ∂à Ï≤òÎ¶¨Îê©ÎãàÎã§.
                    </div>
                </div>

                <!-- 4. ÌôòÎ∂à ÏòàÏ†ï Í∏àÏï° -->
                <div class="cr-refund-summary" id="refundSummary">
                    <div class="cr-refund-title">ÌôòÎ∂à ÏòàÏÉÅ Í∏àÏï°</div>
                    <div class="cr-refund-details">
                        <div class="refund-amount">‚Ç©0</div>
                        <div class="refund-message">ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
                    </div>
                </div>

                <!-- 5. Î≤ÑÌäº ÏòÅÏó≠ -->
                <div class="cr-modal-actions">
                    <button type="button" class="cr-btn-cancel" onclick="closeCancelReturnModal()">Ï∑®ÏÜå</button>
                    <button type="button" class="cr-btn-submit" id="submitBtn" onclick="submitCancelReturn()">Ï∑®ÏÜå Ïã†Ï≤≠ÌïòÍ∏∞</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ìë∏ÌÑ∞ -->
<div th:replace="~{layout/footer :: footer}"></div>

<script th:inline="javascript">
    /* ============================== */
    /*  Í≥µÌÜµ ÏÑ§Ï†ï (CSRF / Ïú†Ìã∏)       */
    /* ============================== */
    const RETURN_PICKUP_FEE = 3000;
    let currentModalOrderCode = null;     // Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Î™®Îã¨Ïóê Ïó¥Î†§ÏûàÎäî Ï£ºÎ¨∏ÏΩîÎìú
    let currentTrackingNumber = null;     // ÌòÑÏû¨ Î™®Îã¨Ïùò Ïö¥ÏÜ°Ïû•
    let currentOrderStatus = null;        // Ï£ºÎ¨∏ÏÉÅÌÉú(ÏòÅÎ¨∏/ÌïúÍ∏Ä ÌòºÏû¨ Í∞ÄÎä•)
    let currentOrderHeader = {
        totalAmount: 0,        // Ï¥ù ÏÉÅÌíàÍ∏àÏï°(Ìï†Ïù∏ Ï†Ñ)
        discountAmount: 0,     // Ï¥ù Ìï†Ïù∏Í∏àÏï°(Ïø†Ìè∞/Ï¶âÏãúÌï†Ïù∏ Îì±)
        deliveryFee: 0,        // ÏµúÏ¥à(ÏõêÏ£ºÎ¨∏) Î∞∞ÏÜ°ÎπÑ
        finalAmount: 0,        // ÏµúÏ¢Ö Í≤∞Ï†úÍ∏àÏï°(Ïõê Í≤∞Ï†úÍ∏àÏï°)
        usedCoupon: false,     // Ïø†Ìè∞ ÏÇ¨Ïö© Ïó¨Î∂Ä
        couponMinOrder: 10000  // Ïø†Ìè∞ ÏµúÏÜåÏ£ºÎ¨∏Í∏àÏï°(ÏÑúÎ≤Ñ ÏùëÎãµ ÏûàÏúºÎ©¥ ÎçÆÏñ¥ÏîÄ)
    };

    let currentActionType = 'cancel';     // 'cancel' | 'return' (Ï∑®ÏÜå/Î∞òÌíà Î™®Îã¨)
    let currentOrderProducts = [];        // Ï∑®ÏÜå/Î∞òÌíà Î™®Îã¨ÏóêÏÑú ÏÇ¨Ïö©Ìï† ÏÉÅÌíàÎ™©Î°ù(ÌôòÎ∂àÍ∞ÄÎä• ÏàòÎüâ Ìè¨Ìï®)
    let totalProductsCount = 0;           // Ï∑®ÏÜå/Î∞òÌíà Î™®Îã¨ÏóêÏÑúÏùò Ï†ÑÏ≤¥ ÏÉÅÌíàÍ∞úÏàò
    let totalOrderAmount = 0;             // Ï∑®ÏÜå/Î∞òÌíà Î™®Îã¨ÏóêÏÑúÏùò Ï¥ù ÏÉÅÌíàÍ∏àÏï°(Ìó§Îçî Ïö∞ÏÑ†)

    const DELIVERY_FEE = 3000;
    const FREE_DELIVERY_THRESHOLD = 50000;

    function getCSRFToken() {
        const el = document.querySelector('meta[name="_csrf"]');
        return el ? el.getAttribute('content') : '';
    }
    function getCSRFHeader() {
        const el = document.querySelector('meta[name="_csrf_header"]');
        return el ? el.getAttribute('content') : 'X-CSRF-TOKEN';
    }

    $(function () {
        // Î™®Îì† jQuery AJAXÏóê CSRF ÏûêÎèô Ï£ºÏûÖ
        const token  = getCSRFToken();
        const header = getCSRFHeader();
        $.ajaxSetup({
            beforeSend: function (xhr) { xhr.setRequestHeader(header, token); }
        });

        // ÏÇ¨Ïù¥ÎìúÎ∞î ÌôúÏÑ±Ìôî
        const currentPath = window.location.pathname;
        $('.sidebar-menu a').removeClass('active');
        $(`.sidebar-menu a[href="${currentPath}"]`).addClass('active');

        // ÌïÑÌÑ∞ ÌÉ≠ ÌôúÏÑ±Ìôî
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        $('.filter-tab').removeClass('active');
        if (!status) $('.filter-tab[href="/mypage/orders"]').addClass('active');
        else $(`.filter-tab[href="/mypage/orders?status=${status}"]`).addClass('active');

        // Ï£ºÎ¨∏ Í∞úÏàò
        updateOrdersCount();

        // Í≤ÄÏÉâ
        $('.search-input').on('keypress', function (e) { if (e.which === 13) performSearch(); });
        $('.search-btn').on('click', performSearch);

        // Î™®Î∞îÏùº ÌÑ∞Ïπò Ïä§ÌÉÄÏùº
        $('.order-item').on('touchstart', function(){ $(this).addClass('touch-hover'); })
            .on('touchend',   function(){ $(this).removeClass('touch-hover'); });

        // Ï£ºÎ¨∏ Ïπ¥Îìú ÌÅ¥Î¶≠ ‚Üí Ï£ºÎ¨∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ Î™®Îã¨ Ïò§Ìîà
        $(document).on('click', '.create-modal', function () {
            const orderCode = $(this).find('.modal-order-code').val();
            const orderId   = $(this).find('.modal-order-id').val();
            currentModalOrderCode = orderCode;

            $.ajax({
                url: 'order/detail/' + encodeURIComponent(orderId),
                method: 'GET',
                data: { orderCode: orderCode },
                success: function (response) {
                    if (response.message) {
                        // ÏÑúÎ≤Ñ: response.orderListDto (Î∞∞Ïó¥) Í∏∞Ï§Ä
                        openMypageOrderModal(response.orderListDto);
                    } else {
                        alert('Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                },
                error: function (xhr, s, e) {
                    console.error('ÏóêÎü¨ Î∞úÏÉù:', e);
                    alert('Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            });
        });

        // Î¶¨Î∑∞ Î≤ÑÌäº(ÏûàÏúºÎ©¥)
        document.querySelectorAll('.btn-write-review').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();
                const orderItemCode = this.dataset.orderItemCode;
                const memberCode    = this.dataset.memberCode;
                const guestCode     = this.dataset.guestCode;
                fetch('/review/check-eligibility', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json', [getCSRFHeader()]:getCSRFToken()},
                    body: JSON.stringify({ orderItemCode, memberCode, guestCode })
                })
                    .then(r=>r.json()).then(data=>{
                    if (data.eligible) location.href = `/review/write?orderItemCode=${orderItemCode}`;
                    else alert(data.message || 'Ïù¥ÎØ∏ Î¶¨Î∑∞Î•º ÏûëÏÑ±ÌïòÏÖ®Í±∞ÎÇò, Ï°∞Í±¥Ïù¥ Ï∂©Ï°±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }).catch(err=>{
                    console.error(err);
                    alert('Î¶¨Î∑∞ ÏûëÏÑ± Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                });
            });
        });
    });

    /* ============================== */
    /*  Í≤ÄÏÉâ/ÏßëÍ≥Ñ                      */
    /* ============================== */
    function updateOrdersCount() {
        const visibleOrders = $('.order-item:visible').length;
        $('.orders-info strong').text(visibleOrders);
    }
    function performSearch() {
        const q = ($('.search-input').val() || '').toLowerCase().trim();
        if (!q) { $('.order-item').show(); updateOrdersCount(); return; }
        $('.order-item').each(function(){
            const orderNumber = $(this).find('.order-number').text().toLowerCase();
            const productNames = $(this).find('.product-name').map(function(){ return $(this).text().toLowerCase(); }).get().join(' ');
            if (orderNumber.includes(q) || productNames.includes(q)) $(this).show(); else $(this).hide();
        });
        updateOrdersCount();
    }

    /* ============================== */
    /*  Ï£ºÎ¨∏ ÏÉÅÏÑ∏Î≥¥Í∏∞ Î™®Îã¨             */
    /*  (ÎßàÌÅ¨ÏóÖ Ïú†ÏßÄ, Í∞íÎßå Î∞îÍøîÏπòÍ∏∞)   */
    /* ============================== */
    function openMypageOrderModal(list) {
        if (!list || !list.length) return;
        const m = document.getElementById('mypageOrderModal');
        if (!m) return;
        m.style.display = 'block';
        document.body.style.overflow = 'hidden';

        const first = list[0];

        // ÏÉÅÌÉú/Ìó§Îçî Î≥¥Í¥Ä
        currentTrackingNumber      = first.trackingNumber || null;
        currentOrderStatus         = (first.orderStatus || first.simpleStatus || '').toUpperCase();
        currentOrderHeader.totalAmount     = Number(first.totalAmount || 0);
        currentOrderHeader.discountAmount  = Number(first.discountAmount || 0);
        currentOrderHeader.deliveryFee     = Number(first.deliveryFee || 0);
        currentOrderHeader.finalAmount     = Number(first.finalAmount || 0);
        if (typeof first.usedCoupon !== 'undefined') currentOrderHeader.usedCoupon = !!first.usedCoupon;
        if (typeof first.couponMinOrder !== 'undefined' && first.couponMinOrder !== null) {
            currentOrderHeader.couponMinOrder = Number(first.couponMinOrder);
        }

        // ÎÇ†Ïßú
        const createdAt = new Date(first.createAt);
        const orderDate = `${createdAt.getFullYear()}.${String(createdAt.getMonth()+1).padStart(2,'0')}.${String(createdAt.getDate()).padStart(2,'0')} ${String(createdAt.getHours()).padStart(2,'0')}:${String(createdAt.getMinutes()).padStart(2,'0')}`;

        // ÏÉÅÌÉú Î±ÉÏßÄ
        const statusTextMap  = {PENDING:'Í≤∞Ï†úÎåÄÍ∏∞',PAID:'Í≤∞Ï†úÏôÑÎ£å',SHIPPED:'Î∞∞ÏÜ°Ï§ë',DELIVERED:'Î∞∞ÏÜ°ÏôÑÎ£å',CANCELLED:'Ï∑®ÏÜå',REFUNDED:'Î∞òÌíà'};
        const statusClassMap = {PENDING:'mypage-status-paid',PAID:'mypage-status-paid',SHIPPED:'mypage-status-shipped',DELIVERED:'mypage-status-delivered',CANCELLED:'mypage-status-cancelled',REFUNDED:'mypage-status-refunded'};
        const badgeHtml = `<span class="mypage-status-badge ${statusClassMap[currentOrderStatus]||''}">${statusTextMap[currentOrderStatus]||first.orderStatus||''}</span>`;

        // ÎùºÎ≤® Í∏∞Î∞òÏúºÎ°ú Í∞í ÏÑ∏ÌåÖ
        setInfoValueByLabel(m, 'Ï£ºÎ¨∏Î≤àÌò∏', first.orderId || '');
        setInfoValueByLabel(m, 'Ï£ºÎ¨∏ÏùºÏãú', orderDate);
        setInfoValueByLabel(m, 'Ï£ºÎ¨∏ÏÉÅÌÉú', badgeHtml);
        setInfoValueByLabel(m, 'Í≤∞Ï†úÎ∞©Î≤ï', first.paymentMethod === 'card' ? 'Ïπ¥ÎìúÍ≤∞Ï†ú' : 'Î¨¥ÌÜµÏû•ÏûÖÍ∏à');

        setInfoValueByLabel(m, 'Ïù¥Î¶Ñ',     first.ordererName || '');
        setInfoValueByLabel(m, 'Ïó∞ÎùΩÏ≤ò',   first.ordererPhone || '');
        setInfoValueByLabel(m, 'Ïù¥Î©îÏùº',   first.ordererEmail || '');

        setInfoValueByLabel(m, 'ÏàòÎ†πÏù∏',   first.receiverName || '');
        setInfoValueByLabel(m, 'Ïó∞ÎùΩÏ≤ò',   first.receiverPhone || '');
        setInfoValueByLabel(m, 'Î∞∞ÏÜ°Ï£ºÏÜå', `${first.receiverAddr||''} ${first.receiverAddrDetail||''}`.trim());
        if (first.deliveryMemo) setInfoValueByLabel(m, 'Î∞∞ÏÜ° ÏöîÏ≤≠ÏÇ¨Ìï≠', first.deliveryMemo);
        if (first.trackingNumber) {
            setInfoValueByLabel(m, 'Ïö¥ÏÜ°Ïû• Î≤àÌò∏', `<span class="mypage-tracking-number">${first.trackingNumber}</span>`);
            const btn = m.querySelector('.mypage-modal-actions .btn-track');
            if (btn) btn.style.display = '';
        } else {
            setInfoValueByLabel(m, 'Ïö¥ÏÜ°Ïû• Î≤àÌò∏', '');
            const btn = m.querySelector('.mypage-modal-actions .btn-track');
            if (btn) btn.style.display = 'none';
        }

        // ÏÉÅÌíà Î¶¨Ïä§Ìä∏ (placeholder ÍµêÏ≤¥)
        const listEl = m.querySelector('.mypage-product-list');
        if (listEl) {
            listEl.innerHTML = list.map(it => {
                const img = resolveProductImageUrl(
                    it.imageUrl
                    || it.image_url
                    || (it.productDto && it.productDto.imageDto && it.productDto.imageDto.imageUrl)
                    || it.thumbnailUrl
                    || it.thumbnail_url
                    || it.image
                    || it.productImage
                );
                const opt = it.optionName ? `
        <div>
          <span class="mypage-product-option">${it.optionName}: ${it.optionValue || ''}</span>
        </div>` : '<div></div>';
                const qty   = Number(it.quantity||0);
                const unit  = Number((it.unitPrice||0) + (it.optionPrice||0));
                const total = Number(it.totalPrice ?? unit * qty);
                return `
        <div class="mypage-product-item">
          <img
  src="${img}"
  alt="ÏÉÅÌíà"
  class="mypage-product-image"
  onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=No+Image';"
/>
          <div class="mypage-product-info">
            <div class="mypage-product-name">${it.productName || ''}</div>
            ${opt}
            <div class="mypage-product-quantity">ÏàòÎüâ: ${qty}Í∞ú</div>
          </div>
          <div class="mypage-product-price">
            <div class="mypage-unit-price">Ï†ïÍ∞Ä: ${unit.toLocaleString()}Ïõê</div>
            <div class="mypage-total-price">${total.toLocaleString()}Ïõê</div>
          </div>
        </div>`;
            }).join('');
        }

        // Í≤∞Ï†ú ÏöîÏïΩ
        setSummaryValueByLabel(m, 'Ï¥ù ÏÉÅÌíàÍ∏àÏï°',      (Number(first.totalAmount  ||0)).toLocaleString()+'Ïõê');
        setSummaryValueByLabel(m, 'Ìï†Ïù∏',            '-'+(Number(first.discountAmount||0)).toLocaleString()+'Ïõê');
        setSummaryValueByLabel(m, 'Î∞∞ÏÜ°ÎπÑ',           (Number(first.deliveryFee||0)===0?'Î¨¥Î£å':Number(first.deliveryFee).toLocaleString()+'Ïõê'));
        setSummaryValueByLabel(m, 'ÏµúÏ¢Ö Í≤∞Ï†úÍ∏àÏï°',     (Number(first.finalAmount ||0)).toLocaleString()+'Ïõê');

        // Î™®Îã¨ ÌïòÎã® Î≤ÑÌäº Î¨∏Íµ¨ Ï°∞Ï†ï
        const cancelBtn = m.querySelector('#cancelBtn');
        if (cancelBtn) {
            if (currentOrderStatus === 'SHIPPED' || currentOrderStatus === 'DELIVERED') cancelBtn.textContent = 'Î∞òÌíà';
            else cancelBtn.textContent = 'Ï∑®ÏÜå/Î∞òÌíà';
        }
    }
    function closeMypageOrderModal() {
        const m = document.getElementById('mypageOrderModal');
        if (m) m.style.display = 'none';
        document.body.style.overflow = 'auto';
        currentTrackingNumber = null;
        currentModalOrderCode = null;
    }
    window.addEventListener('click', function (e) {
        const m = document.getElementById('mypageOrderModal');
        if (e.target === m) closeMypageOrderModal();
    });
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeMypageOrderModal();
    });

    /* ÎùºÎ≤®Î°ú Í∞í Î∞îÍæ∏Îäî Ìó¨Ìçº */
    function setInfoValueByLabel(modal, labelText, html) {
        modal.querySelectorAll('.mypage-info-item').forEach(item => {
            const label = item.querySelector('.mypage-info-label');
            if (label && label.textContent.trim() === labelText) {
                const val = item.querySelector('.mypage-info-value');
                if (val) val.innerHTML = html ?? '';
            }
        });
    }
    function setSummaryValueByLabel(modal, labelText, valueText) {
        modal.querySelectorAll('.mypage-payment-summary .mypage-summary-row').forEach(row => {
            const key = row.querySelector('span:first-child');
            const val = row.querySelector('span:last-child');
            if (key && key.textContent.trim() === labelText && val) val.textContent = valueText ?? '';
        });
    }

    function extractImageKey(p) {
        if (!p || typeof p !== 'object') return '';

        // 1) ÏÉÅÏúÑ ÌïÑÎìúÎì§
        let cand = p.imageUrl || p.image_url || p.image ||
            p.thumbnailUrl || p.thumbnail_url || p.thumbnail ||
            p.imagePath || p.image_key || p.fileName || p.filename;

        // 2) Ï§ëÏ≤©(DTO) ÌïÑÎìúÎì§
        if (!cand && p.imageDto && p.imageDto.imageUrl) cand = p.imageDto.imageUrl;
        if (!cand && p.productDto && p.productDto.imageDto && p.productDto.imageDto.imageUrl) {
            cand = p.productDto.imageDto.imageUrl;
        }
        if (!cand && p.productDto && p.productDto.imageUrl) cand = p.productDto.imageUrl;

        return cand || '';
    }

    const IMG_BASE = 'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com';

    function resolveProductImageUrl(raw) {
        const PLACEHOLDER = 'https://via.placeholder.com/70?text=No+Image';
        if (!raw) return PLACEHOLDER;
        if (typeof raw !== 'string') raw = String(raw);
        raw = raw.trim();
        if (!raw) return PLACEHOLDER;

        // Ïù¥ÎØ∏ Ï†àÎåÄ URLÏù¥Î©¥ Í∑∏ÎåÄÎ°ú
        if (/^https?:\/\//i.test(raw)) return raw;

        // ÏÑ†Ìñâ Ïä¨ÎûòÏãú Ï†úÍ±∞
        raw = raw.replace(/^\/+/, '');
        // Ïù¥ÎØ∏ 'product/'Î°ú ÏãúÏûëÌïòÎ©¥ Ìïú Î≤àÎßå Î∂ôÏûÑ
        if (raw.startsWith('product/')) return `${IMG_BASE}/${raw}`;

        return `${IMG_BASE}/product/${raw}`;
    }

    /* ============================== */
    /*  Ï£ºÎ¨∏ Ïπ¥Îìú ÎÇ¥ Î≤ÑÌäºÎì§           */
    /* ============================== */
    function changePage(){ location.href = '/mypage/profile/edit'; }

    function cancelOrder(btn){
        event.stopPropagation();
        const orderItem = btn.closest('.order-item');
        const orderCode = orderItem.querySelector('.modal-order-code').value;
        openCancelReturnModal('cancel', orderCode);
    }

    function requestExchange(btn){
        event.stopPropagation();
        const orderItem = btn.closest('.order-item');
        const orderCode = orderItem.querySelector('.modal-order-code').value;
        openCancelReturnModal('return', orderCode);
    }

    function requestExchangeFromModal(){
        ÏÉÅÏÑ∏ Î™®Îã¨ ÌïòÎã® Î≤ÑÌäº > ÌòÑÏû¨ Î™®Îã¨Ïùò orderCode ÏÇ¨Ïö©
        const orderCode = currentModalOrderCode;
        if (!orderCode) { alert('Ï£ºÎ¨∏ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); return; }
        let actionType = 'cancel';
        if (currentOrderStatus === 'SHIPPED' || currentOrderStatus === 'DELIVERED') actionType = 'return';
        openCancelReturnModal(actionType, orderCode);
    }

    function trackDelivery(btn){
        event.stopPropagation();
        const trackingNumber = btn.getAttribute('data-tracking-number');
        if (trackingNumber) window.location.href = "https://trace.cjlogistics.com/next/tracking.html?wblNo="+trackingNumber;
        else alert('Î∞∞ÏÜ°Ï°∞Ìöå Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
    }
    function trackDeliveryFromModal(){
        if (currentTrackingNumber) window.location.href = "https://trace.cjlogistics.com/next/tracking.html?wblNo="+currentTrackingNumber;
        else alert('Î∞∞ÏÜ°Ï°∞Ìöå Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
    }

    /* ============================== */
    /*  Ï∑®ÏÜå/Î∞òÌíà Î™®Îã¨                */
    /* ============================== */
    function openCancelReturnModal(actionType, orderCode){
        currentActionType = actionType;
        // ÌÉÄÏù¥ÌãÄ/ÎùºÎ≤®
        const title = document.getElementById('cancelReturnModalTitle');
        const reasonLabel = document.getElementById('reasonLabel');
        const noticeTitle = document.getElementById('noticeTitle');
        const noticeText  = document.getElementById('noticeText');
        const submitBtn   = document.getElementById('submitBtn');
        const productTitle= document.querySelector('.cr-product-title');

        if (actionType === 'return') {
            title.textContent = 'Î∞òÌíà Ïã†Ï≤≠';
            reasonLabel.textContent = 'Î∞òÌíà ÏÇ¨Ïú†';
            noticeTitle.textContent = 'Î∞òÌíà ÏïàÎÇ¥ÏÇ¨Ìï≠';
            noticeText.textContent  = 'Î∞òÌíà ÏÉÅÌíà Í≤ÄÏàò ÏôÑÎ£å ÌõÑ ÌôòÎ∂à Ï≤òÎ¶¨Í∞Ä ÏßÑÌñâÎê©ÎãàÎã§.';
            submitBtn.textContent   = 'Î∞òÌíà Ïã†Ï≤≠ÌïòÍ∏∞';
            if (productTitle) productTitle.textContent = 'Î∞òÌíàÌï† ÏÉÅÌíà ÏÑ†ÌÉù';
        } else {
            title.textContent = 'Ï£ºÎ¨∏ Ï∑®ÏÜå Ïã†Ï≤≠';
            reasonLabel.textContent = 'Ï∑®ÏÜå ÏÇ¨Ïú†';
            noticeTitle.textContent = 'Ï∑®ÏÜå ÏïàÎÇ¥ÏÇ¨Ìï≠';
            noticeText.textContent  = 'Ï∑®ÏÜå ÏöîÏ≤≠ ÏäπÏù∏ ÌõÑ ÏòÅÏóÖÏùº Í∏∞Ï§Ä 3~5Ïùº ÎÇ¥ ÌôòÎ∂à Ï≤òÎ¶¨Îê©ÎãàÎã§.';
            submitBtn.textContent   = 'Ï∑®ÏÜå Ïã†Ï≤≠ÌïòÍ∏∞';
            if (productTitle) productTitle.textContent = 'Ï∑®ÏÜåÌï† ÏÉÅÌíà ÏÑ†ÌÉù';
        }

        // Î™®Îã¨ ÌëúÏãú
        document.getElementById('cancelReturnModal').style.display = 'block';
        document.body.style.overflow = 'hidden';

        // Ìèº ÏÑ∏ÌåÖ
        setTimeout(() => {
            const form = document.getElementById('cancelReturnForm');
            if (form) form.reset();

            document.getElementById('cr_orderCode').value = orderCode || '';
            document.getElementById('cr_actionType').value = actionType;

            const memberCode = '[[${session.member?.memberCode}]]';
            const guestCode  = '[[${session.guest?.guestCode}]]';
            const memEl = document.getElementById('cr_memberCode');
            const gueEl = document.getElementById('cr_guestCode');
            if (memEl) memEl.value = (memberCode !== '[[${session.member?.memberCode}]]') ? memberCode : '';
            if (gueEl) gueEl.value = (guestCode  !== '[[${session.guest?.guestCode}]]')  ? guestCode  : '';

            const otherReasonGroup = document.getElementById('otherReasonGroup');
            if (otherReasonGroup) otherReasonGroup.style.display = 'none';

            loadOrderProducts(orderCode); // ÌôòÎ∂àÎåÄÏÉÅ ÏÉÅÌíà Î°úÎìú
        }, 50);
    }
    function closeCancelReturnModal(){
        document.getElementById('cancelReturnModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    window.addEventListener('click', function(e){
        const modal = document.getElementById('cancelReturnModal');
        if (e.target === modal) closeCancelReturnModal();
    });
    document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeCancelReturnModal();
    });

    function toggleOtherReason(){
        const reasonSelect = document.getElementById('cancelReason');
        const otherReasonGroup = document.getElementById('otherReasonGroup');
        if (!reasonSelect || !otherReasonGroup) return;
        if (reasonSelect.value === 'Í∏∞ÌÉÄ') otherReasonGroup.style.display = 'block';
        else {
            otherReasonGroup.style.display = 'none';
            const otherReasonEl = document.getElementById('otherReason');
            if (otherReasonEl) otherReasonEl.value = '';
        }
        calculateRefundAmount();
    }

    /* ===== ÌôòÎ∂à ÎåÄÏÉÅ ÏÉÅÌíà Î°úÎìú & Î†åÎçî ===== */
    function loadOrderProducts(orderCode) {
        $.ajax({
            url: `/mypage/order/${orderCode}/refund-products`,
            method: 'GET',
            success: function (data) {
                // ÎîîÎ≤ÑÍπÖÏö©: ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÏõêÎ≥∏ÏùÑ Ï†ÑÏó≠Ïóê Î≥¥Í¥ÄÌï¥ÏÑú ÏΩòÏÜîÎ°ú Î∞îÎ°ú ÌôïÏù∏ Í∞ÄÎä•
                window.__lastRefundProductsRaw = (data && data.products) || [];

                if (data && data.success) {
                    const h = data.header || {};
                    currentOrderHeader = {
                        totalAmount: Number(h.totalAmount || 0),
                        discountAmount: Number(h.discountAmount || 0),
                        deliveryFee: Number(h.deliveryFee || 0),
                        finalAmount: Number(h.finalAmount || 0),
                        usedCoupon: !!h.usedCoupon,
                        couponMinOrder: Number(h.couponMinOrder || 10000)
                    };
                    COUPON_MIN_ORDER = currentOrderHeader.couponMinOrder;

                    // ‚úÖ Ïó¨Í∏∞ÏÑú Í∞Å ÏÉÅÌíàÏóê _imgÎ•º ÌôïÏ†ïÌï¥ÏÑú Ïã¨Ïñ¥Îë°ÎãàÎã§.
                    currentOrderProducts = window.__lastRefundProductsRaw.map(p => {
                        const _img = buildProductImageUrl(p);
                        return { ...p, _img };
                    });

                    renderProductList();
                    calculateRefundAmount();
                } else {
                    currentOrderProducts = [];
                    renderProductList();
                    alert((data && data.message) || 'ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                }
            },
            error: function (xhr, status, error) {
                console.error('ÏÉÅÌíà Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:', error);
                currentOrderProducts = [];
                renderProductList();
                alert('ÏÉÅÌíà Î™©Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        });
    }

    function renderRefundProductList(){
        const el = document.getElementById('productList');
        if (!el) return;

        totalProductsCount = currentOrderProducts.length;
        totalOrderAmount   = Number(currentOrderHeader.totalAmount) || currentOrderProducts
            .reduce((sum, p)=> sum + (Number(p.price||0) * Number(p.orderedQuantity||p.quantity||0)), 0);

        const selectAllHtml = `
    <div class="cr-select-all">
      <input type="checkbox" class="cr-select-all-checkbox" id="selectAllProducts"
             onchange="toggleAllProducts(); calculateRefundAmount();">
      <label for="selectAllProducts" class="cr-select-all-label">Ï†ÑÏ≤¥ ÏÑ†ÌÉù</label>
    </div>`;

        const itemsHtml = currentOrderProducts.map(p => {
            const refundable = Number(p.refundableQuantity ?? p.quantity ?? 0);
            const ordered    = Number(p.orderedQuantity  ?? p.quantity ?? 0);
            const refunded   = Number(p.refundedQuantity ?? 0);
            const disabled   = refundable <= 0;

            return `
      <div class="cr-product-item ${disabled ? 'disabled' : ''}">
        <input type="checkbox" class="cr-product-checkbox"
               id="product_${p.orderItemCode || p.productId}"
               data-order-item-code="${p.orderItemCode || ''}"
               ${disabled ? 'disabled' : ''}
               onchange="updateSelectAll(); calculateRefundAmount();">

        <img
  src="${p._img}"
  alt="${p.productName}"
  class="cr-product-image"
  onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=No+Image';"
/>

        <div class="cr-product-info">
          <div class="cr-product-name">${p.productName}</div>
          ${p.optionName ? `<div class="cr-product-option">${p.optionName}: ${p.optionValue || ''}</div>` : ''}
          <div class="cr-product-quantity">
            Ï£ºÎ¨∏ ÏàòÎüâ: ${ordered}Í∞ú${refunded>0 ? ` / Í∏∞ÌôòÎ∂à: ${refunded}Í∞ú` : ''}
          </div>
          <div class="cr-product-price">${Number(p.price||0).toLocaleString()}Ïõê</div>
          ${disabled ? `<div class="cr-note">Îçî Ïù¥ÏÉÅ ÌôòÎ∂à Í∞ÄÎä•Ìïú ÏàòÎüâÏù¥ ÏóÜÏäµÎãàÎã§.</div>` : ''}
        </div>

        <div class="cr-quantity-control">
          <span class="cr-quantity-label">ÏàòÎüâ:</span>
          <input type="number" class="cr-quantity-input"
                 id="quantity_${p.orderItemCode || p.productId}"
                 min="1"
                 max="${Math.max(refundable, 1)}"
                 value="${Math.max(refundable, 1)}"
                 ${disabled ? 'disabled' : ''}
                 oninput="validateQuantityInput(this); calculateRefundAmount();"
                 onchange="validateQuantityInput(this); calculateRefundAmount();"
                 onpaste="setTimeout(() => { validateQuantityInput(this); calculateRefundAmount(); }, 10)">
        </div>
      </div>`;
        }).join('');

        el.innerHTML = selectAllHtml + itemsHtml;

        // Ï¥àÍ∏∞ Ï≤¥ÌÅ¨: ÌôòÎ∂à Í∞ÄÎä• Ìï≠Î™©Îßå Ï†ÑÏ≤¥ Ï≤¥ÌÅ¨
        setTimeout(()=>{
            const list = document.querySelectorAll('.cr-product-checkbox:not([disabled])');
            list.forEach(cb => cb.checked = true);
            const all = document.getElementById('selectAllProducts');
            if (all) all.checked = list.length > 0;
            calculateRefundAmount();
        }, 30);
    }

    function toggleAllProducts(){
        const all = document.getElementById('selectAllProducts');
        document.querySelectorAll('.cr-product-checkbox').forEach(cb => { if (!cb.disabled) cb.checked = !!all.checked; });
        calculateRefundAmount();
    }
    function updateSelectAll(){
        const all = document.getElementById('selectAllProducts');
        const cbs = Array.from(document.querySelectorAll('.cr-product-checkbox'));
        const enabled = cbs.filter(cb => !cb.disabled);
        const checked = enabled.filter(cb => cb.checked);
        if (all) {
            all.checked = enabled.length>0 && checked.length===enabled.length;
            all.indeterminate = checked.length>0 && checked.length<enabled.length;
        }
    }

    /* ===== ÏàòÎüâ ÏûÖÎ†• Í≤ÄÏ¶ù ===== */
    function validateQuantityInput(input){
        const min = parseInt(input.getAttribute('min')) || 1;
        const max = parseInt(input.getAttribute('max')) || 1;
        let v = parseInt(input.value);
        if (isNaN(v)) { input.value = min; return; }
        if (v < min) { input.value = min; showQuantityMessage(input, `ÏµúÏÜå ÏàòÎüâÏùÄ ${min}Í∞úÏûÖÎãàÎã§.`); return; }
        if (v > max) { input.value = max; showQuantityMessage(input, `ÏµúÎåÄ ÏàòÎüâÏùÄ ${max}Í∞úÏûÖÎãàÎã§.`); return; }
    }
    function showQuantityMessage(input, message){
        const ex = input.parentElement.querySelector('.quantity-message'); if (ex) ex.remove();
        const msg = document.createElement('div');
        msg.className='quantity-message';
        msg.textContent = message;
        msg.style.cssText = 'position:absolute;top:100%;left:0;background:#fee2e2;color:#991b1b;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;z-index:1000;border:1px solid #fca5a5;';
        input.parentElement.style.position='relative';
        input.parentElement.appendChild(msg);
        setTimeout(()=>{ if (msg.parentNode) msg.parentNode.removeChild(msg); }, 2000);
    }

    /* ===== ÏÑ†ÌÉùÎêú ÏÉÅÌíà ÏàòÏßë ===== */
    function getSelectedProducts(){
        const out = [];
        document.querySelectorAll('.cr-product-checkbox:checked').forEach(cb => {
            const orderItemCode = cb.getAttribute('data-order-item-code');
            const pid = cb.id.replace(/^product_/, '');
            const qEl = document.getElementById(`quantity_${pid}`);
            const qty = qEl ? parseInt(qEl.value) : 1;
            const p = currentOrderProducts.find(x => (String(x.orderItemCode||x.productId) === String(pid)));
            if (p) {
                out.push({
                    orderItemCode: p.orderItemCode,          // ÏÑúÎ≤Ñ Í≤¨Ï†Å/Ï†úÏ∂úÏóêÏÑú ÏÇ¨Ïö©
                    productId: p.productId || pid,
                    productName: p.productName,
                    optionName: p.optionName,
                    optionValue: p.optionValue,
                    selectedQuantity: qty,
                    originalQuantity: Number(p.orderedQuantity ?? p.quantity ?? qty),
                    price: Number(p.price||0)
                });
            }
        });
        return out;
    }

    // üîÑ ÏßßÏùÄ ÎîîÎ∞îÏö¥Ïä§Î°ú ÏÑúÎ≤Ñ Ìò∏Ï∂ú Í≥ºÎã§ Î∞©ÏßÄ
    let _refundCalcTimer = null;

    function calculateRefundAmount() {
        const selectedProducts = getSelectedProducts();
        const reason = document.getElementById('cancelReason')?.value || '';

        if (!selectedProducts.length) {
            updateRefundDisplay(0, 'ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        // Ìï©Í≥Ñ/Ï†ÑÏ≤¥Ï∑®ÏÜå ÌåêÎ≥Ñ
        const selectedTotal = selectedProducts.reduce((s, p) => s + (p.price * p.selectedQuantity), 0);
        const isFullRefund =
            selectedProducts.length === totalProductsCount &&
            selectedProducts.every(p => p.selectedQuantity === p.originalQuantity);

        // ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î†§Ï§Ä ÏõêÏ£ºÎ¨∏ Ìó§Îçî(Í∞ÄÏû• Ïã†Î¢∞)
        const header           = currentOrderHeader || {};
        const totalBefore      = Number(header.totalAmount    || 0);  // Ï¥ù ÏÉÅÌíàÍ∏àÏï°(Ìï†Ïù∏ Ï†Ñ)
        const originalDiscount = Number(header.discountAmount || 0);  // ÏõêÏ£ºÎ¨∏ Ìï†Ïù∏ Ìï©Í≥Ñ
        const originalPaid     = Number(header.finalAmount    || 0);  // ‚òÖ Ï≤òÏùå Í≤∞Ï†ú Í∏àÏï°(ÌëúÏãú Ïö∞ÏÑ†)
        const couponMinOrder   = Number(header.couponMinOrder || 10000);
        const usedCoupon       = !!header.usedCoupon;

        const remainingSubtotal = Math.max(0, totalBefore - selectedTotal);

        // Ï£ºÎ¨∏ ÏÉÅÌÉú: Î∞∞ÏÜ° Ïù¥ÌõÑÎ©¥ Î∞òÌíà ÌöåÏàòÎπÑ Í≥†Î†§
        const stRaw = (currentOrderStatus || '');
        const ST    = stRaw.toUpperCase();
        const isAfterShipment = (ST === 'SHIPPED' || ST === 'DELIVERED' || stRaw === 'Î∞∞ÏÜ°Ï§ë' || stRaw === 'Î∞∞ÏÜ°ÏôÑÎ£å');

        // ÎÇ®ÏùÄ Ï£ºÎ¨∏ Î∞∞ÏÜ°ÎπÑ(Î∂ÄÎ∂Ñ Ï∑®ÏÜåÎ°ú Î¨¥Î£åÎ∞∞ÏÜ° Î∂ïÍ¥¥ Ïãú Î∂ÄÍ≥º, Î∂àÎüâ Ï†úÏô∏)
        const DELIVERY_FEE = 3000;
        const FREE_DELIVERY_THRESHOLD = 50000;
        let newDeliveryFee = 0;
        if (!isFullRefund && reason !== 'ÏÉÅÌíàÎ∂àÎüâ' && remainingSubtotal < FREE_DELIVERY_THRESHOLD) {
            newDeliveryFee = DELIVERY_FEE;
        }

        // Ïø†Ìè∞ ÌöåÏàò(Î∂ÄÎ∂Ñ Ï∑®ÏÜå + ÎÇ®ÏùÄ Ìï©Í≥Ñ < Ïø†Ìè∞ ÏµúÏÜåÍ∏àÏï°, Î∂àÎüâ Ï†úÏô∏)
        let discountRollback = 0;
        if (!isFullRefund && reason !== 'ÏÉÅÌíàÎ∂àÎüâ' && usedCoupon && originalDiscount > 0 && remainingSubtotal < couponMinOrder) {
            discountRollback = originalDiscount;
        }
        const keptDiscount = Math.max(0, originalDiscount - discountRollback);

        // Î∞òÌíà ÌöåÏàò ÌÉùÎ∞∞ÎπÑ(Î∞∞ÏÜ°Ï§ë/ÏôÑÎ£å + Î∂àÎüâ ÏïÑÎãò)
        let pickupFee = 0;
        if (isAfterShipment && reason !== 'ÏÉÅÌíàÎ∂àÎüâ') {
            pickupFee = RETURN_PICKUP_FEE;
        }

        // ÎÇ®ÏùÄ Í≤∞Ï†ú Í∏àÏï°(ÌëúÏãúÏö©)
        const newPayable = Math.max(0, remainingSubtotal - keptDiscount + newDeliveryFee);

        // ‚ÄúÏ≤òÏùå Í≤∞Ï†ú‚ÄùÎäî ÏÑúÎ≤Ñ finalAmountÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ Í∞íÏùÑ Í∑∏ÎåÄÎ°ú ÌëúÏãú
        const originalPaidDisplay =
            originalPaid > 0
                ? originalPaid
                : Math.max(0, (totalBefore - originalDiscount + (header.deliveryFee || 0)));

        // ÌôòÎ∂à ÏòàÏ†ï Í∏àÏï° = Ï≤òÏùå Í≤∞Ï†ú ‚àí ÎÇ®ÏùÄ Í≤∞Ï†ú ‚àí (ÌöåÏàò ÌÉùÎ∞∞ÎπÑ)
        const refundAmount = Math.max(0, originalPaidDisplay - newPayable - pickupFee);

        // ÏÑ§Î™Ö ÎùºÏù∏(ÌÖçÏä§Ìä∏)
        const lines = [];
        lines.push(`Ï≤òÏùå Í≤∞Ï†ú: ${originalPaidDisplay.toLocaleString()}Ïõê`);
        lines.push(`ÏÑ†ÌÉùÏÉÅÌíà Ìï©Í≥Ñ: ${selectedTotal.toLocaleString()}Ïõê`);
        lines.push(`ÎÇ®ÏùÄ ÏÉÅÌíà Ìï©Í≥Ñ: ${remainingSubtotal.toLocaleString()}Ïõê`);
        if (discountRollback > 0) lines.push(`Ïø†Ìè∞ ÌöåÏàò: ${discountRollback.toLocaleString()}Ïõê`);
        else if (originalDiscount > 0) lines.push(`Ïø†Ìè∞ Ïú†ÏßÄ: ${keptDiscount.toLocaleString()}Ïõê`);
        lines.push(newDeliveryFee > 0 ? `ÎÇ®ÏùÄ Ï£ºÎ¨∏ Î∞∞ÏÜ°ÎπÑ: ${newDeliveryFee.toLocaleString()}Ïõê` : `ÎÇ®ÏùÄ Ï£ºÎ¨∏ Î∞∞ÏÜ°ÎπÑ: ÏóÜÏùå`);
        if (pickupFee > 0) lines.push(`ÌöåÏàò ÌÉùÎ∞∞ÎπÑ: ${pickupFee.toLocaleString()}Ïõê`);
        else if (isAfterShipment && reason === 'ÏÉÅÌíàÎ∂àÎüâ') lines.push(`ÌöåÏàò ÌÉùÎ∞∞ÎπÑ: Î©¥Ï†ú(ÏÉÅÌíàÎ∂àÎüâ)`);
        lines.push(`ÎÇ®ÏùÄ Í≤∞Ï†ú Í∏àÏï°: ${newPayable.toLocaleString()}Ïõê`);
        lines.push(`ÌôòÎ∂à ÏòàÏ†ï Í∏àÏï° = Ï≤òÏùå Í≤∞Ï†ú ‚àí ÎÇ®ÏùÄ Í≤∞Ï†ú${pickupFee>0?' ‚àí ÌöåÏàò ÌÉùÎ∞∞ÎπÑ':''} = ${refundAmount.toLocaleString()}Ïõê`);

        updateRefundDisplay(refundAmount, lines.join('\n'));
    }

    function _estimateRefundLocally(selectedProducts, reason) {
        const header = currentOrderHeader || {};
        const DELIVERY_FEE = 3000;
        const FREE_DELIVERY_THRESHOLD = 50000;

        const selectedTotal   = selectedProducts.reduce((s,p)=> s + (p.price * p.selectedQuantity), 0);
        const isFullRefund    = selectedProducts.length === totalProductsCount &&
            selectedProducts.every(p => p.selectedQuantity === p.originalQuantity);
        const remainingAmount = Math.max(0, Number(header.totalAmount || 0) - selectedTotal);

        // Î∞∞ÏÜ°ÎπÑ Ï∞®Í∞ê Ïó¨Î∂Ä
        const st = (currentOrderStatus || '').toUpperCase();
        const isPendingOrPaid = ['PENDING','PAID','Í≤∞Ï†úÎåÄÍ∏∞','Í≤∞Ï†úÏôÑÎ£å'].includes(st);
        let needsDeliveryFee = false;

        if (reason !== 'ÏÉÅÌíàÎ∂àÎüâ') {
            needsDeliveryFee = !isPendingOrPaid; // Ï∂úÍ≥† ÌõÑ Î∞òÌíà Í∏∞Î≥∏ Ï∞®Í∞ê
            if (!isFullRefund &&
                Number(header.totalAmount || 0) >= FREE_DELIVERY_THRESHOLD &&
                remainingAmount < FREE_DELIVERY_THRESHOLD) {
                needsDeliveryFee = true;
            }
        }

        // Ïø†Ìè∞ ÌöåÏàò(ÌëúÏãúÏö©)
        let discountRollback = 0;
        if (reason !== 'ÏÉÅÌíàÎ∂àÎüâ' && header.usedCoupon && remainingAmount < Number(header.couponMinOrder || 10000)) {
            discountRollback = Number(header.discountAmount || 0);
        }

        const deliveryDeduct = needsDeliveryFee ? DELIVERY_FEE : 0;
        const refundAmount   = Math.max(0, selectedTotal - deliveryDeduct - discountRollback);

        return { selectedTotal, remainingAmount, deliveryDeduct, discountRollback, refundAmount };
    }

    function _buildLocalMessage(est) {
        const parts = [
            `ÏÑ†ÌÉùÏÉÅÌíà Ìï©Í≥Ñ: ${est.selectedTotal.toLocaleString()}Ïõê`,
            `ÎÇ®ÏùÄ ÏÉÅÌíà Ìï©Í≥Ñ: ${est.remainingAmount.toLocaleString()}Ïõê`
        ];
        if (est.discountRollback > 0) parts.push(`Ïø†Ìè∞ ÌöåÏàò: ${est.discountRollback.toLocaleString()}Ïõê`);
        if (est.deliveryDeduct > 0)  parts.push(`Î∞∞ÏÜ°ÎπÑ ${est.deliveryDeduct.toLocaleString()}Ïõê Ï∞®Í∞ê`);
        return parts.join(' ¬∑ ');
    }

    // üîÅ ÍµêÏ≤¥: ÌôòÎ∂à ÏòàÏÉÅ Í∏àÏï° ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
    function updateRefundDisplay(amount, messageHtml) {
        const refundSummary = document.getElementById('refundSummary');
        if (!refundSummary) return;

        const amountEl = refundSummary.querySelector('.refund-amount');
        const msgEl    = refundSummary.querySelector('.refund-message');

        if (amountEl) {
            amountEl.textContent = `‚Ç©${Number(amount || 0).toLocaleString()}`;
            amountEl.style.color = amount > 0 ? '#1e293b' : '#6b7280';
        }
        if (msgEl) {
            // üí° HTMLÎ°ú ÎÑ£Ïñ¥Ï£ºÏñ¥ Ìï≠Î™©¬∑Ï§ÑÎ∞îÍøàÏùÑ ÌëúÌòÑ
            msgEl.innerHTML = messageHtml || '';
        }
    }

    /* ===== Ï†úÏ∂ú: ÏÑúÎ≤Ñ Í≤¨Ï†Å ‚Üí ÏµúÏ¢Ö Ïã†Ï≤≠ ===== */
    async function submitCancelReturn(){
        const reason = document.getElementById('cancelReason').value;
        const selectedProducts = getSelectedProducts();
        if (!reason) { alert('ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'); return; }
        if (selectedProducts.length===0) { alert('Ï∑®ÏÜå/Î∞òÌíàÌï† ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'); return; }

        const orderCode = document.getElementById('cr_orderCode').value;
        const actionType= document.getElementById('cr_actionType').value;

        // 1) ÏÑúÎ≤Ñ ÌôòÎ∂à Í≤¨Ï†Å
        const isFullRefund =
            selectedProducts.length === totalProductsCount &&
            selectedProducts.every(p => p.selectedQuantity === p.originalQuantity);

        const payload = {
            orderCode: Number(orderCode),
            actionType,
            cancelReason: reason,
            fullRefund: isFullRefund,                // ‚òÖ Ï∂îÍ∞Ä
            products: selectedProducts.map(p => ({
                orderItemCode: p.orderItemCode,
                selectedQuantity: p.selectedQuantity
            }))
        };

        let quote;
        try {
            const res = await fetch('/mypage/order/refund-quote', {
                method:'POST',
                headers:{ 'Content-Type':'application/json', [getCSRFHeader()]:getCSRFToken() },
                body: JSON.stringify(payload)
            });
            quote = await res.json();
        } catch(e){
            console.error(e);
            alert('ÌôòÎ∂à Í∏àÏï° Í≥ÑÏÇ∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            return;
        }
        if (!quote || !quote.success) {
            alert(quote?.message || 'ÌôòÎ∂à Í∏àÏï° Í≥ÑÏÇ∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            return;
        }

        // 2) FormDataÎ°ú ÏµúÏ¢Ö Ïã†Ï≤≠
        const fd = new FormData();
        fd.append('orderCode', orderCode);
        fd.append('actionType', actionType);
        fd.append('cancelReason', reason);
        fd.append('refundAmount', Number(quote.refundAmount||0));
        fd.append('refundDeliveryFee', Number(quote.deliveryFeeDeduction||0));
        selectedProducts.forEach((p,i)=>{
            fd.append(`products[${i}].productId`,         p.productId);
            fd.append(`products[${i}].productName`,       p.productName||'');
            fd.append(`products[${i}].optionName`,        p.optionName||'');
            fd.append(`products[${i}].optionValue`,       p.optionValue||'');
            fd.append(`products[${i}].originalQuantity`,  p.originalQuantity);
            fd.append(`products[${i}].selectedQuantity`,  p.selectedQuantity);
            fd.append(`products[${i}].unitPrice`,         p.price);
            fd.append(`products[${i}].refundAmount`,      0); // ÏµúÏ¢Ö Ï†ïÏÇ∞ÏùÄ ÏÑúÎ≤Ñ
        });

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.textContent = 'Ï≤òÎ¶¨Ï§ë...';

        $.ajax({
            url: '/mypage/order/cancel-order-complete',
            method: 'POST',
            data: fd, processData: false, contentType: false,
            success: function(resp){
                if (resp.success) {
                    const deliveryMessage = Number(quote.deliveryFeeDeduction)>0
                        ? `\nÎ∞∞ÏÜ°ÎπÑ Í≥†Í∞ùÎ∂ÄÎã¥: ‚Ç©${Number(quote.deliveryFeeDeduction).toLocaleString()}`
                        : '\nÎ∞∞ÏÜ°ÎπÑ ÏáºÌïëÎ™∞Î∂ÄÎã¥';
                    alert(
                        `${selectedProducts.length}Í∞ú ÏÉÅÌíàÏùò ${actionType==='return'?'Î∞òÌíà':'Ï∑®ÏÜå'} Ïã†Ï≤≠Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\n\n` +
                        `Ï¥ù ÌôòÎ∂à ÏòàÏ†ï Í∏àÏï°: ‚Ç©${Number(quote.refundAmount).toLocaleString()}${deliveryMessage}`
                    );
                    closeCancelReturnModal();
                    location.reload();
                } else {
                    alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + (resp.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            },
            error: function(xhr, s, e){
                console.error('AJAX Error:', e);
                alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            },
            complete: function(){
                btn.disabled = false;
                btn.textContent = (currentActionType==='return') ? 'Î∞òÌíà Ïã†Ï≤≠ÌïòÍ∏∞' : 'Ï∑®ÏÜå Ïã†Ï≤≠ÌïòÍ∏∞';
            }
        });
    }

    /* ============================== */
    /*  Í∏∞ÌÉÄ(Î°úÍ∑∏ÏïÑÏõÉ/Î≥µÏÇ¨ Îì±)        */
    /* ============================== */
    function logout(){ location.href = '/auth/logout'; }

    function copyAccountInfo(){
        const accountInfo = 'IBK Í∏∞ÏóÖÏùÄÌñâ 381-129451-04-015';
        if (navigator.clipboard) {
            navigator.clipboard.writeText(accountInfo).then(()=>showCopyMessage('Í≥ÑÏ¢åÎ≤àÌò∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!'))
                .catch(()=>fallbackCopyTextToClipboard(accountInfo));
        } else fallbackCopyTextToClipboard(accountInfo);
    }
    function fallbackCopyTextToClipboard(text){
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.focus(); ta.select();
        try { document.execCommand('copy') ? showCopyMessage('Í≥ÑÏ¢åÎ≤àÌò∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!') : showCopyMessage('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); }
        catch(e){ showCopyMessage('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); }
        document.body.removeChild(ta);
    }
    function showCopyMessage(msg){
        const ex = document.querySelector('.copy-message'); if (ex) ex.remove();
        const el = document.createElement('div');
        el.className='copy-message'; el.textContent=msg;
        document.body.appendChild(el);
        setTimeout(()=>{ if (el.parentNode) el.parentNode.removeChild(el); }, 2000);
    }

    function renderProductList() {
        const list = document.getElementById('productList');
        if (!list) return;

        totalProductsCount = currentOrderProducts.length;
        totalOrderAmount = currentOrderProducts.reduce(
            (sum, p) => sum + (Number(p.price||0) * Number(p.orderedQuantity || p.quantity || 1)), 0
        );

        const selectAllHtml = `
    <div class="cr-select-all">
      <input type="checkbox" class="cr-select-all-checkbox" id="selectAllProducts"
             onchange="toggleAllProducts(); calculateRefundAmount();">
      <label for="selectAllProducts" class="cr-select-all-label">Ï†ÑÏ≤¥ ÏÑ†ÌÉù</label>
    </div>`;

        const itemsHtml = currentOrderProducts.map(p => {
            const maxQty = Math.max(Number(p.refundableQuantity ?? p.quantity ?? 1), 1);
            const disabled = maxQty <= 0 ? 'disabled' : '';
            const refundedInfo = Number(p.refundedQuantity) > 0 ? ` / Í∏∞ÌôòÎ∂à: ${p.refundedQuantity}Í∞ú` : '';
            const note = maxQty <= 0 ? `<div class="cr-note">Îçî Ïù¥ÏÉÅ ÌôòÎ∂à Í∞ÄÎä•Ìïú ÏàòÎüâÏù¥ ÏóÜÏäµÎãàÎã§.</div>` : '';

            return `
      <div class="cr-product-item ${disabled ? 'disabled' : ''}">
        <input type="checkbox" class="cr-product-checkbox"
               id="product_${p.orderItemCode || p.productId}"
               data-order-item-code="${p.orderItemCode || ''}"
               ${disabled}
               onchange="updateSelectAll(); calculateRefundAmount();">

        <img
          src="${p._img}"
          alt="${p.productName || ''}"
          class="cr-product-image"
          onerror="this.onerror=null; this.src='https://via.placeholder.com/70?text=No+Image';"
        >

        <div class="cr-product-info">
          <div class="cr-product-name">${p.productName || ''}</div>
          ${p.optionName ? `<div class="cr-product-option">${p.optionName}: ${p.optionValue || ''}</div>` : ''}
          <div class="cr-product-quantity">
            Ï£ºÎ¨∏ ÏàòÎüâ: ${p.orderedQuantity || p.quantity || 1}Í∞ú${refundedInfo}
          </div>
          <div class="cr-product-price">${Number(p.price||0).toLocaleString()}Ïõê</div>
          ${note}
        </div>

        <div class="cr-quantity-control">
          <span class="cr-quantity-label">ÏàòÎüâ:</span>
          <input type="number" class="cr-quantity-input"
                 id="quantity_${p.orderItemCode || p.productId}"
                 min="1"
                 max="${maxQty}"
                 value="${Math.min(maxQty, p.selectedQuantity || maxQty)}"
                 ${disabled}
                 oninput="validateQuantityInput(this); calculateRefundAmount();"
                 onchange="validateQuantityInput(this); calculateRefundAmount();"
                 onpaste="setTimeout(() => { validateQuantityInput(this); calculateRefundAmount(); }, 10)">
        </div>
      </div>`;
        }).join('');

        list.innerHTML = selectAllHtml + itemsHtml;

        setTimeout(() => {
            const cbList = list.querySelectorAll('.cr-product-checkbox:not([disabled])');
            const selectAll = document.getElementById('selectAllProducts');
            cbList.forEach(cb => cb.checked = true);
            if (selectAll) selectAll.checked = cbList.length > 0;
            calculateRefundAmount();
        }, 0);
    }

    function buildProductImageUrl(p) {
        try {
            const BASE = 'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com';
            const cands = [
                p._img,
                p.imageUrl, p.image_url, p.image, p.imgUrl, p.img_url,
                p.imageName, p.image_name, p.filename, p.fileName, p.file_name,
                p.productImageUrl, p.product_image_url, p.thumbnailUrl, p.thumbnail_url,
                p?.imageDto?.imageUrl, p?.productDto?.imageDto?.imageUrl, p?.productDto?.imageUrl
            ].filter(v => v != null && String(v).trim() !== '');

            let v = String(cands[0] || '').trim();
            if (!v) return 'https://via.placeholder.com/70?text=No+Image';
            if (/^https?:\/\//i.test(v)) return v;              // Ïù¥ÎØ∏ Ï†àÎåÄ URL
            v = v.replace(/^\/+/, '');                           // Ïïû Ïä¨ÎûòÏãú Ï†úÍ±∞
            if (v.startsWith('product/')) return `${BASE}/${v}`; // 'product/'Î°ú ÏãúÏûë
            return `${BASE}/product/${v}`;                       // ÌååÏùºÎ™ÖÎßå Ïò® Í≤ΩÏö∞
        } catch(e) {
            return 'https://via.placeholder.com/70?text=No+Image';
        }
    }
</script>


</body>
</html>