<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hollybam.hollybam.dao.IF_DiscountDao">

    <insert id="insertDiscount" parameterType="com.hollybam.hollybam.dto.DiscountDto" useGeneratedKeys="true" keyProperty="discountCode">
        INSERT INTO discount (
            discount_id,
            discount_description,
            discount_type,
            discount_value,
            min_order_price,
            expired_at
        ) VALUES (
                     #{discountId},
                     #{discountDescription},
                     #{discountType},
                     #{discountValue},
                     #{minOrderPrice},
                     #{expiredAt}
                 )
    </insert>

    <!-- í• ì¸ì½”ë“œë¡œ í• ì¸ ì •ë³´ ì¡°íšŒ -->
    <select id="selectDiscountByCode" parameterType="String" resultType="com.hollybam.hollybam.dto.DiscountDto">
        SELECT
            discount_code,
            discount_id,
            discount_description,
            discount_type,
            discount_value,
            min_order_price,
            expired_at,
            created_at
        FROM discount
        WHERE discount_id = #{discountId}
    </select>

    <!-- í™œì„±í™”ëœ í• ì¸ì½”ë“œ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectActiveDiscounts" resultType="com.hollybam.hollybam.dto.DiscountDto">
        SELECT
            discount_code,
            discount_id,
            discount_description,
            discount_type,
            discount_value,
            min_order_price,
            expired_at,
            created_at
        FROM discount
        WHERE (expired_at IS NULL OR expired_at >= CURDATE())
        ORDER BY created_at DESC
    </select>

    <!-- ===== ðŸ†• í• ì¸ì½”ë“œ ì‚¬ìš© ë‚´ì—­ ê´€ë ¨ ì¿¼ë¦¬ ì¶”ê°€ ===== -->

    <!-- íšŒì›ì˜ íŠ¹ì • í• ì¸ì½”ë“œ ì‚¬ìš© ì—¬ë¶€ í™•ì¸ -->
    <select id="checkDiscountCodeUsage" resultType="int">
        SELECT COUNT(*)
        FROM discount_code_usage
        WHERE discount_code = #{discountCode}
          AND mem_code = #{memCode}
    </select>

    <!-- í• ì¸ì½”ë“œ ì‚¬ìš© ë‚´ì—­ ì €ìž¥ -->
    <insert id="insertDiscountCodeUsage" parameterType="com.hollybam.hollybam.dto.DiscountCodeUsageDto" useGeneratedKeys="true" keyProperty="usageCode">
        INSERT INTO discount_code_usage (
            discount_code,
            mem_code,
            used_at,
            order_code,
            discount_amount
        ) VALUES (
                     #{discountCode},
                     #{memCode},
                     #{usedAt},
                     #{orderCode},
                     #{discountAmount}
                 )
    </insert>

    <!-- íšŒì›ì˜ í• ì¸ì½”ë“œ ì‚¬ìš© ë‚´ì—­ ì¡°íšŒ (í• ì¸ì½”ë“œ ì •ë³´ í¬í•¨) -->
    <select id="selectDiscountUsageByMember" parameterType="Integer" resultType="com.hollybam.hollybam.dto.DiscountCodeUsageDto">
        SELECT
            dcu.usage_code,
            dcu.discount_code,
            dcu.mem_code,
            dcu.used_at
        FROM discount_code_usage dcu
        WHERE dcu.mem_code = #{memCode}
        ORDER BY dcu.used_at DESC
    </select>

    <!-- ì „ì²´ í• ì¸ì½”ë“œ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ê´€ë¦¬ìž í™•ì¸ìš©) -->
    <select id="selectAllDiscountList" resultType="map">
        SELECT
            discount_code,
            discount_id,
            discount_description,
            discount_type,
            discount_value,
            min_order_price,
            expired_at,
            created_at
        FROM discount
        ORDER BY created_at DESC
    </select>

</mapper>