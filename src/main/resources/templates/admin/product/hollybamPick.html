<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" content="your-csrf-token"/>
  <meta name="_csrf_header" content="X-CSRF-TOKEN"/>
  <title>í™€ë¦¬ë°¤ í”½ ê´€ë¦¬ - ê´€ë¦¬ì</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- ê´€ë¦¬ì ì‚¬ì´ë“œë°” CSS/JS -->
  <link rel="stylesheet" href="/css/adminSidebar.css">
  <script src="/js/adminSidebar.js"></script>

  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    /* í—¤ë” */
    .header {
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      padding: 0 40px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-info {
      color: #6c757d;
      font-size: 13px;
      font-weight: 300;
    }

    .logout-btn {
      background: #fff;
      color: #212529;
      border: 1px solid #212529;
      padding: 8px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #212529;
      color: #fff;
    }

    /* ì»¨í…Œì´ë„ˆ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* í˜ì´ì§€ íƒ€ì´í‹€ */
    .page-title {
      margin-bottom: 40px;
    }

    .page-title h2 {
      color: #212529;
      font-size: 28px;
      font-weight: 300;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .page-title p {
      color: #6c757d;
      font-size: 14px;
      font-weight: 300;
    }



    /* ì„¹ì…˜ */
    .section {
      background: #fff;
      border: 1px solid #e9ecef;
      margin-bottom: 40px;
    }

    .section-header {
      padding: 30px 40px;
      border-bottom: 1px solid #e9ecef;
    }

    .section-title {
      color: #212529;
      font-size: 18px;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    .section-body {
      padding: 40px;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ ì˜ì—­ */
    .action-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .result-info {
      color: #6c757d;
      font-size: 14px;
      font-weight: 300;
    }

    .add-btn {
      background: #fff;
      color: #212529;
      border: 1px solid #212529;
      padding: 12px 24px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      background: #212529;
      color: #fff;
    }

    /* ë²„íŠ¼ */
    .btn {
      background: #fff;
      color: #212529;
      border: 1px solid #dee2e6;
      padding: 12px 20px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
    }

    .btn:hover {
      border-color: #212529;
    }

    .btn:active,
    .btn:focus {
      outline: none;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: #212529;
      color: #fff;
      border-color: #212529;
    }

    .btn-primary:hover {
      background: #000;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
      border-color: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .search-btn {
      background: #212529;
      color: #fff;
      border: 1px solid #212529;
      padding: 15px 24px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      background: #000;
    }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .pick-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
    }

    .pick-table th,
    .pick-table td {
      padding: 20px 15px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 14px;
      font-weight: 300;
    }

    .pick-table th {
      background: #f8f9fa;
      color: #6c757d;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 400;
    }

    .pick-table td {
      color: #212529;
    }

    .pick-table tbody tr:hover {
      background: #f8f9fa;
    }

    /* ìƒí’ˆ ì •ë³´ ì—´ë§Œ ì™¼ìª½ ì •ë ¬ */
    .pick-table td:first-child,
    .pick-table th:first-child {
      text-align: left;
    }

    /* ìƒí’ˆ ì •ë³´ ìŠ¤íƒ€ì¼ */
    .product-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border: 1px solid #e9ecef;
    }

    .product-details {
      flex: 1;
    }

    .product-name {
      color: #212529;
      font-weight: 400;
      margin-bottom: 5px;
    }

    .product-code {
      color: #6c757d;
      font-size: 12px;
    }

    /* í™€ë¦¬ë°¤ í”½ ë±ƒì§€ */
    .pick-badge {
      background: #212529;
      color: #fff;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 400;
      text-align: center;
      display: inline-block;
    }

    /* ì•¡ì…˜ ë²„íŠ¼ë“¤ */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-delete {
      background: #fff;
      color: #dc3545;
      border: 1px solid #dc3545;
      padding: 8px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-delete:hover {
      background: #dc3545;
      color: #fff;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border: 1px solid #e9ecef;
      width: 80%;
      max-width: 1000px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 30px 40px 20px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
    }

    .modal-title {
      color: #212529;
      font-size: 18px;
      font-weight: 300;
      letter-spacing: 0.5px;
      margin-bottom: 20px;
    }

    .modal-search {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .category-search-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 15px 20px;
      border: 1px solid #e9ecef;
      background: #fff;
      color: #212529;
      font-size: 14px;
      font-weight: 300;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .search-input:focus {
      outline: none;
      border-color: #212529;
    }

    .date-select {
      padding: 15px 20px;
      border: 1px solid #e9ecef;
      background: #fff;
      color: #212529;
      font-size: 14px;
      font-weight: 300;
      transition: all 0.3s ease;
      min-width: 120px;
      box-sizing: border-box;
    }

    .date-select:focus {
      outline: none;
      border-color: #212529;
    }

    .date-select:disabled {
      background: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    .modal-search-btn {
      background: #212529;
      color: #fff;
      border: 1px solid #212529;
      padding: 15px 20px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-search-btn:hover {
      background: #000;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 40px;
    }

    .modal-footer {
      padding: 20px 40px;
      border-top: 1px solid #e9ecef;
      background: #f8f9fa;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    /* ìƒí’ˆ ì„ íƒ í…Œì´ë¸” */
    .product-select-table {
      width: 100%;
      border-collapse: collapse;
    }

    .product-select-table th,
    .product-select-table td {
      padding: 15px 10px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      font-size: 14px;
      font-weight: 300;
    }

    .product-select-table th {
      background: #f8f9fa;
      color: #6c757d;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 400;
    }

    .product-select-table tbody tr:hover {
      background: #f8f9fa;
    }

    /* ìƒí’ˆ ì •ë³´ ì—´ë§Œ ì™¼ìª½ ì •ë ¬ */
    .product-select-table td:nth-child(2),
    .product-select-table th:nth-child(2) {
      text-align: left;
    }

    .product-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* ê°€ê²© ì •ë³´ ìŠ¤íƒ€ì¼ */
    .price-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .price-row {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .price-label {
      font-size: 11px;
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 35px;
      text-align: right;
    }

    .price-value {
      font-size: 13px;
      font-weight: 300;
      min-width: 80px;
      text-align: left;
    }

    .original-price .price-label {
      color: #6c757d;
    }

    .original-price .price-value {
      color: #6c757d;
      text-decoration: line-through;
    }

    .selling-price .price-label {
      color: #212529;
    }

    .selling-price .price-value {
      color: #212529;
      font-weight: 400;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .empty-state .empty-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .empty-state .empty-text {
      font-size: 16px;
      margin-bottom: 10px;
    }

    .empty-state .empty-subtext {
      font-size: 14px;
      color: #adb5bd;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #212529;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header {
        padding: 0 20px;
      }

      .container {
        padding: 20px 15px;
      }

      .section-header,
      .section-body {
        padding: 20px;
      }

      .action-header {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
      }

      .pick-table,
      .product-select-table {
        font-size: 12px;
      }

      .pick-table th,
      .pick-table td,
      .product-select-table th,
      .product-select-table td {
        padding: 10px 8px;
      }

      .modal-content {
        width: 95%;
        margin: 2% auto;
        max-height: 90vh;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 20px;
      }

      .modal-search {
        flex-direction: column;
        gap: 15px;
      }

      .category-search-container {
        flex-direction: column;
        gap: 10px;
      }

      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
<!-- ì‚¬ì´ë“œë°”ëŠ” ë³„ë„ë¡œ êµ¬í˜„í•˜ê±°ë‚˜ í¬í•¨í•˜ì„¸ìš” -->
<div th:replace="~{layout/adminSidebar :: sidebar}"></div>
<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="main-content">
  <!-- í—¤ë” -->
  <header class="header">
    <div class="header-actions">
      <div class="admin-info">
        ê´€ë¦¬ìë‹˜ í™˜ì˜í•©ë‹ˆë‹¤
      </div>
      <button class="logout-btn" onclick="logout()">
        Sign Out
      </button>
    </div>
  </header>

  <!-- ì»¨í…Œì´ë„ˆ -->
  <div class="container">
    <!-- í˜ì´ì§€ íƒ€ì´í‹€ -->
    <div class="page-title">
      <h2>í™€ë¦¬ë°¤ í”½ ê´€ë¦¬</h2>
      <p>ìš´ì˜ìê°€ ì¶”ì²œí•˜ëŠ” ìƒí’ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
    </div>

    <!-- í™€ë¦¬ë°¤ í”½ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="section">
      <div class="section-header">
        <h3 class="section-title">í™€ë¦¬ë°¤ í”½ ìƒí’ˆ ëª©ë¡</h3>
      </div>
      <div class="section-body">
        <div class="action-header">
          <div class="result-info" id="resultInfo" th:inline="text">
            í˜„ì¬ ë“±ë¡ëœ í™€ë¦¬ë°¤ í”½ ìƒí’ˆ ì´ [[${count}]]ê°œ
          </div>
          <button class="add-btn" onclick="openAddModal()">í”½ ìƒí’ˆ ì¶”ê°€</button>
        </div>

        <!-- í™€ë¦¬ë°¤ í”½ í…Œì´ë¸” -->
        <table class="pick-table" id="pickTable" th:if="${pickList} != null">
          <thead>
          <tr>
            <th width="46%">ìƒí’ˆ ì •ë³´</th>
            <th width="15%">ì •ê°€</th>
            <th width="15%">íŒë§¤ê°€</th>
            <th width="13%">ë“±ë¡ì¼</th>
            <th width="21%">ê´€ë¦¬</th>
          </tr>
          </thead>
          <tbody id="pickTableBody">
          <!-- ìƒ˜í”Œ ë°ì´í„° -->
          <tr th:each="list: ${pickList}">
            <td>
              <div class="product-info">
                <img th:src="${'https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/product/' + list['imageUrl']}" th:alt="${list['productName']}" class="product-image">
                <div class="product-details">
                  <input id="pickCode" type="hidden" th:value="${list['hollybamPickCode']}">
                  <input id="productCode" type="hidden" th:value="${list['productCode']}">
                  <div class="product-name" th:text="${list['productName']}">í™€ë¦¬ë°¤ ë² ìŠ¤íŠ¸ ìƒí’ˆ 1</div>
                  <div class="product-code" th:text="${list['prodctId']}">P001</div>
                </div>
              </div>
            </td>
            <td th:text="${#numbers.formatInteger(list['priceOriginal'], 3, 'COMMA')}+'ì›'">89,000ì›</td>
            <td th:text="${#numbers.formatInteger(list['priceSelling'], 3, 'COMMA')}+'ì›'">79,000ì›</td>
            <td th:text="${#temporals.format(list['pickCreatedAt'], 'yyyy-MM-dd')}">2025-08-19</td>
            <td>
              <div class="action-buttons">
                <button class="btn-delete" onclick="deleteHollybamPick()">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
          </tbody>
        </table>

        <!-- ë¹ˆ ìƒíƒœ (í•„ìš”ì‹œ í‘œì‹œ) -->
        <div class="empty-state" id="emptyState" th:if="${pickList} == null">
          <div class="empty-text">ë“±ë¡ëœ í™€ë¦¬ë°¤ í”½ì´ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="empty-subtext">ì¶”ì²œí•  ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ìƒí’ˆ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addProductModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">í™€ë¦¬ë°¤ í”½ ìƒí’ˆ ì¶”ê°€</h3>
      <div class="modal-search">
        <div class="category-search-container">
          <select class="date-select" id="parentCategorySelect" style="min-width: 130px;">
            <option value="">ìƒìœ„ ì¹´í…Œê³ ë¦¬</option>
            <option th:each="category : ${categories}"
                    th:value="${category.categoryCode}"
                    th:text="${category.categoryName}">
            </option>
          </select>
          <select class="date-select" id="childCategorySelect" style="min-width: 130px;" disabled>
            <option value="">í•˜ìœ„ ì¹´í…Œê³ ë¦¬</option>
          </select>
        </div>
        <input type="text" class="search-input" id="productSearchInput" placeholder="ìƒí’ˆëª… ë˜ëŠ” ìƒí’ˆì½”ë“œë¡œ ê²€ìƒ‰">
        <button class="modal-search-btn" onclick="searchProducts()">ê²€ìƒ‰</button>
      </div>
    </div>
    <div class="modal-body">
      <table class="product-select-table">
        <thead>
        <tr>
          <th width="8%">ì„ íƒ</th>
          <th width="60%">ìƒí’ˆ ì •ë³´</th>
          <th width="32%">ê°€ê²©</th>
        </tr>
        </thead>
        <tbody id="productSelectTableBody">
        <!-- ìƒí’ˆ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </tbody>
      </table>
    </div>
    <div class="modal-footer">
      <button class="btn-delete" onclick="closeAddModal()">ì·¨ì†Œ</button>
      <button class="search-btn" onclick="addSelectedProducts()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const categories = /*[[${categories}]]*/ [];
  const productList = /*[[${productList}]]*/ [];
  /*]]>*/

  console.log('ì „ì²´ ìƒí’ˆ ë°ì´í„°:', productList);
  console.log('ì¹´í…Œê³ ë¦¬ ë°ì´í„°:', categories);
</script>

<script>
  $(document).ready(function() {
    // ğŸ”¥ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");

    // ğŸ”¥ ëª¨ë“  jQuery AJAXì— ìë™ ì ìš©
    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader(header, token);
      }
    });
  });

  // ğŸ”¥ CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  function getCSRFToken() {
    return document.querySelector('meta[name="_csrf"]').getAttribute('content');
  }

  function getCSRFHeader() {
    return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
  }

  document.addEventListener('DOMContentLoaded', function() {
    // ì‚¬ì´ë“œë°” ë©”ë‰´ active ì„¤ì • (ì‚¬ì´ë“œë°”ê°€ ìˆëŠ” ê²½ìš°)
    const hollybamPickLink = document.querySelector('a[href="/admin/hollybam/pick"]');
    if (hollybamPickLink) {
      hollybamPickLink.classList.add('active');

      // ì„œë¸Œë©”ë‰´ ìë™ìœ¼ë¡œ ì—´ê¸°
      const submenu = hollybamPickLink.closest('.submenu');
      if (submenu) {
        submenu.style.display = 'block';

        // ë©”ì¸ ë§í¬ì—ë„ active í‘œì‹œ
        const parentNavLink = submenu.previousElementSibling;
        if (parentNavLink && parentNavLink.classList.contains('has-submenu')) {
          parentNavLink.classList.add('active');
        }
      }
    }

    // ê²€ìƒ‰ì°½ ì—”í„°í‚¤ ì´ë²¤íŠ¸
    document.getElementById('productSearchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchProducts();
      }
    });

    // ìƒìœ„ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ (ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹)
    document.getElementById('parentCategorySelect').addEventListener('change', function() {
      const selectedCategoryCode = this.value;
      const childCategorySelect = document.getElementById('childCategorySelect');

      // ì´ˆê¸°í™”
      childCategorySelect.innerHTML = '<option value="">í•˜ìœ„ ì¹´í…Œê³ ë¦¬</option>';

      if (selectedCategoryCode) {
        const selectedCategory = categories.find(cat => cat.categoryCode === selectedCategoryCode);

        if (selectedCategory?.categoryDetailDto) {
          selectedCategory.categoryDetailDto.forEach(detail => {
            const option = document.createElement('option');
            option.value = detail.cateDetailCode;
            option.textContent = detail.cateDetailName;
            childCategorySelect.appendChild(option);
          });
        }

        childCategorySelect.disabled = false;
        console.log(`${selectedCategoryCode}ì˜ í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ${selectedCategory?.categoryDetailDto?.length || 0}ê°œ ë¡œë“œë¨`);
      } else {
        childCategorySelect.disabled = true;
      }
    });

    // í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸
    document.getElementById('childCategorySelect').addEventListener('change', function() {
      // ìë™ ê²€ìƒ‰ ì œê±° - ì‚¬ìš©ìê°€ ì§ì ‘ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ë„ë¡ ë³€ê²½
    });
  });

  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
  function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      // ì‹¤ì œ êµ¬í˜„ì‹œ AJAXë¡œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
      console.log('ë¡œê·¸ì•„ì›ƒ ìš”ì²­');
      window.location.href = '/admin/login';
    }
  }

  // ëª¨ë‹¬ ì—´ê¸°
  function openAddModal() {
    document.getElementById('addProductModal').style.display = 'block';
    document.body.style.overflow = 'hidden';

    // ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('productSearchInput').value = '';
    document.getElementById('parentCategorySelect').value = '';
    document.getElementById('childCategorySelect').value = '';
    document.getElementById('childCategorySelect').disabled = true;

    // ì „ì²´ ìƒí’ˆ ëª©ë¡ ë°”ë¡œ í‘œì‹œ
    displayProducts(productList);
  }

  // ëª¨ë‹¬ ë‹«ê¸°
  function closeAddModal() {
    document.getElementById('addProductModal').style.display = 'none';
    document.body.style.overflow = 'auto';

    // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });

    // ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('productSearchInput').value = '';
    document.getElementById('parentCategorySelect').value = '';
    document.getElementById('childCategorySelect').value = '';
    document.getElementById('childCategorySelect').disabled = true;

    // ì „ì²´ ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ ì´ˆê¸°í™”
    displayProducts(productList);
  }

  // ìƒí’ˆ ê²€ìƒ‰
  function searchProducts() {
    const searchTerm = document.getElementById('productSearchInput').value.trim();
    const parentCategory = document.getElementById('parentCategorySelect').value;
    const childCategory = document.getElementById('childCategorySelect').value;

    console.log('ìƒí’ˆ ê²€ìƒ‰:', {
      keyword: searchTerm,
      parentCategory: parentCategory,
      childCategory: childCategory
    });

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    const tableBody = document.getElementById('productSelectTableBody');
    tableBody.innerHTML = '<tr><td colspan="3" class="loading"><div class="loading-spinner"></div> ê²€ìƒ‰ ì¤‘...</td></tr>';

    // AJAXë¡œ ì„œë²„ì— ê²€ìƒ‰ ìš”ì²­
    $.ajax({
      url: '/admin/product/pick/search', // ì„œë²„ API ì—”ë“œí¬ì¸íŠ¸
      method: 'POST',
      data: {
        keyword: searchTerm,
        categoryCode: parentCategory,
        cateDetailCode: childCategory
      },
      success: function(response) {
        console.log('ê²€ìƒ‰ ê²°ê³¼:', response);

        // ë¹ˆ ê°ì²´ í•„í„°ë§ í›„ ìœ íš¨í•œ ë°ì´í„°ë§Œ ì¶”ì¶œ
        const validProducts = response.filter(product => {
          return product && Object.keys(product).length > 0 &&
                  (product.productCode || product.productId || product.productName);
        });

        // ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (validProducts && validProducts.length > 0) {
          displayProducts(validProducts);
        } else {
          tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
      },
      error: function(xhr, status, error) {
        console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
        console.error('ì‘ë‹µ ìƒíƒœ:', xhr.status);
        console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', xhr.responseText);

        // ì—ëŸ¬ ë°œìƒ ì‹œ ì „ì²´ ìƒí’ˆ ëª©ë¡ í‘œì‹œ
        displayProducts(productList);
      }
    });
  }

  // ìƒí’ˆ í•„ë“œ ê°’ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (ë‹¤ì–‘í•œ í‚¤ í˜•íƒœ ì§€ì›)
  function getProductField(product, fieldName) {
    // ì¹´ë©œì¼€ì´ìŠ¤ì™€ ìŠ¤ë„¤ì´í¬ì¼€ì´ìŠ¤ ëª¨ë‘ ì§€ì›
    const variations = [
      fieldName,
      fieldName.replace(/([A-Z])/g, '_$1').toLowerCase(),
      fieldName.toLowerCase()
    ];

    for (let variation of variations) {
      if (product[variation] !== undefined && product[variation] !== null) {
        return product[variation];
      }
    }
    return '';
  }

  // ìƒí’ˆ ëª©ë¡ í‘œì‹œ
  function displayProducts(products) {
    const tableBody = document.getElementById('productSelectTableBody');

    if (!products || products.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }

    let results = '';
    products.forEach(product => {
      results += createProductRow(product);
    });

    tableBody.innerHTML = results;
    console.log(`${products.length}ê°œ ìƒí’ˆ í‘œì‹œë¨`);
  }

  // ê²€ìƒ‰ ê²°ê³¼ ë¡œë“œ (ìƒ˜í”Œ ë°ì´í„°)
  function loadSearchResults(keyword, parentCategory, childCategory) {
    const tableBody = document.getElementById('productSelectTableBody');
    $.ajax({
      url: '/admin/product/pick/search',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        cartCode: parseInt(cartCode),
        quantity: newValue
      }),
      success: function(response) {
        alert(response.message);
        if (response.status) {
          // ìƒ˜í”Œ ìƒí’ˆ ë°ì´í„°
          const sampleProducts = [
            {
              productCode: 'P101',
              productId: 'P101',
              productName: 'ì—¬ì„±ìš© í”„ë¦¬ë¯¸ì—„ ìƒí’ˆ A',
              productImage: 'sample1.jpg',
              productOriginal: 150000,
              productSelling: 120000
            },
            {
              productCode: 'P102',
              productId: 'P102',
              productName: 'ë‚¨ì„±ìš© ë² ìŠ¤íŠ¸ ìƒí’ˆ B',
              productImage: 'sample2.jpg',
              productOriginal: 85000,
              productSelling: 75000
            },
            {
              productCode: 'P103',
              productId: 'P103',
              productName: 'ì»¤í”Œìš© ì¸ê¸° ìƒí’ˆ C',
              productImage: 'sample3.jpg',
              productOriginal: 200000,
              productSelling: 180000
            },
            {
              productCode: 'P104',
              productId: 'P104',
              productName: 'ë€ì œë¦¬ ì‹ ìƒí’ˆ D',
              productImage: 'sample4.jpg',
              productOriginal: 95000,
              productSelling: 85000
            }
          ];

          // í‚¤ì›Œë“œ í•„í„°ë§ (ê°„ë‹¨í•œ ìƒ˜í”Œ)
          let filteredProducts = sampleProducts;
          if (keyword) {
            filteredProducts = sampleProducts.filter(product =>
                    product.productName.toLowerCase().includes(keyword.toLowerCase()) ||
                    product.productId.toLowerCase().includes(keyword.toLowerCase())
            );
          }

          let results = '';
          filteredProducts.forEach(product => {
            results += createProductRow(product);
          });

          if (!results) {
            tableBody.innerHTML = '<tr><td colspan="3" class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          } else {
            tableBody.innerHTML = results;
          }
        } else {
          console.log("ê²€ìƒ‰ ì‹¤íŒ¨");
        }
      },
      error: function(err) {
        console.error('ì—…ë¡œë“œ ì‹¤íŒ¨', err);
      }
    });
  }

  // ìƒí’ˆ í–‰ ìƒì„± í•¨ìˆ˜ (ì‹¤ì œ ì„œë²„ ë°ì´í„° ì‚¬ìš©)
  function createProductRow(product) {
    // ë‹¤ì–‘í•œ í•„ë“œëª… í˜•íƒœë¥¼ ì§€ì›í•˜ì—¬ ì•ˆì „í•˜ê²Œ ë°ì´í„° ì¶”ì¶œ
    const productCode = getProductField(product, 'productCode') || getProductField(product, 'productId');
    const productName = getProductField(product, 'productName') || 'ìƒí’ˆëª… ì—†ìŒ';
    const productId = getProductField(product, 'productId') || getProductField(product, 'productCode');
    const priceOriginal = parseInt(getProductField(product, 'priceOriginal')) || 0;
    const priceSelling = parseInt(getProductField(product, 'priceSelling')) || 0;
    const imageUrl = getProductField(product, 'imageUrl') || getProductField(product, 'titleImage');

    // ê°€ê²© í¬ë§·íŒ…
    const formattedOriginalPrice = priceOriginal > 0 ? `${priceOriginal.toLocaleString()}ì›` : '0ì›';
    const formattedSellingPrice = priceSelling > 0 ? `${priceSelling.toLocaleString()}ì›` : '0ì›';

    // ì´ë¯¸ì§€ URL ì²˜ë¦¬
    let imageSource = 'https://via.placeholder.com/60x60?text=No+Image';
    if (imageUrl) {
      // S3 URLì´ ì•„ë‹Œ ê²½ìš° S3 ë² ì´ìŠ¤ URL ì¶”ê°€
      if (imageUrl.startsWith('http')) {
        imageSource = imageUrl;
      } else {
        imageSource = `https://hollybam-static-image.s3.ap-northeast-2.amazonaws.com/product/${imageUrl}`;
      }
    }

    return `
    <tr>
        <td>
            <input type="checkbox" class="product-checkbox" value="${productCode}">
        </td>
        <td>
            <div class="product-info">
                <img src="${imageSource}"
                     alt="${productName}"
                     class="product-image"
                     onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
                <div class="product-details">
                    <div class="product-name">${productName}</div>
                    <div class="product-code">${productId}</div>
                </div>
            </div>
        </td>
        <td>
            <div class="price-info">
                <div class="price-row original-price">
                    <span class="price-label">ì •ê°€</span>
                    <span class="price-value">${formattedOriginalPrice}</span>
                </div>
                <div class="price-row selling-price">
                    <span class="price-label">íŒë§¤ê°€</span>
                    <span class="price-value">${formattedSellingPrice}</span>
                </div>
            </div>
        </td>
    </tr>`;
  }

  // ì„ íƒëœ ìƒí’ˆë“¤ì„ í™€ë¦¬ë°¤ í”½ìœ¼ë¡œ ì¶”ê°€
  function addSelectedProducts() {
    const selectedProducts = [];
    const checkboxes = document.querySelectorAll('.product-checkbox:checked');

    checkboxes.forEach(checkbox => {
      const productCode = checkbox.value;
      selectedProducts.push({
        productCode: productCode
      });
    });

    if (selectedProducts.length === 0) {
      alert('ì¶”ê°€í•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // AJAXë¡œ ì„œë²„ì— ì „ì†¡
    $.ajax({
      url: '/admin/product/pick/add',
      method: 'POST',
      contentType: 'application/json', // JSON í˜•íƒœë¡œ ì „ì†¡
      data: JSON.stringify(selectedProducts), // ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
      success: function(response) {
        console.log('ì¶”ê°€ ì„±ê³µ:', response);
        alert(`${selectedProducts.length}ê°œ ìƒí’ˆì´ í™€ë¦¬ë°¤ í”½ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        closeAddModal();
        location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ëª©ë¡ í‘œì‹œ
      },
      error: function(xhr, status, error) {
        console.error('ì¶”ê°€ ì‹¤íŒ¨:', error);
        console.error('ì‘ë‹µ ìƒíƒœ:', xhr.status);
        console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', xhr.responseText);
        alert('í™€ë¦¬ë°¤ í”½ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  }

  // í™€ë¦¬ë°¤ í”½ ì‚­ì œ
  function deleteHollybamPick() {
    let pickCode = document.getElementById("pickCode").value;
    if (confirm('ì´ í™€ë¦¬ë°¤ í”½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      console.log('í™€ë¦¬ë°¤ í”½ ì‚­ì œ:', pickCode);
      // ì‹¤ì œ êµ¬í˜„ì‹œ AJAXë¡œ ì„œë²„ì— ì „ì†¡
      $.ajax({
        url: '/admin/product/pick/delete',
        method: 'POST',
        contentType: 'application/json', // JSON í˜•íƒœë¡œ ì „ì†¡
        data: JSON.stringify(pickCode), // ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        success: function(response) {
          alert('í™€ë¦¬ë°¤ í”½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ëª©ë¡ í‘œì‹œ
        },
        error: function(xhr, status, error) {
          console.error('ì¶”ê°€ ì‹¤íŒ¨:', error);
          console.error('ì‘ë‹µ ìƒíƒœ:', xhr.status);
          console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', xhr.responseText);
          alert('í™€ë¦¬ë°¤ í”½ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });

      // ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” location.reload() ëŒ€ì‹  ë™ì ìœ¼ë¡œ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      // location.reload();
    }
  }

  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  window.onclick = function(event) {
    const modal = document.getElementById('addProductModal');
    if (event.target === modal) {
      closeAddModal();
    }
  }
</script>
</body>
</html>