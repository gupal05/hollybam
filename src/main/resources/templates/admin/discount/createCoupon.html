<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠폰 생성 - HOLLYBAM</title>

  <!-- 관리자 사이드바 CSS/JS -->
  <link rel="stylesheet" href="/css/adminSidebar.css">
  <script src="/js/adminSidebar.js"></script>

  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    /* 헤더 */
    .header {
      background: #fff;
      border-bottom: 1px solid #e9ecef;
      padding: 0 40px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-info {
      color: #6c757d;
      font-size: 13px;
      font-weight: 300;
    }

    .logout-btn {
      background: #fff;
      color: #212529;
      border: 1px solid #212529;
      padding: 8px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #212529;
      color: #fff;
    }

    /* 컨테이너 */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* 페이지 타이틀 */
    .page-title {
      margin-bottom: 40px;
    }

    .page-title h2 {
      color: #212529;
      font-size: 28px;
      font-weight: 300;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .page-title p {
      color: #6c757d;
      font-size: 14px;
      font-weight: 300;
    }

    /* 섹션 */
    .section {
      background: #fff;
      border: 1px solid #e9ecef;
      margin-bottom: 40px;
      max-width: 600px;
    }

    .section-header {
      padding: 30px 40px;
      border-bottom: 1px solid #e9ecef;
    }

    .section-title {
      color: #212529;
      font-size: 18px;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    .section-body {
      padding: 40px;
    }

    /* 폼 요소들 */
    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      color: #6c757d;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 400;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 15px 20px;
      border: 1px solid #e9ecef;
      font-size: 14px;
      font-weight: 300;
      transition: all 0.3s ease;
      background: #fff;
      color: #212529;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #212529;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .checkbox-group:hover {
      border-color: #212529;
    }

    .checkbox-group.checked {
      background: #fff;
      border-color: #212529;
    }

    .checkbox-group label {
      margin-bottom: 0;
      margin-left: 8px;
      text-transform: none;
      font-size: 14px;
      font-weight: 300;
      cursor: pointer;
    }

    /* 버튼 */
    .btn {
      background: #fff;
      color: #212529;
      border: 1px solid #dee2e6;
      padding: 12px 20px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
    }

    .btn:hover {
      border-color: #212529;
    }

    .btn:active,
    .btn:focus {
      outline: none;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: #212529;
      color: #fff;
      border-color: #212529;
    }

    .btn-primary:hover {
      background: #000;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
      border-color: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    /* 폼 액션 */
    .form-actions {
      background: #f8f9fa;
      padding: 30px 40px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      border-top: 1px solid #e9ecef;
    }

    .help-text {
      color: #6c757d;
      font-size: 12px;
      font-weight: 300;
      margin-top: 8px;
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .header {
        padding: 0 20px;
      }

      .container {
        padding: 20px 15px;
      }

      .section-header,
      .section-body,
      .form-actions {
        padding: 20px;
      }

      .section {
        max-width: none;
      }

      .form-actions {
        flex-direction: column-reverse;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<!-- 사이드바 레이아웃 포함 -->
<div th:replace="~{layout/adminSidebar :: sidebar}"></div>

<!-- 메인 컨텐츠 -->
<div class="main-content">
  <!-- 헤더 -->
  <header class="header">
    <div class="header-actions">
      <div class="admin-info">
        관리자님 환영합니다
      </div>
      <button class="logout-btn" onclick="logout()">
        Sign Out
      </button>
    </div>
  </header>

  <!-- 컨테이너 -->
  <div class="container">
    <!-- 페이지 타이틀 -->
    <div class="page-title">
      <h2>쿠폰 생성</h2>
      <p>고객에게 발급할 쿠폰을 생성합니다</p>
    </div>

    <!-- 쿠폰 생성 폼 -->
    <form th:action="@{/admin/coupon/create}" th:object="${coupon}" method="post">
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">쿠폰 정보 입력</h3>
        </div>
        <div class="section-body">
          <div class="form-group">
            <label for="couponId">쿠폰 아이디 (xxxx-xxxx-xxxx)</label>
            <input type="text" id="couponId" name="couponId"
                   pattern="[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}"
                   title="4자-4자-4자의 영문 또는 숫자 조합" required>
            <div class="help-text">4자-4자-4자의 영문 또는 숫자 조합으로 입력하세요</div>
          </div>

          <div class="form-group">
            <label>쿠폰 이름</label>
            <input type="text" th:field="*{couponName}" placeholder="쿠폰 이름을 입력하세요" required/>
          </div>

          <div class="form-group">
            <label>쿠폰 설명</label>
            <textarea th:field="*{couponDiscription}" placeholder="쿠폰에 대한 상세 설명을 입력하세요" required></textarea>
          </div>

          <div class="form-group">
            <label>할인 유형</label>
            <select th:field="*{discountType}" required>
              <option value="">할인 유형을 선택하세요</option>
              <option value="per">퍼센트 (%) 할인</option>
              <option value="amount">정액 할인</option>
            </select>
          </div>

          <div class="form-group">
            <label>할인 값</label>
            <input type="number" th:field="*{discountValue}" min="0" placeholder="할인 값을 입력하세요" required/>
            <div class="help-text">퍼센트 할인의 경우 1-100, 정액 할인의 경우 원 단위로 입력</div>
          </div>

          <div class="form-group">
            <label>최소 주문 금액</label>
            <input type="number" th:field="*{minOrderPrice}" min="0" value="0" placeholder="최소 주문 금액 (원)"/>
            <div class="help-text">쿠폰 사용을 위한 최소 주문 금액을 설정하세요 (0원인 경우 제한 없음)</div>
          </div>

          <div class="form-group">
            <label>최대 할인 금액</label>
            <input type="number" th:field="*{maxDiscount}" min="0" placeholder="최대 할인 금액 (원)"/>
            <div class="help-text">퍼센트 할인의 경우 최대 할인 금액을 제한할 수 있습니다</div>
          </div>

          <div class="form-group">
            <label>발급 시작일</label>
            <input type="date" th:field="*{issuedAt}"/>
            <div class="help-text">쿠폰 발급을 시작할 날짜를 선택하세요</div>
          </div>

          <div class="form-group">
            <label>만료일</label>
            <input type="date" th:field="*{expiredAt}"/>
            <div class="help-text">쿠폰의 사용 만료일을 선택하세요</div>
          </div>

          <div class="form-group">
            <label>자동 발급 설정</label>
            <div class="checkbox-group" onclick="toggleCheckbox('isAutoIssue')">
              <input type="checkbox" th:field="*{isAutoIssue}" id="isAutoIssue"/>
              <label for="isAutoIssue">자동 발급 여부</label>
            </div>
            <div class="help-text">체크하면 조건에 맞는 고객에게 자동으로 쿠폰이 발급됩니다</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="history.back()">
            취소
          </button>
          <button type="submit" class="btn btn-primary">
            쿠폰 생성
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 사이드바 "쿠폰 생성" 메뉴 active 설정 및 서브메뉴 열기
    const couponCreateLink = document.querySelector('a[href="/admin/coupon/create"]');
    if (couponCreateLink) {
      couponCreateLink.classList.add('active');

      // 할인 관리 서브메뉴 자동으로 열기
      const submenu = couponCreateLink.closest('.submenu');
      if (submenu) {
        submenu.style.display = 'block';

        // 할인 관리 메인 링크에도 active 표시
        const parentNavLink = submenu.previousElementSibling;
        if (parentNavLink && parentNavLink.classList.contains('has-submenu')) {
          parentNavLink.classList.add('active');
        }
      }
    }

    // 체크박스 초기 상태 설정
    const autoIssueCheckbox = document.getElementById('isAutoIssue');
    const checkboxGroup = autoIssueCheckbox.closest('.checkbox-group');
    if (autoIssueCheckbox.checked) {
      checkboxGroup.classList.add('checked');
    }
  });

  // 체크박스 토글
  function toggleCheckbox(checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    const group = checkbox.closest('.checkbox-group');

    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
      group.classList.add('checked');
    } else {
      group.classList.remove('checked');
    }
  }

  // 쿠폰 아이디 자동 포맷팅
  document.getElementById('couponId')?.addEventListener('input', function (e) {
    let value = e.target.value.replace(/[^a-zA-Z0-9]/g, '');
    if (value.length > 12) value = value.slice(0, 12);
    let formatted = value.match(/.{1,4}/g)?.join('-') || '';
    e.target.value = formatted;
  });

  // 날짜 유효성 검사
  document.querySelector('input[name="expiredAt"]')?.addEventListener('change', function() {
    const issuedAt = document.querySelector('input[name="issuedAt"]').value;
    const expiredAt = this.value;

    if (issuedAt && expiredAt && new Date(expiredAt) < new Date(issuedAt)) {
      alert('만료일은 발급 시작일보다 늦어야 합니다.');
      this.value = '';
    }
  });

  // 할인 유형에 따른 도움말 업데이트
  document.querySelector('select[name="discountType"]')?.addEventListener('change', function() {
    const helpText = document.querySelector('input[name="discountValue"]').nextElementSibling;
    if (this.value === 'per') {
      helpText.textContent = '1-100 사이의 퍼센트 값을 입력하세요';
    } else if (this.value === 'amount') {
      helpText.textContent = '할인할 금액을 원 단위로 입력하세요';
    }
  });

  // 로그아웃 처리
  function logout() {
    if (confirm('로그아웃 하시겠습니까?')) {
      fetch('/admin/auth/logout', {
        method: 'POST'
      })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  window.location.href = '/admin/login';
                }
              })
              .catch(error => {
                console.error('로그아웃 오류:', error);
                // 오류가 발생해도 로그인 페이지로 이동
                window.location.href = '/admin/login';
              });
    }
  }
</script>
</body>
</html>