<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 등록 - 관리자</title>

    <!-- 외부 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- 관리자 사이드바 CSS/JS -->
    <link rel="stylesheet" href="/css/adminSidebar.css">
    <script src="/js/adminSidebar.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* 헤더 */
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 0 40px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-info {
            color: #6c757d;
            font-size: 13px;
            font-weight: 300;
        }

        .logout-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #212529;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #212529;
            color: #fff;
        }

        /* 컨테이너 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* 페이지 타이틀 */
        .page-title {
            margin-bottom: 40px;
        }

        .page-title h2 {
            color: #212529;
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .page-title p {
            color: #6c757d;
            font-size: 14px;
            font-weight: 300;
        }

        /* 폼 컨테이너 */
        .form-container {
            background: #fff;
            border: 1px solid #e9ecef;
            margin-bottom: 40px;
        }

        .form-section {
            padding: 40px;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-header {
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .section-title {
            color: #212529;
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        /* 폼 요소들 */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #212529;
        }

        .form-input:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* 파일 업로드 */
        .file-upload {
            position: relative;
            display: block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            border: 1px dashed #dee2e6;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 120px;
        }

        .file-label:hover {
            border-color: #212529;
            background: #fff;
        }

        .file-text {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .file-subtext {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* 가격 관련 */
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .input-group {
            display: flex;
            align-items: stretch;
        }

        .input-addon {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-right: none;
            padding: 15px;
            color: #6c757d;
            font-size: 14px;
            font-weight: 300;
            display: flex;
            align-items: center;
        }

        .input-group .form-input {
            border-left: none;
        }

        /* 라디오 버튼 */
        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border: 1px solid #dee2e6;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-item:hover {
            border-color: #212529;
        }

        .radio-item:has(input:checked) {
            border-color: #212529;
            background: #f8f9fa;
        }

        .radio-input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .radio-label {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
        }

        /* 옵션 관리 */
        .option-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .option-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .option-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 30px;
            position: relative;
        }

        .option-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .option-item-title {
            color: #212529;
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .option-remove-btn {
            background: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 8px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-remove-btn:hover {
            background: #dc3545;
            color: #fff;
        }

        .option-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .option-values-container {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .option-values-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-values-title {
            color: #6c757d;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .add-value-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-value-btn:hover {
            border-color: #212529;
        }

        .option-values-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-value-item {
            display: grid;
            grid-template-columns: 1fr 100px 100px 100px auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: #fff;
            border: 1px solid #dee2e6;
        }

        .option-value-input {
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 13px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .option-value-input:focus {
            outline: none;
            border-color: #212529;
        }

        .remove-value-btn {
            background: #fff;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-value-btn:hover {
            background: #dc3545;
            color: #fff;
        }

        /* 재고 관련 */
        .total-quantity-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-top: 15px;
        }

        .total-quantity-info.auto-calculated {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .quantity-status {
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 8px;
        }

        .quantity-status.manual {
            color: #212529;
        }

        .quantity-status.auto {
            color: #16a34a;
        }

        .quantity-details {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            line-height: 1.4;
        }

        /* 상품 코드 관련 */
        .product-code-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .code-input-container {
            display: flex;
            align-items: stretch;
            gap: 10px;
        }

        .code-input {
            flex: 1;
        }

        .code-generate-btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 15px 25px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .code-generate-btn:hover {
            border-color: #212529;
        }

        .code-format-info {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            padding: 12px;
            background: #f8f9fa;
            border-left: 2px solid #212529;
        }

        .duplicate-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
            font-weight: 300;
            padding: 12px;
        }

        .duplicate-check.success {
            color: #16a34a;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .duplicate-check.error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .duplicate-check.checking {
            color: #d97706;
            background: #fffbeb;
            border: 1px solid #fed7aa;
        }

        /* 파일 관련 */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .selected-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            font-size: 13px;
            font-weight: 300;
        }

        .file-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            transition: background-color 0.2s;
        }

        .file-remove:hover {
            background: #fee2e2;
        }

        /* 버튼 */
        .btn {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
            padding: 15px 30px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn:hover {
            border-color: #212529;
        }

        .btn-primary {
            background: #212529;
            color: #fff;
            border-color: #212529;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-secondary {
            background: #fff;
            color: #212529;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            border-color: #212529;
        }

        /* 폼 액션 */
        .form-actions {
            background: #f8f9fa;
            padding: 40px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-top: 1px solid #e9ecef;
        }

        .help-text {
            color: #6c757d;
            font-size: 12px;
            font-weight: 300;
            margin-top: 8px;
        }

        /* 옵션 원가 관리 관련 스타일 */
        .option-cost-management {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .uniform-cost-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .uniform-cost-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .uniform-cost-label {
            color: #212529;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
        }

        .uniform-cost-input-group {
            display: none;
            margin-top: 15px;
        }

        .uniform-cost-input-group.active {
            display: block;
        }

        .uniform-cost-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .uniform-cost-input {
            width: 200px;
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #fff;
            color: #212529;
            font-size: 14px;
            font-weight: 300;
            transition: all 0.3s ease;
        }

        .uniform-cost-input:focus {
            outline: none;
            border-color: #212529;
        }

        .uniform-cost-apply-btn {
            background: #212529;
            color: #fff;
            border: 1px solid #212529;
            padding: 12px 20px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .uniform-cost-apply-btn:hover {
            background: #000;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
            }

            .container {
                padding: 20px 15px;
            }

            .form-section {
                padding: 25px 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .price-grid {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 15px;
            }

            .form-actions {
                flex-direction: column-reverse;
                padding: 25px 20px;
            }

            .btn {
                width: 100%;
            }

            .code-input-container {
                flex-direction: column;
            }

            .option-value-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .option-header {
                flex-direction: column;
                align-items: stretch;
            }

            .uniform-cost-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .uniform-cost-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- 사이드바 레이아웃 포함 -->
<div th:replace="~{layout/adminSidebar :: sidebar}"></div>

<!-- 메인 컨텐츠 -->
<div class="main-content">
    <!-- 헤더 -->
    <header class="header">
        <div class="header-actions">
            <div class="admin-info">
                관리자님 환영합니다
            </div>
            <button class="logout-btn" onclick="logout()">
                Sign Out
            </button>
        </div>
    </header>

    <!-- 컨테이너 -->
    <div class="container">
        <!-- 페이지 타이틀 -->
        <div class="page-title">
            <h2>상품 등록</h2>
            <p>새로운 상품을 등록합니다</p>
        </div>

        <div class="form-container">
            <form th:action="@{/admin/products}" th:object="${productDto}" method="post" enctype="multipart/form-data">

                <!-- 카테고리 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">카테고리 설정</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="parentCategory">
                                상위 카테고리 <span class="required">*</span>
                            </label>
                            <select class="form-select" id="parentCategory" name="categoryCode" required>
                                <option value="">상위 카테고리를 선택하세요</option>
                                <option th:each="category : ${categories}"
                                        th:value="${category.categoryCode}"
                                        th:text="${category.categoryName}">
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="childCategory">
                                하위 카테고리 <span class="required">*</span>
                            </label>
                            <select class="form-select" id="childCategory" name="cateDetailCode" required>
                                <option value="">하위 카테고리를 선택하세요</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 상품 옵션 관리 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">상품 옵션 관리</h3>
                    </div>

                    <div class="option-container">
                        <div class="option-header">
                            <p class="help-text">상품에 색상, 크기 등의 옵션을 추가할 수 있습니다. 옵션이 없는 경우 건너뛰어도 됩니다.</p>
                            <button type="button" class="btn btn-secondary" id="addOptionBtn">
                                옵션 추가
                            </button>
                        </div>
                        <div class="option-cost-management" id="optionCostManagement" style="display: none;">
                            <div class="uniform-cost-toggle">
                                <input type="checkbox" class="uniform-cost-checkbox" id="uniformCostCheck">
                                <label class="uniform-cost-label" for="uniformCostCheck">
                                    모든 옵션 원가 동일하게 설정
                                </label>
                            </div>

                            <div class="uniform-cost-input-group" id="uniformCostInputGroup">
                                <div class="form-group">
                                    <label class="form-label">
                                        통합 옵션 원가
                                    </label>
                                    <div class="uniform-cost-controls">
                                        <div class="input-group">
                                            <div class="input-addon">₩</div>
                                            <input type="number" class="uniform-cost-input" id="uniformCostInput"
                                                   placeholder="0" min="0">
                                        </div>
                                        <button type="button" class="uniform-cost-apply-btn" id="applyCostBtn">
                                            모든 옵션에 적용
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="optionList" class="option-list">
                            <!-- 동적으로 옵션이 추가될 영역 -->
                        </div>
                    </div>
                </div>

                <!-- 기본 정보 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">기본 정보</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="productCode">
                                상품 코드 <span class="required">*</span>
                            </label>
                            <div class="product-code-group">
                                <div class="code-input-container">
                                    <input type="text" class="form-input code-input" id="productCode"
                                           th:field="*{productId}" placeholder="예: PR-A001, TH-A001" required>
                                    <button type="button" class="code-generate-btn" id="generateCodeBtn">
                                        중복확인
                                    </button>
                                </div>
                                <div class="code-format-info">
                                    <strong>상품 코드 형식:</strong> 카테고리코드-숫자 (예: TA-001, CL-001, AC-001)
                                </div>
                                <div class="duplicate-check" id="duplicateCheck" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="productName">
                                상품 이름 <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="productName"
                                   th:field="*{productName}" placeholder="상품 이름을 입력하세요" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="productQuantity">
                                전체 재고 수량 <span class="required">*</span>
                            </label>
                            <input type="number" class="form-input" id="productQuantity"
                                   th:field="*{productQuantity}" placeholder="0" min="0" required>

                            <!-- 재고 상태 정보 -->
                            <div class="total-quantity-info" id="quantityInfo">
                                <div class="quantity-status manual" id="quantityStatus">수동 입력 모드</div>
                                <div class="quantity-details" id="quantityDetails">
                                    옵션이 없는 상품의 경우 직접 재고 수량을 입력하세요.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label" for="productDescription">
                            상품 설명
                        </label>
                        <textarea class="form-textarea" id="productDescription"
                                  th:field="*{productDescription}" placeholder="상품에 대한 간단한 설명을 입력하세요"></textarea>
                    </div>
                </div>

                <!-- 이미지 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">이미지 관리</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                상품 타이틀 이미지 <span class="required">*</span>
                            </label>
                            <div class="file-upload">
                                <input type="file" class="file-input" name="titleImage" id="titleImage" accept="image/*" required>
                                <div class="file-label">
                                    <div class="file-text">타이틀 이미지 업로드</div>
                                    <div class="file-subtext">JPG, PNG 파일 업로드</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                상품 타이틀 이미지2 (WebP)
                            </label>
                            <div class="file-upload">
                                <input type="file" class="file-input" id="titleImage2" name="titleImage2" accept=".webp">
                                <div class="file-label">
                                    <div class="file-text">WebP 이미지 업로드</div>
                                    <div class="file-subtext">WebP 형식만 지원</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                상품 썸네일 (다중 선택 가능)
                            </label>
                            <div class="file-upload-container">
                                <div class="file-upload">
                                    <input type="file" class="file-input" id="thumbnails" name="thumbnails" accept="image/*" multiple>
                                    <div class="file-label">
                                        <div class="file-text">썸네일 이미지 업로드</div>
                                        <div class="file-subtext">여러 이미지를 동시에 선택할 수 있습니다</div>
                                    </div>
                                </div>
                                <div class="selected-files" id="thumbnailFiles"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                상품 상세 이미지 <span class="required">*</span>
                            </label>
                            <div class="file-upload-container">
                                <div class="file-upload">
                                    <input type="file" class="file-input" id="detailImages" name="detailImages" accept="image/*" multiple required>
                                    <div class="file-label">
                                        <div class="file-text">상세 이미지 업로드</div>
                                        <div class="file-subtext">여러 이미지를 동시에 선택할 수 있습니다</div>
                                    </div>
                                </div>
                                <div class="selected-files" id="detailFiles"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 가격 정보 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">가격 정보</h3>
                    </div>
                    <div class="price-grid">
                        <div class="form-group">
                            <label class="form-label" for="priceOriginal">
                                상품 정가
                            </label>
                            <div class="input-group">
                                <div class="input-addon">₩</div>
                                <input type="number" class="form-input" id="priceOriginal"
                                       name="priceOriginal" placeholder="0" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="priceSelling">
                                상품 판매가 <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <div class="input-addon">₩</div>
                                <input type="number" class="form-input" id="priceSelling"
                                       name="priceSelling" placeholder="0" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="priceCost">
                                상품 원가 <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <div class="input-addon">₩</div>
                                <input type="number" class="form-input" id="priceCost"
                                       name="priceCost" placeholder="0" min="0" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 판매 설정 섹션 -->
                <div class="form-section">
                    <div class="section-header">
                        <h3 class="section-title">판매 설정</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            상품 판매상태 <span class="required">*</span>
                        </label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" class="radio-input" id="productActiveTrue"
                                       th:field="*{productActive}" value="1" required>
                                <label class="radio-label" for="productActiveTrue">판매 가능</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" class="radio-input" id="productActiveFalse"
                                       th:field="*{productActive}" value="0" required>
                                <label class="radio-label" for="productActiveFalse">판매 불가</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 액션 버튼 -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        취소
                    </button>
                    <button type="button" class="btn btn-primary" id="submitBtn">
                        상품 등록
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const categories = /*[[${categories}]]*/ '[]';
    /*]]>*/
</script>

<script>
    // 로그아웃 처리
    function logout() {
        if (confirm('로그아웃 하시겠습니까?')) {
            fetch('/admin/auth/logout', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/admin/login';
                    }
                })
                .catch(error => {
                    console.error('로그아웃 오류:', error);
                    // 오류가 발생해도 로그인 페이지로 이동
                    window.location.href = '/admin/login';
                });
        }
    }

    // 옵션 관리 관련 JavaScript
    let optionCounter = 0;
    let hasOptions = false;

    document.getElementById('productActiveTrue').addEventListener('click', function() {
        this.checked = true;
        document.getElementById('productActiveFalse').checked = false;
    });

    document.getElementById('productActiveFalse').addEventListener('click', function() {
        this.checked = true;
        document.getElementById('productActiveTrue').checked = false;
    });

    $(document).ready(function() {
        // 카테고리 선택
        $('#parentCategory').on('change', function() {
            const selectedCategoryCode = $(this).val();
            const $childCategorySelect = $('#childCategory');

            // 초기화
            $childCategorySelect.html('<option value="">하위 카테고리를 선택하세요</option>');

            if (selectedCategoryCode) {
                const selectedCategory = categories.find(cat => cat.categoryCode === selectedCategoryCode);

                if (selectedCategory?.categoryDetailDto) {
                    selectedCategory.categoryDetailDto.forEach(detail => {
                        const option = `<option value="${detail.cateDetailCode}">${detail.cateDetailName}</option>`;
                        $childCategorySelect.append(option);
                    });
                }
            }
        });

        // 파일 관리를 위한 전역 변수
        let thumbnailFiles = [];
        let detailFiles = [];

        // 파일 업로드 시 파일명 표시
        $('.file-input').on('change', function() {
            const $label = $(this).next();
            const files = Array.from(this.files);
            const inputName = $(this).attr('name');

            if (files.length > 0) {
                if (inputName === 'thumbnails') {
                    // 기존 파일에 새 파일들 추가
                    files.forEach(file => {
                        if (!thumbnailFiles.some(f => f.name === file.name && f.size === file.size)) {
                            thumbnailFiles.push(file);
                        }
                    });
                    updateFileDisplay('thumbnailFiles', thumbnailFiles, 'thumbnails');
                    updateFileInput(this, thumbnailFiles);

                } else if (inputName === 'detailImages') {
                    // 기존 파일에 새 파일들 추가
                    files.forEach(file => {
                        if (!detailFiles.some(f => f.name === file.name && f.size === file.size)) {
                            detailFiles.push(file);
                        }
                    });
                    updateFileDisplay('detailFiles', detailFiles, 'detailImages');
                    updateFileInput(this, detailFiles);

                } else {
                    // 기존 단일 파일 처리
                    if (files.length === 1) {
                        $label.find('.file-text').text(files[0].name);
                    }
                    $label.css({
                        'border-color': '#212529',
                        'background': '#fff'
                    });
                }
            }
        });

        // 파일 표시 업데이트 함수
        function updateFileDisplay(containerId, fileArray, inputName) {
            const $container = $('#' + containerId);
            $container.empty();

            fileArray.forEach((file, index) => {
                const fileItem =
                    '<div class="file-item">' +
                    '<span>' + file.name + '</span>' +
                    '<button type="button" class="file-remove" onclick="removeFile(\'' + inputName + '\', ' + index + ')">' +
                    '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">' +
                    '<path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' +
                    '</svg>' +
                    '</button>' +
                    '</div>';
                $container.append(fileItem);
            });
        }

        // 파일 제거 함수
        window.removeFile = function(inputName, index) {
            if (inputName === 'thumbnails') {
                thumbnailFiles.splice(index, 1);
                updateFileDisplay('thumbnailFiles', thumbnailFiles, 'thumbnails');
                updateFileInput($('input[name="thumbnails"]')[0], thumbnailFiles);
            } else if (inputName === 'detailImages') {
                detailFiles.splice(index, 1);
                updateFileDisplay('detailFiles', detailFiles, 'detailImages');
                updateFileInput($('input[name="detailImages"]')[0], detailFiles);
            }
        };

        // File input 업데이트 함수
        function updateFileInput(input, fileArray) {
            const dt = new DataTransfer();
            fileArray.forEach(file => dt.items.add(file));
            input.files = dt.files;

            // 레이블 업데이트
            const $label = $(input).next();
            if (fileArray.length > 0) {
                $label.find('.file-text').text(`${fileArray.length}개 파일 선택됨`);
                $label.css({
                    'border-color': '#212529',
                    'background': '#fff'
                });
            } else {
                const originalText = {
                    'thumbnails': '썸네일 이미지 업로드',
                    'detailImages': '상세 이미지 업로드'
                };
                $label.find('.file-text').text(originalText[$(input).attr('name')]);
                $label.css({
                    'border-color': '#dee2e6',
                    'background': '#f8f9fa'
                });
            }
        }

        // 상품 등록 버튼 클릭 이벤트
        $('#submitBtn').on('click', function() {
            // 옵션 데이터 수집
            const optionData = collectOptionData();

            let image = {
                titleImage: $('#titleImage')[0].files[0],
                titleImage2: $('#titleImage2')[0].files[0],
                thumbnails: $('#thumbnails')[0].files,
                detailImages: $('#detailImages')[0].files
            };

            let formData = new FormData();
            formData.append('titleImage', image.titleImage);
            formData.append('titleImage2', image.titleImage2);
            for(let i=0; i<image.thumbnails.length; i++) {
                formData.append('thumbnails[]', image.thumbnails[i]);
            }
            for(let i=0; i<image.detailImages.length; i++) {
                formData.append('detailImages[]', image.detailImages[i]);
            }

            $.ajax({
                url: '/admin/upload/images',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if(response.status) {
                        let formData = new FormData();

                        // productDto
                        let productDto = {
                            productId: $('#productCode').val(),
                            productName: $('#productName').val(),
                            productQuantity: $('#productQuantity').val(),
                            productDescription: $('#productDescription').val(),
                            productActive: document.querySelector('input[name="productActive"]:checked').value
                        };

                        // price
                        let price = {
                            priceCost: $('#priceCost').val(),
                            priceOriginal: $('#priceOriginal').val(),
                            priceSelling: $('#priceSelling').val()
                        };

                        // category
                        let category = {
                            categoryCode: $('#parentCategory').val()
                        };
                        let cateDetail = {
                            cateDetailCode : $('#childCategory').val()
                        };

                        // Add the JSON objects to FormData
                        formData.append('productDto', JSON.stringify(productDto));
                        formData.append('price', JSON.stringify(price));
                        formData.append('category', JSON.stringify(category));
                        formData.append('cateDetailCode', JSON.stringify(cateDetail));

                        // 옵션 데이터 추가
                        formData.append('productOptions', JSON.stringify(optionData));

                        // Add images (if any)
                        let image = {
                            titleImage: $('#titleImage')[0].files[0],
                            titleImage2: $('#titleImage2')[0].files[0],
                            thumbnails: $('#thumbnails')[0].files,
                            detailImages: $('#detailImages')[0].files
                        };

                        if (image.titleImage) formData.append('titleImage', image.titleImage);
                        // titleImage2는 null일 수 있음 → 항상 key는 넣고, 없으면 빈 Blob
                        formData.append('titleImage2', image.titleImage2 || new Blob());
                        if (image.thumbnails.length > 0) {
                            for (let i = 0; i < image.thumbnails.length; i++) {
                                formData.append('thumbnails[]', image.thumbnails[i]);
                            }
                        } else {
                            // thumbnails[] 키 보장 (빈 Blob 또는 빈 파일)
                            formData.append('thumbnails[]', new Blob());
                        }
                        for (let i = 0; i < image.detailImages.length; i++) {
                            formData.append('detailImages[]', image.detailImages[i]);
                        }

                        $.ajax({
                            url: '/admin/upload/product',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                alert(response.message);
                                if (response.status) {
                                    window.location.href="/admin/add/product";
                                } else {
                                    // 폼 초기화
                                    $('#childCategory').val('');
                                    $('#parentCategory').val('');
                                    $('#productCode').val('');
                                    $('#productName').val('');
                                    $('#productQuantity').val('');
                                    $('#productDescription').val('');
                                    $('#titleImage').val('');
                                    $('#titleImage2').val('');
                                    $('#thumbnails').val('');
                                    $('#detailImages').val('');
                                    $('#priceCost').val('');
                                    $('#priceOriginal').val('');
                                    $('#priceSelling').val('');
                                    // 옵션 초기화
                                    $('#optionList').empty();
                                    optionCounter = 0;
                                }
                            },
                            error: function(err) {
                                console.error('업로드 실패', err);
                            }
                        });
                    }
                },
                error: function(err) {
                    console.error('업로드 실패', err);
                }
            });
        });

        $('#generateCodeBtn').on('click', function () {
            const code = $('#productCode').val();

            if (!code) {
                $('#duplicateCheck')
                    .text('상품 코드를 입력해주세요.')
                    .css({ color: 'red', display: 'block' });
                return;
            }

            $.ajax({
                url: '/admin/upload/is-product-code',
                type: 'POST',
                data: { productCode: code },
                success: function (response) {
                    if (response === false || response === 'false') {
                        $('#duplicateCheck')
                            .text('사용 가능한 상품코드입니다.')
                            .css({ color: 'green', display: 'block' });
                    } else {
                        $('#duplicateCheck')
                            .text('중복된 상품코드입니다.')
                            .css({ color: 'red', display: 'block' });
                    }
                },
                error: function (err) {
                    console.error('조회 실패:', err);
                    $('#duplicateCheck')
                        .text('서버 오류가 발생했습니다.')
                        .css({ color: 'red', display: 'block' });
                }
            });
        });

        // 재고 수량 관리 초기화
        updateQuantityMode();

        // 통합 원가 체크박스 토글
        $('#uniformCostCheck').on('change', function() {
            const $inputGroup = $('#uniformCostInputGroup');

            if ($(this).is(':checked')) {
                $inputGroup.addClass('active');
            } else {
                $inputGroup.removeClass('active');
                $('#uniformCostInput').val('');
                // 체크 해제 시 모든 옵션 원가 필드를 수동 입력 가능하게 만들기
                $('.option-cost').prop('readonly', false).css('background', '#fff');
            }
        });

        // 통합 원가 적용 버튼 클릭
        $('#applyCostBtn').on('click', function() {
            const uniformCost = $('#uniformCostInput').val();

            if (!uniformCost || uniformCost <= 0) {
                alert('올바른 원가를 입력해주세요.');
                return;
            }

            // 모든 옵션의 원가 필드에 동일한 값 적용
            $('.option-cost').val(uniformCost);

            alert('모든 옵션에 원가가 적용되었습니다.');
        });

        // 통합 원가 입력창에서 엔터키 처리
        $('#uniformCostInput').on('keypress', function(e) {
            if (e.which === 13) {
                $('#applyCostBtn').click();
            }
        });
    });

    // 옵션 추가 버튼 클릭 이벤트
    $('#addOptionBtn').on('click', function() {
        addOption();
    });

    // 옵션 추가 함수
    function addOption() {
        optionCounter++;
        const optionHtml =
            '<div class="option-item" data-option-index="' + optionCounter + '">' +
            '<div class="option-item-header">' +
            '<h4 class="option-item-title">옵션 ' + optionCounter + '</h4>' +
            '<button type="button" class="option-remove-btn" onclick="removeOption(' + optionCounter + ')">' +
            '제거' +
            '</button>' +
            '</div>' +
            '<div class="option-fields">' +
            '<div class="form-group">' +
            '<label class="form-label">' +
            '옵션명 <span class="required">*</span>' +
            '</label>' +
            '<input type="text" class="form-input option-name" placeholder="예: 색상, 크기, 재질" required>' +
            '</div>' +
            '</div>' +
            '<div class="option-values-container">' +
            '<div class="option-values-header">' +
            '<span class="option-values-title">옵션값 설정</span>' +
            '<button type="button" class="add-value-btn" onclick="addOptionValue(' + optionCounter + ')">' +
            '값 추가' +
            '</button>' +
            '</div>' +
            '<div class="option-values-list" id="optionValues-' + optionCounter + '">' +
            '<!-- 옵션값들이 동적으로 추가될 영역 -->' +
            '</div>' +
            '</div>' +
            '</div>';

        $('#optionList').append(optionHtml);

        // 첫 번째 옵션값 자동 추가
        addOptionValue(optionCounter);

        // 재고 관리 모드 업데이트
        updateQuantityMode();
    }

    // 옵션 제거 함수
    function removeOption(optionIndex) {
        $('.option-item[data-option-index="' + optionIndex + '"]').remove();
        updateQuantityMode();
    }

    // 옵션값 추가 함수
    function addOptionValue(optionIndex) {
        const uniformCost = $('#uniformCostCheck').is(':checked') ? $('#uniformCostInput').val() || '' : '';

        const valueHtml =
            '<div class="option-value-item">' +
            '<input type="text" class="option-value-input option-value" ' +
            'placeholder="옵션값 (예: 빨강, Large)">' +
            '<input type="number" class="option-value-input option-price" ' +
            'placeholder="추가금액" min="0">' +
            '<input type="number" class="option-value-input option-cost" ' +
            'placeholder="원가" min="0" value="' + uniformCost + '">' +
            '<input type="number" class="option-value-input option-quantity" ' +
            'placeholder="재고" min="0" onchange="updateTotalQuantity()">' +
            '<button type="button" class="remove-value-btn" onclick="removeOptionValue(this)">' +
            '제거' +
            '</button>' +
            '</div>';

        $('#optionValues-' + optionIndex).append(valueHtml);
    }

    // 옵션값 제거 함수
    function removeOptionValue(button) {
        $(button).closest('.option-value-item').remove();
        updateTotalQuantity();
    }

    // 재고 관리 모드 업데이트
    function updateQuantityMode() {
        const hasOptionsNow = $('.option-item').length > 0;
        const $quantityInput = $('#productQuantity');
        const $quantityInfo = $('#quantityInfo');
        const $quantityStatus = $('#quantityStatus');
        const $quantityDetails = $('#quantityDetails');
        const $costInput = $('#priceCost');
        const $optionCostManagement = $('#optionCostManagement');

        if (hasOptionsNow) {
            // 옵션이 있는 경우: readonly 모드
            $quantityInput.prop('readonly', true);
            $costInput.prop('readonly', true).css('background', '#f8f9fa');
            $optionCostManagement.show();

            $quantityInfo.removeClass('total-quantity-info').addClass('total-quantity-info auto-calculated');
            $quantityStatus.removeClass('manual').addClass('auto').text('자동 계산 모드');
            $quantityDetails.text('옵션별 재고 수량의 합계가 자동으로 계산됩니다.');

            // 현재 총 재고 계산
            updateTotalQuantity();
        } else {
            // 옵션이 없는 경우: 수동 입력 모드
            $quantityInput.prop('readonly', false);
            $costInput.prop('readonly', false).css('background', '#fff');
            $optionCostManagement.hide();

            $quantityInfo.removeClass('auto-calculated').addClass('total-quantity-info');
            $quantityStatus.removeClass('auto').addClass('manual').text('수동 입력 모드');
            $quantityDetails.text('옵션이 없는 상품의 경우 직접 재고 수량을 입력하세요.');

            // 입력값 초기화 (옵션에서 수동으로 변경될 때)
            if (hasOptions && !hasOptionsNow) {
                $quantityInput.val('');
            }
        }

        hasOptions = hasOptionsNow;
    }

    // 총 재고 수량 계산 및 업데이트
    function updateTotalQuantity() {
        if (!$('#productQuantity').prop('readonly')) return;

        let totalQuantity = 0;
        let optionCount = 0;

        $('.option-quantity').each(function() {
            const quantity = parseInt($(this).val()) || 0;
            totalQuantity += quantity;
            if (quantity > 0) optionCount++;
        });

        $('#productQuantity').val(totalQuantity);

        // 상세 정보 업데이트
        const $quantityDetails = $('#quantityDetails');
        if (optionCount > 0) {
            $quantityDetails.text('총 ' + optionCount + '개 옵션의 재고 합계: ' + totalQuantity + '개');
        } else {
            $quantityDetails.text('옵션별 재고 수량을 입력하면 자동으로 계산됩니다.');
        }
    }

    // 옵션 데이터 수집 함수
    function collectOptionData() {
        const options = [];

        $('.option-item').each(function() {
            const $optionItem = $(this);
            const optionName = $optionItem.find('.option-name').val().trim();

            if (optionName) {
                const optionValues = [];

                $optionItem.find('.option-value-item').each(function() {
                    const $valueItem = $(this);
                    const value = $valueItem.find('.option-value').val().trim();
                    const price = parseInt($valueItem.find('.option-price').val()) || 0;
                    const cost = parseInt($valueItem.find('.option-cost').val()) || 0;
                    const quantity = parseInt($valueItem.find('.option-quantity').val()) || 0;

                    if (value) {
                        optionValues.push({
                            optionValue: value,
                            optionPrice: price,
                            optionCost: cost,
                            optionQuantity: quantity
                        });
                    }
                });

                if (optionValues.length > 0) {
                    options.push({
                        optionName: optionName,
                        values: optionValues
                    });
                }
            }
        });

        return options;
    }
</script>
</body>
</html>